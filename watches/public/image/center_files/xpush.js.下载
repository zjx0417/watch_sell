
/* @file xpush.js
 * @date 2018.09.12 19:11:34 
 */
!function(e){function s(){for(var s=e.flashserver.xpushim.split(";"),a="",u=0;u<s.length;u++)if(i){if(s[u].indexOf("wss")>-1){a=s[u];break}}else if(s[u].indexOf("ws")>-1){a=s[u];break}math=p.exec(a),math&&math.length||(math=a.replace(/(wss?|tcp):\/\//gi,",$1,").replace(/:(\d+)/gi,",$1").replace(/\//gi,",").split(",")),r="wss:"===math[1],t=math[2],o=Number(math[3]),n=math[4]||"NEWIM"}var t="",n="NEWIM",a=(e.flashserver.xpushthirdpush,parseInt(e.flashserver.xpushpolltimeout||"15",10)||15),i=1==e.flashserver.usehttps||"https:"===e.protocol,o=8088,r=!1,p=/(wss?:)\/\/(.*?):(\d+)\/(\w+)/gi;e.xpush=function(){},e.xpush.debug=!1;var u=function(s,t,n){var a=h(s),i=new e.MQTT.Message(a);return i.destinationName=t,i.qos=n,i},h=function(s){return window.JSON?JSON.stringify(s):e.JSON.toJSONString(s)},c=function(s){if(!window.JSON)return e.JSON.parseJSON(s);try{return JSON.parse(s)}catch(t){try{return e.JSON.parseJSON(s)}catch(e){return{}}}},l=function(s){e.xpush.debug&&(window.console&&console.log?console.log(s):e.Log(s,1))},d=function(e){var s={};if(e&&(e=c(e)),e.contents&&e.numbers)for(var t in e.contents)s[t]={unreadMessageCount:e.numbers[t],lastMessage:e.contents[t][0]};return s};e.xpushcallback=function(s){if(s&&(e.xpush.unreadMessageInfo=d(s)),l(h(e.xpush.unreadMessageInfo)),e.global.callbacks.ReceiveOfflineMessage)try{e.global.callbacks.ReceiveOfflineMessage(e.xpush.unreadMessageInfo)}catch(s){l("客户尚未实现ReceiveOfflineMessage接口，或实现内部报错"),e.xpush.UI.show(e.xpush.unreadMessageInfo)}else e.xpush.UI.show(e.xpush.unreadMessageInfo)},e.xpush.startXpush=function(){var s=this,t=function(){e.xpushcallback(c(xdr.responseText).message)},n=function(){xdr=new XDomainRequest,xdr&&(xdr.onload=t,xdr.onerror=t,xdr.open("get",e.protocolFilter(e.flashserver.xpushthirdpush+"/poll?userid="+NTKF.user.id+"&clientid="+s.clientid+"&devicetype=webhttp&ts="+(new Date).getTime()))),xdr.send()};requestXpushInterval=setInterval(n,1e3*a),n()},e.xpush.stopXpush=function(){clearInterval(requestXpushInterval),requestXpushInterval=null},e.xpush.init=function(){try{s()}catch(e){return}var a=this,i="JS_"+e.randomChar(20).toLowerCase();if(this.clearSettingUnReadMsgCount=function(s){var t=a.unreadMessageInfo;t&&t[s]&&(t[s].unreadMessageCount=0,t[s].lastMessage="",e.browser.oldmsie?(xdr=new XDomainRequest,xdr&&xdr.open("get",e.protocolFilter(e.flashserver.xpushthirdpush+"/badge?userid="+NTKF.user.id+"&settingid="+s+"&ts="+(new Date).getTime())),xdr.send(),a.stopXpush()):a.connect.send(new u({method:"clearSettingUnReadMsgCount",params:[,e.user.id,s]},a.peertopic,1)),e.xpushcallback())},e.xpush.UI.init(),e.browser.oldmsie||!e.browser.supportMqtt)return this.clientid=i,void this.startXpush();this.connect=new e.MQTT.Client(t,o,i),this.connect.onConnectionLost=function(e){l(h(e))},this.connect.onMessageArrived=function(s){var t=c(s.payloadString);"responseServer"===t.method?(l("接收到xpush的responseServer"),l("peertopic: "+t.params[0]),l("mywilltopic: "+t.params[1]),l("myapptopic: "+t.params[2]),a.peertopic=t.params[0],a.connect.subscribe(t.params[1],{onSuccess:function(){l("成功订阅xpush业务层遗言topic")},onFailure:function(){}}),a.connect.subscribe(t.params[2],{onSuccess:function(){l("成功订阅xpush业务层接收消息topic"),l("发送roomConnect"),a.connect.send(new u({method:"roomConnect",params:[e.user.id,i,0,0,"webmqtt"]},a.peertopic))},onFailure:function(){}}),setInterval(function(){a.connect.send(new u({method:"remoteKeepAlive",params:[i,e.user.id]},a.peertopic,0)),l("发送KeepAlive")},18e4)):"LoginResult"===t.method?(l("接收到登录结果消息："+t.params[0]),""===t.params[4]?l("没有离线消息"):e.xpushcallback(t.params[4])):"remoteNotifyUnReadMessage"===t.method&&e.xpushcallback(t.params[1])};var p=new u({},"S/WILL/a",1),d={userName:"ntguest",password:"xiaoneng123",useSSL:r,timeout:6,keepAliveInterval:180,cleanSession:!1,willMessage:p,mqttVersion:4,onSuccess:function(){l("连接MQTT服务成功"),a.connect.subscribe("C/"+i,{onSuccess:function(s){l("订阅业务层成功"),a.connect.send(new u({method:"requestServer",params:[e.user.id,i,e.global.settingid,"",""]},"S/ROUTE/"+n,0))},onFailure:function(e){l("订阅业务层失败")}})},onFailure:function(e){l("连接MQTT服务失败")}};this.connect.connect(d)},e.xpush.UI={settingids:[],init:function(){var s=this;this.xpushContainer=e({tag:"div",className:"nTalk-xpush-container",style:e.STYLE_BODY+"width:300px;height:100px;position:fixed;right:0;bottom:0;display:none;z-index:100000001;"}).appendTo(!0),this.xpushMessageWrapper=e({tag:"ul",className:"nTalk-xpush-message-wrapper",style:e.STYLE_BODY+"margin:30px 100px 0 0;max-width:230px;"}).appendTo(this.xpushContainer),this.xpushMessageCount=e({tag:"span",className:"nTalk-xpush-message-count",style:e.STYLE_BODY+"position:absolute;color:#4C97EA;top:8px;right:4px;width:22px;height:22px;text-align:center;line-height:22px;font-size:18px;z-index:100000001"}).appendTo(this.xpushContainer),this.xpushMessageCountBkg=e({tag:"img",src:e.sourceURI+"images/messageCountBkg.png",className:"nTalk-xpush-message-count-bkg",style:e.STYLE_NBODY+"float:right;position:absolute;left:210px;top:5px;z-index:100000000;cursor:pointer"}).appendTo(this.xpushContainer),this.xpushMessage=e({tag:"li",className:"nTalk-xpush-message",style:e.STYLE_BODY+'color: white;min-width:60px;position:absolute;bottom:45px;right:100px;font-family: "微软雅黑";font-size: 14px;background: #3786EB;border-radius: 5px;display: inline;float: right;padding-left: 6px;padding-right: 2px;font-weight: 100;padding-top: 7px;padding-bottom: 7px;word-break:break-all;list-style:none'}).appendTo(this.xpushMessageWrapper),this.xpushMessageAngel=e({tag:"div",className:"nTalk-xpush-message-angel",style:e.STYLE_BODY+" display: block;position: absolute;left: 170px;top: 2px;margin:30px;height:0px;width:0px;border-left:solid 5px #3786EB;border-top:solid 5px rgba(0,0,0,0); border-bottom:solid 5px rgba(0,0,0,0); "}).appendTo(this.xpushMessageWrapper),this.xpushMessageCountBkg.bind("click",function(){for(var e=0,t=s.settingids.length;e<t;e++)NTKF.im_openInPageChat(s.settingids[e]);setTimeout(function(){s.hide(),s.settingids=[]},200)})},show:function(e){var s=0,t="";for(var n in e)s+=e[n].unreadMessageCount,t=e[n].lastMessage,this.settingids.push(n);0!=s&&(this.xpushContainer.display(1),this.xpushMessage.html(t),this.xpushMessageCount.html(s))},hide:function(){this.xpushContainer.display(0)}}}(nTalk);