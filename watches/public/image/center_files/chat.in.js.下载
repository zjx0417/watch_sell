(function($, undefined){
	/* @file custom view
	 * @release date 2018.09.13 09:41:02 
	 */
	$.themesURI = 'https://assist.wbiao.com/record/mcenters/themes/wx_1000/images/';
})(nTalk);
!function(t,e){var o=function(){},a="javascript:void();",n=t.Class.create();n.prototype={name:"myScroll",mainBox:null,contentBox:null,scrollBar:null,_wheelFlag:0,_wheelData:-1,timeID:null,options:null,initialize:function(e,i,o,s){this.mainBox=e.talkVersion?e:t(e),this.contentBox=i.talkVersion?i:t(i),this.options=t.extend({width:0},s),this.mainBox.length&&this.contentBox.length&&(this._createScroll(o),this.resizeScroll(),this._tragScroll(),this._wheelChange(),this._clickScroll())},scrollBottom:function(){var t=this;this.mainBox.length&&this.contentBox.length&&(clearTimeout(this.timeID),this.timeID=setTimeout(function(){t.resizeScroll(),t.mainBox.scrollTop(t.mainBox.scrollHeight()),t.scrollBox.css("top",Math.floor(t.mainBox.offset().top-t.scrollBox.offset().top)+"px"),t.scrollBar.css("top",t.scrollBox.height()-t.scrollBar.height()+"px"),t._wheelFlag=12*(t.mainBox.height()-t.scrollBar.height())},50))},_createScroll:function(e){return this.mainBox.css("overflow-y","hidden"),this.scrollBox=t({className:"view-scrollBox",style:t.STYLE_NBODY+"display:block;background:#f9f9f9;"}).appendTo(this.mainBox),this.scrollBar=t({className:e,style:t.STYLE_NBODY+"background:#d8d8d8;border-radius:3px;position:absolute;width:6px;top:0;"}).appendTo(this.scrollBox),t({tag:"span",style:t.STYLE_NBODY}).appendTo(this.scrollBar),this.scrollBar},resizeScroll:function(){var t=this.mainBox.width(),e=(parseInt(this.mainBox.css("border-left-width"))||0)+(parseInt(this.mainBox.css("border-right-width"))||0),i=parseInt(this.contentBox.css("margin-left"))+parseInt(this.contentBox.css("margin-right")),o=this.mainBox.height()-10-e,s=this.scrollBar.width()||6;this.scrollBox.css({position:"absolute",background:"#f9f9f9",width:this.scrollBar.width()+"px",height:this.mainBox.height()+"px",left:t-s-e+"px",top:"0px"}),this.contentBox.css({width:Math.max(this.options.width,t-s-i)+"px"});var a=Math.max(this.contentBox.height(),this.mainBox.height()),n=parseInt(o*(o/a))||300;n>=this.mainBox.height()?this.scrollBox.display():this.scrollBox.display(1),this.scrollBar.css("height",n+"px")},_tragScroll:function(){var e=this;this.scrollBar.bind("mousedown",function(i){function o(i){var o=t.Event.fixEvent(i).clientY-n+a;o>s-e.scrollBar.height()&&(o=s-e.scrollBar.height()),o<=0&&(o=0);var l=o*(e.contentBox.height()/e.mainBox.height());e.mainBox.scrollTop(l),e.scrollBox.css("top",Math.floor(l)+"px"),e.scrollBar.css("top",o+"px"),e._wheelData=o}i=t.Event.fixEvent(i);var s=e.mainBox.height(),a=e.scrollBar.offset().top-e.scrollBox.offset().top,n=i.clientY;t(document).bind("mousemove",o),t(document).bind("mouseup",function(e){t(document).removeEvent("mousemove",o)})}).hover(function(e){t(this).css("background","#a6a6a6")},function(e){t(this).css("background","#d8d8d8")})},_wheelChange:function(){var t=this,e=0;this._mouseWheel(this.mainBox,function(i){t._wheelFlag+=i,t._wheelData>=0?(e=t._wheelData,t.scrollBar.css("top",e+"px"),t._wheelFlag=12*t._wheelData,t._wheelData=-1):e=t._wheelFlag/12,e<=0&&(e=0,t._wheelFlag=0),e>=t.mainBox.height()-t.scrollBar.height()&&(e=t.mainBox.height()-t.scrollBar.height(),t._wheelFlag=12*(t.mainBox.height()-t.scrollBar.height()));var o=e*(t.contentBox.height()/t.mainBox.height());t.mainBox.scrollTop(o),t.scrollBox.css("top",Math.floor(o)+"px"),t.scrollBar.css("top",e+"px")})},_clickScroll:function(){var e=this;this.scrollBox.click(function(i){i=t.Event.fixEvent(i);var o=i.clientY+t(window).scrollTop()-e.mainBox.offset().top-e.scrollBar.height()/2;if(o<=0&&(o=0),o>=e.mainBox.height()-e.scrollBar.height()&&(o=e.mainBox.height()-e.scrollBar.height()),i.target!=e.scrollBar){var s=o*(e.contentBox.height()/e.mainBox.height());e.mainBox.scrollTop(s),e.scrollBox.css("top",Math.floor(s)+"px"),e.scrollBar.css("top",o+"px"),e._wheelData=o}})},_mouseWheel:function(e,i){function o(e){return e=t.Event.fixEvent(e),e.wheelDelta?e.wheelDelta:40*e.detail}e.bind("mousewheel",function(t){var e=-o(t);i(e),document.all?window.event.returnValue=!1:t.preventDefault()}).bind("DOMMouseScroll",function(t){var e=o(t);i(e),t.preventDefault()})}};var l=t.Class.create();l.prototype={name:"chatView",contains:null,loadElement:null,chatElement:null,messageElement:null,displayiFrame:null,chatHistory:null,objFile:null,objImage:null,_tempHeader:null,_chatsHeader:null,_chatsElement:null,_maxNumber:50,_sendKey:"Enter",_editorStart:0,_initFace:!1,_eventFunction:o,scroll:null,_listenNumber:0,_listenTimeID:null,_inputTimerID:null,buttonSelectors:null,imageHash:{},evalRepeatClick:!0,mode:null,options:null,siteid:"",settingid:"",isRobotSuggest:!0,initialize:function(e,i){return this.options=e,this.siteid=this.options.siteid,this.settingid=this.options.settingid,this.mode=i,this.buttonSelectors={face:"chat-view-face",image:"chat-view-image",file:"chat-view-file",history:"chat-view-history",loadhistory:"chat-view-load-history",evaluate:"chat-view-evaluate",capture:"chat-view-capture",capoptions:"chat-view-capture-options",csr:"chat-view-change-csr",manual:"chat-view-switch-manual",submit:"chat-view-submit",exp:"chat-view-exp",xiaonengver:"chat-view-xiaoneng-version"},this.mode?(this.scroll=null,void this._create()):void t.Log("mode is null",3)},_create:function(){this.contains=t({className:"chat-view-contains",key:this.settingid,style:t.STYLE_NBODY+"overflow:hidden;width:100%;height:auto;position:relative;left:0;top:0;padding-top:1px solid #fff\\0;"}).appendTo(this.options.chatContainter),this.loadElement=t({className:"chat-view-load",style:t.STYLE_BODY+"height:"+this.options.height+"px;_height:"+(this.options.height-240)+"px;box-sizing:border-box;display:block;"}).appendTo(this.contains).html(this._getViewHtml("load")),this.chatElement=t({className:"chat-view-window",style:t.STYLE_BODY+"width:100%;height:auto;display:none;padding-top:1px solid #fff\\0;"}).appendTo(this.contains).html(this._getViewHtml("window")),this.messageElement=t({className:"chat-view-message",style:t.STYLE_BODY+"height:"+this.options.height+"px;display:none;float:left;width:100%;"}).appendTo(this.contains).html(this._getViewHtml("message")),this.displayiFrame=t({tag:"iframe",id:"chat-view-submit-iframe",name:"chat-view-submit-iframe",className:"chat-view-submit-iframe",style:t.STYLE_NBODY+"display:none;"}).appendTo(this.contains),this.contains.append(this._getViewHtml("alert")),this.chatHistory=this.chatElement.find(".chat-view-window-history"),this._tempHeader=this.options.chatHeader.find(".chat-header-icon,.chat-header-name,.chat-header-sign,.ntalk-button-maxresize,.ntalk-button-min,.ntalk-button-close"),this.options.chatHeader.find(".ntalk-button-maxresize,.ntalk-button-min,.ntalk-button-close").css("margin","35px 10px 0 0"),this.options.chatHeader.find(".header-chatrecord-title").length||t({className:"header-chatrecord-title",style:t.STYLE_BODY+"font-weight:bold;float:left;margin:15px 10px 5px 20px;height:20px;visibility:visible;overflow:hidden;display:none;color:#ffffff;"}).appendTo(this.options.chatHeader.find(".chat-header-body")).html(t.lang.button_view),this.options.chatHeader.find(".header-chatrecord-close").length||t({className:"header-chatrecord-close",style:t.STYLE_NBODY+"float:right;cursor:pointer;margin:20px 5px 0 0;width:20px;height:20px;position:relative;display:none;"}).appendTo(this.options.chatHeader),this._chatsHeader=this.options.chatHeader.find(".header-chatrecord-title,.header-chatrecord-close"),this._chatsElement=this.chatElement.find(".chat-view-float-history"),this._bind(),this.callChatResize(this.options.width,this.options.height)},close:function(){this.contains.remove(),this.contains=null,t.isFunction(this._eventFunction)&&t(document.body).removeEvent("click",this._eventFunction)},minimize:function(){this.contains.css({width:(t.browser.msie&&t.browser.ieversion<=7?1:0)+"px",height:(t.browser.msie&&t.browser.ieversion<=7?1:0)+"px"})},maximize:function(){this.contains.css({width:"100%",height:"auto"})},switchUI:function(t){if(this.contains)switch(t){case this.mode.CON_VIEW_WINDOW:this.contains.find(".chat-view-load,.chat-view-message").display(),this.contains.find(".chat-view-window").display(1),this.scroll||(this.scroll=new n(this.chatHistory,this.chatHistory.find("ul"),"chat-view-scrollBar",{width:411}));break;case this.mode.CON_VIEW_MESSAGE:this.contains.find(".chat-view-load,.chat-view-window").display(),this.contains.find(".chat-view-message").display(1),this._viewHistory(!1),this._stopListen();break;case this.mode.CON_VIEW_ERROR:this.contains.find(".chat-view-window,.chat-view-message").display(),this.contains.find(".chat-view-load").display(1),this.contains.find(".chat-view-load-icon, .chat-view-load-info").display(),this.contains.find(".chat-view-load-error").display(1).find("span");break;default:this.contains.find(".chat-view-window,.chat-view-message").display(),this.contains.find(".chat-view-load").display(1),this.contains.find(".chat-view-load-error").display(),this.contains.find(".chat-view-load-icon, .chat-view-load-info").display(1)}},showMessage:function(e,i){var o,s,a,n,l,r,h=this,d=1;for(s=[t.STYLE_NBODY+'background:transparent;list-style:none outside none;display:block;padding:5px 46px 0 0;font-family: "Microsoft YaHei";',t.STYLE_NBODY+'background:transparent;list-style:none outside none;display:block;padding:5px 0 0 39px;text-align:right;font-family: "Microsoft YaHei";',t.STYLE_NBODY+'background:transparent;list-style:none outside none;display:block;padding:5px 10px 0 10px;text-align:center;font-family: "Microsoft YaHei";'];this.chatHistory.find("li[class]").length>=this._maxNumber;)this.chatHistory.find("li[class]").first().remove();switch(e){case"left":a=s[0],n=i.msgid;break;case"bottom":a=s[0],n="systembottom";break;case"right":a=s[1],n=i.msgid;break;case"goods":a=s[2],n="first";break;case"system":a=s[2],n="system";break;case"system0":a=s[2],n="system0";break;case"info":a=s[2],n=i.msgid;break;case"otherinfo":a=s[0],n=i.msgid;break;default:a=s[2],n="first"}if(this.chatHistory.find("li."+n).length&&"system"!=n)"systembottom"==n&&this.chatHistory.find("li."+n).css("visibility","visible"),o=this.chatHistory.find("li."+n).html(this._getMessageHtml(e,this._contentFilter(i)));else if(i){if("system"!==n&&"system0"!==n||this.chatHistory.find("li."+n).remove(),"first"===n&&this.chatHistory.find("ul li").length>1)l=this.chatHistory.find("li").eq(0);else if(r=this.chatHistory.find("li").eq(0-d),r.indexOfClass("first"))l=null;else{if(r.indexOfClass("systembottom")&&(d++,l=r,r=this.chatHistory.find("li").eq(0-d)),"system"===n&&this.mode.enterUserId){for(;r&&r.attr("userid")==this.mode.enterUserId&&!(d>=5);)d++,l=r,r=this.chatHistory.find("li").eq(0-d);this.mode.enterUserId=""}for(;r&&!r.indexOfClass("first")&&!r.indexOfClass("system")&&r.attr("localtime")&&d<=this.chatHistory.find("li").length&&parseFloat(r.attr("localtime"))>=i.localtime&&!(d>=5);)d++,l=r,r=this.chatHistory.find("li").eq(0-d)}try{o=t({tag:"li",className:n,localtime:i.localtime,userid:i.userid||"",style:a,history:i.history||"0"}).appendTo(this.chatHistory.find("ul"),l),o.insert(this._getMessageHtml(e,this._contentFilter(i))),"systembottom"==n&&o.find("table td.view-history-content").css("width","60px"),o.find("a").css("color","#c25050"),i.msgid.indexOf("welcome")>-1&&o.find("a").css("font-weight","bold")}catch(c){t.Log(c,3)}i.xnlink&&setTimeout(function(){var e=o.find(".robotQuestion");e.click(function(e){var e=t.Event.fixEvent(e);return e.preventDefault(),e.stopPropagation(),nTalk.chatManage.get(this.settingid).send(t(this).html().replace(/[[0-9]*]\s/,"")),!1})},200),"system"!=n&&o.find("a").click(function(){if(!this.onclick){var e=t(this).attr("_href")||t(this).attr("href");return t(this).attr("_href",e).attr("target","_self").attr("href","###"),"function"==typeof window.openURLToBrowser?(window.openURLToBrowser(e),!1):(window.open(e),!1)}}),1==i.type&&"left"==e&&this.chatHistory.find("li.systembottom").css("visibility","hidden")}else this.chatHistory.find("li."+n).remove();return"systembottom"==n&&(clearTimeout(this._inputTimerID),this._inputTimerID=null,this._inputTimerID=setTimeout(function(){h.chatHistory.find("li.systembottom").css("visibility","hidden")},3e3)),this.scroll&&this.scroll.scrollBottom(),i&&1==i.type&&this.loadLinkContainer(i.msgid),i&&/^(1|2|4|6|9|13|8)$/i.test(i.type)&&this.updateMessage(i.msgid,i.type,i,"left"===e),1==t(".welcome").length&&t(".welcome").css("visibility","hidden").css("visibility","visible"),n},removeMessage:function(t){this.chatHistory.find("."+t).remove()},updateMessage:function(e,i,o,s){var n,l=this,r=this.chatHistory.find("."+e).last(),h=r.find(".view-history-body").last();switch(r.find(".view-history-more").bind("click",function(){h.css({height:"auto","overflow-y":"visible","max-height":"none"}),l.scroll&&l.scroll.resizeScroll(),t(this).display()}),i+""){case"1":"string"==typeof o?this._showResend(e,o).click(function(i){t.Event.fixEvent(i).stopPropagation(),t(this).parent().parent().display(),l.mode.resend(e)}):h.find(".ntalk-preview").length&&h.find(".ntalk-preview").each(function(i){var o=this,s=t(o).attr("sourceurl"),a="#image";t(o).attr("robotImg")&&(a="#robotImg#image"),t.require(s+a,function(i){if(i.error)t(o).display();else{var s=t.zoom(i,332,500);t(o).attr({width:s.width,height:s.height,src:i.src}).click(function(t){l._fullScreenImage(this,e)}).css({width:s.width+"px",height:s.height+"px",cursor:"pointer"})}l.scroll&&l.scroll.scrollBottom&&l.scroll.scrollBottom()})});break;case"13":var d,c=[],p=o.msg.item||o.msg.items||{};if(!p||t.isEmptyObject(p))return;p.url=p.url||a,p.name&&c.push('<a href="',p.url,'" target="_blank" style="'+t.STYLE_BODY+'color:#0479D9;font-weight:bold;">'+p.name+"</a>"),t.each(p,function(e,i){t.isArray(i)?(i[1]=(e.indexOf("price")>-1&&p.currency&&(i[1]+"").indexOf(p.currency)<=-1?p.currency:"")+""+i[1],c.push('<div style="'+t.STYLE_BODY+'"><span style="'+t.STYLE_BODY+'">'+i[0]+(/zh_cn|zh_tw/i.test(t.lang.language)?"&#65306;":":")+"</span>"+i[1]+"</div>"),t.Log(i[0]+": "+i[1])):t.isObject(i)?(i.v=(e.indexOf("price")>-1&&p.currency&&(i.v+"").indexOf(p.currency)<=-1?p.currency:"")+""+i.v,c.push('<div style="'+t.STYLE_BODY+'"><span style="'+t.STYLE_BODY+'">'+i.k+(/zh_cn|zh_tw/i.test(t.lang.language)?"&#65306;":":")+"</span>"+i.v+"</div>"),t.Log(i.k+": "+i.v)):t.lang.goodsinfo[e]&&(i=(e.indexOf("price")>-1&&p.currency&&(i+"").indexOf(p.currency)<=-1?p.currency:"")+i,c.push('<div style="'+t.STYLE_BODY+'"><span style="'+t.STYLE_BODY+'">'+t.lang.goodsinfo[e]+(/zh_cn|zh_tw/i.test(t.lang.language)?"&#65306;":":")+" </span>"+i+"</div>"),t.Log(t.lang.goodsinfo[e]+""+i))}),p.imageurl&&t.require(p.imageurl+"#image",function(e){e.error?l.chatHistory.find(".view-history-goods-image").html(""):(d=t.zoom(e,75,75),l.chatHistory.find(".view-history-goods-image").html('<a href="'+p.url+'" target="_blank" style="'+t.STYLE_BODY+'"><img src="'+p.imageurl+'" width="'+d.width+'" height="'+d.height+'" style="'+t.STYLE_NBODY+"display:inline;width:"+d.width+"px;height:"+d.height+'px;" /></a>')),l.scroll&&l.scroll.scrollBottom()}),l.scroll&&l.scroll.scrollBottom(),this.chatHistory.find(".view-history-goods-info").html(c.join(""));break;case"8":var c=[],g=o.url,f=navigator.userAgent.toLowerCase();o.from&&1==o.from&&(t.browser.msie&&9===t.browser.ieversion||f.indexOf("firefox")>-1)?(c.push(['<video class="ntalker-for-miya-video" style="width:240px;transform:rotate(90deg);-ms-transform:rotate(90deg);margin-left:-30px;margin-top:30px;height:180px"  loop>','<source src="'+g+'" type="video/mp4">',"</video>",'<span class="ntkf-video-button" style="display:block;width:52px;height:52px;background:url('+t.button+') center no-repeat;background-size:100%;position:absolute;top:50%;left:0;right:0;margin:-26px auto 0;"></span>'].join("")),h.css({width:"180px",height:"240px"})):t.browser.msie&&t.browser.ieversion<9?c.push(["<span>",t.lang.cant_play_video,"</span>"].join("")):(c.push(['<video class="ntalker-for-miya-video" style="width:100%;height:100%;"  loop>','<source src="'+g+'" type="video/mp4">',"</video>",'<span class="ntkf-video-button" style="display:block;width:52px;height:52px;background:url('+t.button+') center no-repeat;background-size:100%;position:absolute;top:50%;left:0;right:0;margin:-26px auto 0;"></span>'].join("")),h.css({width:"137px"})),h.parent().css({padding:"3px"}),h.css({"line-height":"0",padding:"0",position:"relative"}).html(c),t(".ntkf-video-button").click(function(e){e.stopPropagation(),t(this).css("display","none"),t(this).parent().find("video").get(0).play()}),t(".view-history-body").click(function(e){e.stopPropagation(),t(this).find("video").get(0).pause(),t(this).find(".ntkf-video-button").css("display","block")});break;case"2":case"4":2==o.type&&1==o.emotion?(t.require(o.sourceurl+"#image",function(e){if(e.error)t.Log("emotion file failure.",3),o.msgid&&l.removeMessage(o.msgid);else{var i=t.zoom(e,100,85);h.css({background:"none",cursor:"auto",height:i.height+"px"}).html('<img src="'+o.sourceurl+'" sourceurl="'+o.sourceurl+'" width="'+i.width+'" height="'+i.height+'" style="'+t.STYLE_NBODY+"width:"+i.width+"px;height:"+i.height+'px;vertical-align:middle;" />')}l.scroll&&l.scroll.scrollBottom()}),l.scroll&&l.scroll.scrollBottom()):"UPLOADING"==o.status?(r.find("table").css("width","138px"),n=2==i?"-98px -145px":"0 -245px",h.css({width:"100px",height:"85px",background:"url("+t.imageicon+") no-repeat "+n})):t.isNumeric(o)&&o>0&&o<=100?r.find(".view-history-progress").display(1).find(".view-history-upload-progress").css("width",o+"%"):o<0||o.error?(2==i?(r.find("table").css("width","138px"),n=2==i?"0 -145px":"-98px -245px",h.css({width:"100px",height:"85px",background:"url("+t.imageicon+") no-repeat "+n}),o==-1?this._transCancel(e):this._showFailure(e)):this._showFileUpload(r,h,{name:"",size:"",error:s},-1),r.find(".view-history-progress").display()):t.isObject(o)&&o.url&&(2==i?t.require(o.url+"#rnd#image",function(i){var s;if(i.error)t.Log("upload file failure.",3),r.find("table").css("width","120px"),h.css({width:"100px",background:"url("+t.imageicon+") no-repeat 0 -145px"});else{var a='<img src="'+o.url+'" sourceurl="'+o.sourceurl+'" width="'+i.width+'" height="'+i.height+'" style="vertical-align:middle;'+t.STYLE_NBODY+"width:"+i.width+"px;height:"+i.height+'px;max-width:220px;max-height:160px;" />',n=i.width,d=i.height;i.width<138?(n=138,i.height<100?(d=100,s=t.browser.Quirks||6!=t.browser.ieversion&&7!=t.browser.ieversion?d:i.height,a='<div style="width:138px;height:'+s+"px;padding:"+(100-i.height)/2+'px 0;box-sizing:border-box;text-align:center;background:white;border-radius:5px;max-width:220px;max-height:160px">'+a+"</div>"):a='<div style="width:138px;height:'+i.height+'px;text-align:center;background:white;border-radius:5px;max-width:220px;max-height:160px">'+a+"</div>"):i.height<100&&(d=100,s=t.browser.Quirks||6!=t.browser.ieversion&&7!=t.browser.ieversion?d:i.height,a='<div style="height:'+s+"px;width:"+i.width+"px;padding:"+(100-i.height)/2+'px 0;box-sizing:border-box;text-align:center;background:white;border-radius:5px;max-width:220px;max-height:160px">'+a+"</div>"),r.find("table").css("width",(n<220?n:220)+26+"px"),t.Log("upload file(width:"+i.width+", height:"+i.height+") success:"+o.url),h.css({background:"none",cursor:"pointer",width:n<220?n+"px":"220px",height:d<160?d+"px":"160px","max-width":"220px","max-height":"160px"}).html(a).find("img").click(function(t){l._fullScreenImage(this,e)});var c=r.attr("userid"),p=t.base.checkID(c)<=1;p&&c?h.parent().css({padding:"2px",border:"1px solid #e2e2e2"}):h.parent().css({padding:"2px",border:"1px solid #78bde9"});var g=r.find(".view-history-angle");g.css("margin-top","15px"),g.parent().css("vertical-align","top"),l.imageHash[e]=1,"function"!=typeof webInfoChanged&&h.bind("mouseenter",function(e){var i=['<div class="mouse-enter-download" style="',t.STYLE_BODY,'position:absolute;bottom:0px;width:100%;height:30px;line-height:30px;text-align:right;background:#000;color:white;left:0px">',t.lang.news_download,"&nbsp;&nbsp;</div>"].join("");t(this).css("position","relative"),t(this).append(i),t(this).find(".mouse-enter-download").css("opacity",.5),t(this).find(".mouse-enter-download").click(function(e){t.Event.fixEvent(e).stopPropagation(),l.displayiFrame.attr("src",o.sourceurl||o.url)})}).bind("mouseleave",function(e){t(this).css("position","static"),t(this).find(".mouse-enter-download").remove()})}l.scroll&&l.scroll.scrollBottom()}):this._showFileUpload(r,h,o,1),r.find(".view-history-progress").display());break;case"6":new t.Music(e,o.url,"audio/mpeg",o.duration||o.length,this.audioView,this.audioBindEvent,this.contains);break;case"9":break;default:h.html(o)}},loadLinkContainer:function(e){var i=this,o=this.chatHistory.find("."+e).last().find(".view-history-body").find(".ntalk-link-contains");o.length&&o.each(function(e,o){var s=t(o).attr("data-source"),a=t(o).attr("class");if(s)try{i.mode.loadLink(s,"."+a.replace(/ntalk\-link\-contains\s+/gi,""))}catch(n){}})},viewLinkContainer:function(e,i){var o,s=this,a=t(i);if("string"==typeof e)try{e=t.JSON.parseJSON(e)}catch(n){}a.css({margin:"5px","border-radius":"5px",border:"1px solid #CCC","background-color":"#FAFAFA",width:"300px"}),o=t({className:"link-image",style:t.STYLE_BODY+"margin:10px;background-color:#fff;width:77px;height:77px;overflow:hidden;float:left;display:inline-block;"}).appendTo(a),container=t({className:"link-container",style:t.STYLE_BODY+"overflow:hidden;zoom:1;"}).appendTo(a),t({className:"link-title",style:t.STYLE_BODY+"margin:10px 0 0 0;width:100%;height:24px;white-space:nowrap;text-overflow:ellipsis;-o-text-overflow:ellipsis;overflow:hidden;"}).appendTo(container).html(['<a href="',e.url,'" target="_blank">',e.title,"</a>"].join("")),t({className:"link-desc",style:t.STYLE_BODY+"margin:5px 0 10px 0;width:100%;max-height:60px;overflow:hidden;"}).appendTo(container).html(t.enCut(e.description,96,1)+"&nbsp;"),t({className:"link-customer",style:t.STYLE_BODY+"margin:5px 0 10px 0;width:100%;max-height:60px;overflow:hidden;"+("kf_9739"==nTalk.global.siteid||"kf_3004"==nTalk.global.siteid?"color:#f00;":"")}).appendTo(container).html(e.customer),t({className:"link-clear",style:t.STYLE_BODY+"clear:both;"}).appendTo(a),o.css("margin",(a.height()-o.height())/2+"px 10px"),t.require(e.imageurl+"#image",function(i){var a=t.zoom(i,75,75),n=(75-a.height)/2+"px "+(75-a.width)/2+"px";o.html(['<img src="',e.imageurl,'" style="',t.STYLE_NBODY,"margin:"+n+";width:"+a.width+"px;height:"+a.height+'px;"/>'].join("")),s.scroll&&s.scroll.scrollBottom()})},scrollBottom:function(){},suggest:function(e,i){var o=this,s=this.chatElement.find(".chat-view-hidden-area .chat-view-suggest-list");return s.find("ul li").remove(),0===e.length?void s.css("display","none"):(t.each(e,function(e,a){var n=a.replace(o.textEditor.val(),"<span style='color:#ff6f40'>"+o.textEditor.val()+"</span>"),l=t({tag:"LI",talk_index:e,className:"",style:t.STYLE_BODY+"padding:0 0 0 20px;list-style:none;line-height:28px;height:28px;overflow:hidden;cursor:pointer;"}).appendTo(s.find("ul")).html(n).hover(function(e){t(this).css({color:"#fff","background-color":"#4297e0"})},function(e){t(this).css({color:"#000","background-color":"#fafafa"})}).click(function(e){t.Event.fixEvent(e).stopPropagation();var n=parseFloat(t(this).attr("talk_index"))+1;o.mode.send({msg:i?a:n,botindex:"index"}),o.textEditor.val(""),setTimeout(function(){s.css("display","none")},200)});i&&t(l).attr("robotmsg",a)}),void s.css({display:"block",top:"auto",bottom:"0px"}))},_selectSuggest:function(e){var i=this.chatElement.find(".chat-view-suggest-list li"),o=0;i.each(function(){t(this).attr("talk_selected")&&(o=t(this).attr("talk_index")),t(this).attr("talk_selected","").css({color:"#000","background-color":"#fafafa"})}),o=parseFloat(o)+e,o=o<0?i.length-1:o,o=o>=i.length?o-i.length:o,t.Log("set selected index:"+o),i.eq(o).attr("talk_selected","1").css({color:"#fff","background-color":"#4297e0"}),this.isRobotSuggest=!1,this.textEditor.val(i.eq(o).attr("robotmsg")?i.eq(o).attr("robotmsg"):parseFloat(o)+1)},displayStatusInfo:function(e,i){var o=this.chatElement.find(".chat-view-window-status-info");i&&o.html(i),e?o.display(1):o.hide(function(){t(this).css({display:"none",opacity:1})})},showInputState:function(i){if(!this._inputStateTimeID||i!==e){i=i?i:-22;var o=this,s=this.chatHistory.find(".view-history-body-wait");s.html(t.lang.system_printing||"").css({position:"relative",width:7*t.enLength(t.clearHtml(t.lang.system_printing||""))+"px",left:"10px","font-size":"12px","line-height":"20px"}),t({tag:"span",style:"display:block; left: -24px; top:-20px; position:relative; width:20px; height:20px; background: url("+t.sourceURI+"images/mobileicon.png) -110px -70px no-repeat"}).appendTo(s),t({id:"show-input-status-loading",tag:"span",style:"display:block; left: -14px; top:-38px; position:relative; width:20px; height:20px"}).html(this.loadingPoint?this.loadingPoint:"...").appendTo(s);var a=3;this._inputStatusLoadingInter||(this._inputStatusLoadingInter=setInterval(function(){o.loadingPoint="",a--;for(var e=0;e<a;e++)o.loadingPoint+=".";t("#show-input-status-loading").html(o.loadingPoint),a==-1&&(a=4)},1e3)),this._inputStateTimeID=setTimeout(function(){return s.length?(i=i<=-52?-22:i-10,s.css("background-position",i+"px -250px"),void o.showInputState(i)):(clearTimeout(o._inputStateTimeID),clearInterval(o._inputStatusLoadingInter),void(o._inputStateTimeID=null))},500)}},_showResend:function(e,i){return this.chatHistory.find("."+e).last().find(".view-history-status").display(1),this.chatHistory.find("."+e).last().find(".view-history-status-icon").display(1),this.chatHistory.find("."+e).last().find(".view-history-status-link").html(t.utils.handleLinks(i||t.lang.news_send_failure)).find("a")},_showCancel:function(e,i){return this.chatHistory.find("."+e).last().find(".view-history-status").display(1),this.chatHistory.find("."+e).last().find(".view-history-status-icon").display(),this.chatHistory.find("."+e).last().find(".view-history-status-link").html('<span style="'+t.STYLE_BODY+'cursor:pointer;color:#005ffb;text-decoration:none;">'+(t.lang.news_cancel_trans||"")+"</span>").find("span")},_showDownload:function(e,i,o){var s,a=4==o.type&&o.oldfile?o.oldfile:"";return s=i?['<span class="chat-view-download-link" style="'+t.STYLE_BODY+'float:left;line-height:26px;margin:0 5px;cursor:pointer;color:#005ffb;text-decoration:none;">'+t.lang.news_download+"</span>",a?'<span style="'+t.STYLE_BODY+'float:left;line-height:26px;text-decoration:none;display:block;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;max-width:100px;" title="'+a+'">'+this._toFileName(a)+"</span>":""].join(""):[a?'<span style="'+t.STYLE_BODY+'float:left;line-height:26px;text-decoration:none;display:block;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;max-width:100px;" title="'+a+'">'+this._toFileName(a)+"</span>":"",'<span class="chat-view-download-link" style="'+t.STYLE_BODY+'float:left;line-height:26px;margin:0 5px;cursor:pointer;color:#005ffb;text-decoration:none;">'+t.lang.news_download+"</span>"].join(""),this.chatHistory.find("."+e).last().find(".view-history-status").display(1),this.chatHistory.find("."+e).last().find(".view-history-status-icon").display(),this.chatHistory.find("."+e).last().find(".view-history-status-link").html(s).find(".chat-view-download-link")},_toFileName:function(e){return e=e||"",t.enLength(e)<16?e:t.enCut(e,10)+".."+e.substr(e.length-4,4)},_showFailure:function(e){return this.chatHistory.find("."+e).last().find(".view-history-status").display(1),this.chatHistory.find("."+e).last().find(".view-history-status-icon").display(1),this.chatHistory.find("."+e).last().find(".view-history-status-link").html(t.lang.news_trans_failure)},_transCancel:function(e){return this.chatHistory.find("."+e).last().find(".view-history-status").display(1),this.chatHistory.find("."+e).last().find(".view-history-status-icon").display(1),this.chatHistory.find("."+e).last().find(".view-history-status-link").html(t.lang.news_trans_cancel)},_showFileUpload:function(e,i,o,s){var a=this;e.find("table").css("width","293px"),e.find("table").css("height","104px"),i.css("height","104px");var n,l,r,h,d,c=265,p=[104,76,28],g="none",f=[11,78],u=[8,-44],x=270,m=[110,80,30],v="1px solid #e2e2e2",w=[13,80],b=[10,-42],y=e.attr("userid"),_=t.base.checkID(y)<=1;_&&y?(n=x,l=m,r=v,h=w,d=b):(n=c,l=p,r=g,h=f,d=u);var k="",E="",T=o.oldfile||this.uploadFileName,Y=o.oldfile||this.uploadFileName,S=this.uploadFileSize?(this.uploadFileSize/1024).toFixed(2):o.size?parseInt(o.size.replace("KB","")):"",B=/\.[^\.]+$/,D=Y.toLowerCase().match(B),O=[".jpg",".jpeg",".png",".gif",".bmp",".pjpeg"],L=[".doc",".docx"],C=[".mp3"],N=[".txt"];t.inArray(D[0],O)>-1?(k=o.url||"''",E=' width=50 height=50 style="border: 1px solid #d4d4d4;border-radius:5px;margin:2px"'):k=t.inArray(D[0],C)>-1?t.sourceURI+"images/filetype/mp3.png":t.inArray(D[0],L)>-1?t.sourceURI+"images/filetype/doc.png":t.inArray(D[0],N)>-1?t.sourceURI+"images/filetype/txt.png":t.sourceURI+"images/filetype/zip.png",Y.length>12&&(Y=Y.substr(0,4)+"..."+Y.substr(Y.length-6,Y.length)),S?S>1024?S="("+(S/1024).toFixed(2)+" MB)":S<1024&&(S="("+S+" KB)"):S="";var z=1==s,F=_&&y?" display:none ":"",I=z?" -287px -96px ":" -159px -37px ",M=z?t.lang.news_trans_success:t.lang.news_trans_failure,H=z?t.lang.news_download:"",A=['<div class="view-fileupload-body" style="',t.STYLE_BODY,"position:relative;width:",n,"px;height:",l[0],"px;border-radius:5px;background:#FFF;border:",r,'">','<div class="view-fileupload-body-top" style="',t.STYLE_BODY,"width:",n,"px;height:",l[1],'px;border-bottom:1px solid #e2e2e2">','<div class="view-fileupload-type-icon" style="',t.STYLE_BODY,"position:relative;width:54px;height:54px;top:",d[0],"px;left:",h[0],'px"><img src=',k+E," /></div>",'<div class="view-fileupload-content" style="',t.STYLE_BODY,"position:relative;width:170px;height:54px;top:",d[1],"px;left:",h[1],'px;text-align:left">','<span class="view-fileupload-title" title=',T,' style="',t.STYLE_BODY,'cursor:pointer;color:#333333;font-size:12px;font-weight:bold;">',Y,"</span>",'<span class="view-fileupload-size" style="',t.STYLE_BODY,'color:#666666;font-size:12px">',S,"</span>",'<div class="view-fileupload-status" style="',t.STYLE_BODY+F,'position:relative;top:5px;left:-2px;color:#333333;font-size:12px">',M,"</div>",'<div class="view-fileupload-status-icon" style="',t.STYLE_BODY+F,"position:relative;width:20px;height:20px;top:-2px;left:-25px;background:url(",t.imageicon,") no-repeat ",I,'"></div>',"</div>","</div>",'<div class="view-fileupload-body-bottom" style="',t.STYLE_BODY,"position:relative;width:",n,"px;height:",l[2],'px">','<div class="view-fileupload-download" style="',t.STYLE_BODY,"width:auto;height:",l[2],"px;line-height:",l[2],'px;font-size:12px;color:#0681D7;text-align:right;margin-right:35px;cursor:pointer">',H,"</div>","</div>","</div>"].join("");i.append(A),_&&y?i.parent().css({padding:"0px",border:"none"}):i.parent().css({padding:"2px",border:"1px solid #78bde9"});var R=e.find(".view-history-angle");R.css("margin-top","15px"),R.parent().css("vertical-align","top"),e.find(".view-history-status-link").last().display(0),e.find(".view-history-status").last().display(0),z||(o.error.maxSize?o.error.error=t.utils.handleLinks(t.lang.news_trans_failure_size,{maxsize:o.error.maxSize/1048576}):o.error.ext&&(o.error.error=t.utils.handleLinks(t.lang.news_trans_failure_type,{type:o.error.ext})),a.showMessage("system",{type:9,msg:'<span style="display:inline-block;width:20px;height:20px;position:relative;top:5px;background: url('+t.imageicon+") no-repeat "+I+'"></span>'+o.error.error})),i.find(".view-fileupload-download").click(function(e){t.Event.fixEvent(e).stopPropagation(),z&&("function"==typeof openURLToBrowser?openURLToBrowser(o.sourceurl||o.url):a.displayiFrame.attr("src",o.sourceurl||o.url))})},_getPositionForTextArea:function(t){var e=0;if(document.selection){t.focus();var i=document.selection.createRange(),o=i.duplicate();try{o.moveToElementText(t)}catch(s){}for(e=-1;o.inRange(i);)o.moveStart("character"),e++}else(t.selectionStart||"0"==t.selectionStart)&&(e=t.selectionStart);
return e},_setCursorPosition:function(t,e){if(this._editorStart=e,t.setSelectionRange)t.focus(),t.setSelectionRange(e,e);else if(t.createTextRange){var i=t.createTextRange();i.collapse(!0),i.moveEnd("character",e),i.moveStart("character",e),i.select()}},_insertText:function(e){var i=this.textEditor.get(0),o=i.value==t.lang.default_textarea_text?"":i.value,s=Math.min(o.length,this._editorStart);s=s<0?o.length:s,i.value=o.substr(0,s)+e+o.substr(s,o.length),t.browser.mobile||(this._setCursorPosition(i,s+e.length),i.focus())},createEvaluation:function(e,i,o,s,a){var n,l=this,r=['<div class="ntkf-alert-close" style="'+t.STYLE_NBODY+"cursor:pointer;height:20px;position:absolute;right:5px;top:9px;width:20px;background:url("+t.imageicon+') no-repeat scroll -60px -61px;-moz-border-radius:0px;-webkit-border-radius:0px;border-radius:0px;"></div>','<table border="0" cellpadding="0" cellspacing="0" style="'+t.STYLE_NBODY+'margin:0px 0 10px 0;width:100%;table-layout:auto;border-collapse:separate;">','<tbody style="',t.STYLE_NBODY,'">','<tr style="',t.STYLE_NBODY,'">','<td class="chat-view-evaluation-title" colspan="2" style="',t.STYLE_BODY,'text-align:center;height:39px;color:#fff;">','<span style="',t.STYLE_BODY,'color:#000;font-weight:bold;font-size:14px;vertical-align:middle;">'+i+"</span>","</td></tr>",t.FORM.createInput(e),'<tr style="',t.STYLE_NBODY,'">','<td colspan="2" style="',t.STYLE_BODY,'padding:5px 0;text-align:center;color:#333;">','<input type="button" class="view-alert-submit" value="'+t.lang.evaluation_button_submit+'" style="'+t.STYLE_BODY+'padding:0 15px;border:1px solid #878787;background:#ebe9e9;height:28px;color:#333;line-height:24px;display:inline-block" />',"</td></tr>","</tbody>","</table>"].join("");this.evalDialog||(this.evalDialog=new t.DialogChat(r,{margin:2,border:3,style:{border:"3px solid #00ACFF",height:"auto"},parent:this.chatElement.get(0)})),n=this.evalDialog.container;for(var h,d=0;d<e.length;d++)"textarea"==e[d].type&&(h=n.find("table textarea[name="+e[d].name+"]").parent(),h.css("position","relative"),t({className:"textarea-"+e[d].name,maxsize:e[d].max,style:t.STYLE_BODY+"font-size:16px;font-weight:bold;color:#ccc;float:right;position:absolute;right:15px;top:70px;"}).appendTo(h).html("0/"+e[d].max/2));return n.find("table textarea").bind("keyup",function(e){var i="table .textarea-"+t(this).attr("name"),o=t.enLength(t(this).val())>n.find(i).attr("maxsize")?"#f00":"#ccc",s=Math.ceil(t.enLength(t(this).val())/2)+"/"+n.find(i).attr("maxsize")/2;n.find(i).html(s).css("color",o)}),t.FORM.bindFormEvent(e,n),n.find("input[type!=hidden],textarea").get(0).focus(),n.find(".ntkf-alert-close").click(function(t){l.evalDialog.close(),l.evalDialog=null}),n.find(".view-alert-submit").click(function(e){t.Event.fixEvent(e).stopPropagation(),l.evalRepeatClick&&l.evalDialog&&(l.evalRepeatClick=!1,l.mode.submitEvaluationForm(function(){t.isFunction(a)&&a(),l.evalDialog.close(),l.evalDialog=null,l.evalRepeatClick=!0},function(){l.evalRepeatClick=!0}))}).gradient("top","#f5f5f5","#ffffff"),n.find(".chat-view-evaluation-title").gradient("top","#ffffff","#f5f5f5"),n.get(0)},createEvaluationVersion2:function(e,i){var o=this;if(!this.evalDialog){var s=new t.EvaluateView(e).evaluateHtml;this.evalDialog=new t.DialogChat(s,t.extend(t.defaultStyle.evaluateWrap,{parent:this.chatElement.get(0)})),t.EvaluateEvent.bindEvaluateEvent(),t("[nodeid=submit]").click(function(e){t.Event.fixEvent(e).stopPropagation(),o.evalRepeatClick&&o.evalDialog&&(o.evalRepeatClick=!1,o.mode.submitEvaluationForm(function(){t.isFunction(i)&&i(),o.evalDialog.close(),o.evalDialog=null,o.evalRepeatClick=!0},function(e){o.evalRepeatClick=!0;for(id in e)t(".nt-evaluation-error").html(e[id]).display(1)}))}),t("[nodeid=close]").click(function(t){o.evalDialog.close(),o.evalDialog=null})}},createFileButton:function(t){this.objFile=this._createUpload(t,"uploadfile",this.contains.find(".chat-view-file")),this.objImage=this._createUpload(t,"uploadimage",this.contains.find(".chat-view-image"),"image/jpg,image/png,image/gif,image/jpeg")},_createUpload:function(e,i,o,s,a){var n=this,l={action:i,roomid:"T2D",siteid:this.siteid,settingid:this.settingid,charset:t.charset};return e.filetranserver?new t.Transfer({server:e.filetranserver+"/imageupload.php",name:"userfile",maxSize:s,accept:a,params:l,onError:function(e){var i=t.chatManage.get(l.settingid);i&&i.uploadFailure(l.action,e)},onChange:function(t){n.uploadFileName=t.name,n.uploadFileSize=t.size},callback:function(e){t.Log(l.settingid+"::jsonp: "+t.JSON.toJSONString(e));var i=t.chatManage.get(l.settingid);e.result==-2||9==e.type?i&&i.uploadFailure(l.action,e):(i&&i.startUpload(l.action,e.oldfile),setTimeout(function(){i&&i.uploadSuccess(l.action,e)}))}},o):null},createMessageForm:function(e,i,o,s){var a,n,l=this,r=0,h=this.mode.getNewMessageConfig(),d=h.message_plan||1,c=h.link_mode||"",p=h.specify_link||"";if(this.evalDialog&&(this.evalDialog.close(),this.evalDialog=null),!this.messageElement.find(".chat-view-message-table table").length){o&&(r=this.messageElement.find(".chat-view-message-announcement").html(o).display(1).height()+20);for(var g=0;g<e.length;g++)e[g]=t.extend(e[g],{titlewidth:/zh_cn|zh_tw/gi.test(t.lang.language)?"80px":"140px",inputwidth:"auto",input:{width:"90%",height:"textarea"==e[g].type?"140px":"auto"},messageid:"chat-view-message-"+e[g].name});switch(i){case 0:switch(d){case 1:this.messageElement.find(".chat-view-submit-submit").gradient("top","#f5f5f5","#ffffff"),this.messageElement.find(".chat-view-message-body").css("height",this.messageElement.height()-r+"px"),this.messageElement.find(".chat-view-message-table").html(['<table cellspacing="0" cellpadding="0" border="0" style="',t.STYLE_BODY,'margin:20px 0 0 0;width:100%;table-layout:auto;border-collapse:separate;">','<tbody style="',t.STYLE_NBODY,'">',[t.FORM.createInput(e,null,t.lang.message_no_null),'<tr style="',t.STYLE_NBODY,'">','<td colspan="2" style="',t.STYLE_BODY,'text-align:center;padding:10px 0px 10px;color:#090;">','<input style="'+t.STYLE_BODY+'text-align:center;padding:0 20px;margin:0 auto;border:1px solid #878787;height:28px;color:#000;line-height:26px;" type="button" class="chat-view-button chat-view-submit-submit" value="'+t.lang.message_button_submit+'">','<span class="submit_message_complete" style="',t.STYLE_BODY,'text-align:center;color:#090;display:none;">',t.lang.message_success,"</span>","</td></tr>"].join(""),"</tbody></table>"].join(""));break;case 2:switch(c){case 1:this.messageElement.find(".chat-view-message-announcement").display(),this.messageElement.html(['<iframe src="'+p+'" class="chat-view-message-table-iframe" name="announce_iframe" scrolling="auto" frameborder="0" style="',t.STYLE_BODY,"display:block;width:100%;height:"+this.messageElement.height()+'px;background-color:#ffffff;overflow-x:hidden;overflow-y:auto;" >',"</iframe>"].join(""));break;case 2:this.messageElement.find(".chat-view-message-announcement").display(),t.messageRest=t.sourceURI+"/images/message-rest."+(t.browser.msie6?"gif":"png"),t.messageFish=t.sourceURI+"/images/message-fish."+(t.browser.msie6?"gif":"png"),this.messageElement.find(".chat-view-message-message-prompt").display(1),this.messageElement.find(".chat-view-message-message-prompt").html(['<div class="chat-view-message-prompt-string"  style="width:340px;height:380px;padding:38px 0 0 40px;">','<img src="'+t.messageRest+'" style="width:290px;height:210px;"/>','<div style="width:290px;height:90px;background:url('+t.messageFish+') 140px 14px no-repeat;padding:38px 0 0 34px;">','<span style="font-size:13px;">',t.utils.handleLinks(t.lang.message_prompt),"</span>","</div>","</div>"].join("")),this.messageElement.find(".chat-view-message-prompt-string").find("a").attr("target","_blank").attr("href",p).css({"text-decoration":"none","margin-left":"28px","font-size":"13px","font-weight":"bold",color:"white"});break;default:t.Log("link_mode error",3)}}break;case 1:t.Log("message is close",1);break;default:t.Log("disableMessage error",3)}this.messageElement.find("input[name=myuid]").val(s.myuid),this.messageElement.find("input[name=destuid]").val(s.destid),this.messageElement.find("input[name=ntkf_t2d_sid]").val(s.sessionid),this.messageElement.find("input[name=source]").val(s.source),this.messageElement.find("input[type=text],textarea,select").css("color","#ccc").attr("disabled",""),s.fileError&&(n=t({tag:"tr",style:t.STYLE_NBODY}).appendTo(this.messageElement.find(".chat-view-message-table tbody"),this.messageElement.find(".chat-view-message-table tbody tr").eq(-1)),a=t({tag:"td",style:t.STYLE_NBODY}).appendTo(n),a=t({tag:"td",style:t.STYLE_NBODY}).appendTo(n).html(['<div style="',t.STYLE_BODY,'display:block;color:#ef7208;">','<div style="',t.STYLE_BODY,"margin:2px;width:15px;height:15px;float:left;background:url(",t.imageicon,') no-repeat -160px -39px;"></div>','<div style="',t.STYLE_BODY,'float:left;" class="chat-view-info">',t.lang.message_upload_failure,"</div>",'<div style="',t.STYLE_NBODY,'clear:both;height:0;width:0;"></div>',"</div>"].join(""))),this.messageElement.find(".chat-view-submit-submit").show(function(){t(this).css("display",t.browser.oldmsie?"inline-block":"block")}),this.messageElement.find(".submit_message_complete").display(),t.FORM.bindFormEvent(e,this.messageElement),this.messageElement.find(".chat-view-submit-submit").click(function(t){l.mode.submitMessageForm()}),this.messageElement.find("textarea").val(s.content)}},submitMessageForm:function(e,i){var o=this;t.FORM.verificationForm(e,function(){o.messageElement.find(".chat-view-message-form").attr("action",i),o.messageElement.find(".chat-view-message-form").get(0).submit(),t.Log("chatView.submitMessageForm complete",1),o.messageElement.find("input[type=text],textarea,select").attr("disabled",!0),o.messageElement.find(".chat-view-submit-submit").display(),o.messageElement.find(".submit_message_complete").css("display","block")},this.messageElement)},_fullScreenImage:function(e,i){var o,s=this,a=this._createfullScreen(e),n=t(e).attr("sourceurl")||e.src,l=function(){t.Log("download image "+n),"function"==typeof openURLToBrowser?openURLToBrowser(n):s.displayiFrame.attr("src",n)};t.Log(this.settingid+":chatView._fullScreenImage(), src:"+n,1),t(".view-fullScreen-background").css("opacity",.6),a.click(function(e){t.Event.fixEvent(e).stopPropagation(),s._hideScreenImage()}).find(".view-fullScreen-close").click(function(e){t.Event.fixEvent(e).stopPropagation(),s._hideScreenImage()}),this.nextClick&&this.prevClick&&(a.find(".view-next-picture").removeEvent("click",this.nextClick),a.find(".view-prev-picture").removeEvent("click",this.prevClick)),this.nextClick=function(e){t.Event.fixEvent(e).stopPropagation();var a=0,n=1e7;for(o in s.imageHash){var l=parseInt(o.substr(0,i.length-1)),r=parseInt(i.substr(0,i.length-1));l-r>0&&l-r<n&&(a=o,n=l-r)}0===a?s._hideScreenImage():s._fullScreenImage(t("."+a).find(".view-history-body").find("img"),a)},this.prevClick=function(e){t.Event.fixEvent(e).stopPropagation();var a=0,n=-1e7;for(o in s.imageHash){var l=parseInt(o.substr(0,i.length-1)),r=parseInt(i.substr(0,i.length-1));l-r<0&&l-r>n&&(a=o,n=l-r)}0===a?s._hideScreenImage():s._fullScreenImage(t("."+a).find(".view-history-body").find("img"),a)},a.find(".view-next-picture").addEvent("click",this.nextClick),a.find(".view-prev-picture").addEvent("click",this.prevClick),a.find(".view-fullScreen-download").removeEvent("click",l).bind("click",l),t(e).attr("sourceurl")==t(e).attr("src")?(a.find(".view-fullScreen-download").display(0),a.find(".view-next-picture").display(0),a.find(".view-prev-picture").display(0)):(a.find(".view-fullScreen-download").display(1),a.find(".view-next-picture").display(1),a.find(".view-prev-picture").display(1)),t(document).bind("keypress",function(e){27==t.Event.fixEvent(e).keyCode&&s._hideScreenImage()}),t(window).bind("resize",function(e){t(".view-fullScreen-background,.view-fullScreen-iframe,.view-fullScreen-container").css({width:t(window).width()+"px",height:t(window).height()+"px"}),t(".view-prev-picture div,.view-next-picture div").css({top:(t(window).height()-40)/2+"px"})}),a.find("img").attr("src")!=n&&(a.find("td").css({background:"url("+t.imageloading+") no-repeat center center"}),t.require(n+"#image",function(e){t.Log("nTalk._fullScreenImage() width:"+e.width+", height:"+e.height);var i=t(window).width(),o=t(window).height(),s=t.zoom(e,i-100,o);a.find("td img").length>0&&a.find("td img").remove(),a.find("td").append('<img src="'+n+'" width="'+Math.floor(s.width)+'" height="'+Math.floor(s.height)+'" style="'+t.STYLE_NBODY+"margin:0 auto;max-width:"+(i-100)+"px;max-height:"+o+'px"/>'),a.find("td img")&&a.find("td").css({"background-image":""})}))},_hideScreenImage:function(){t(".view-fullScreen-container,.view-fullScreen-background,.view-fullScreen-iframe").display()},_createfullScreen:function(){var e=t(window).width(),i=t(window).height();return t(".view-fullScreen-iframe").length||t({tag:"iframe",className:"view-fullScreen-iframe",style:t.STYLE_NBODY+"display:none;width:"+e+"px;height:"+i+"px;"}).appendTo(!0).fixed(),t(".view-fullScreen-background").length?t(".view-fullScreen-background").display(1):t({className:"view-fullScreen-background",style:t.STYLE_NBODY+"background:#000;opacity:0.6;filter:alpha(opacity=60);width:"+e+"px;height:"+i+"px;position:absolute;top:0;left:0;z-index:2000000000;"}).appendTo(!0).fixed(),t(".view-fullScreen-container").length?(t(".view-fullScreen-container img").remove(),t(".view-fullScreen-container").width()!=e&&t(".view-fullScreen-container").css("width",e+"px"),t(".view-fullScreen-container").height()!=i&&t(".view-fullScreen-container").css("height",i+"px"),t(".view-fullScreen-container").display(1)):t({className:"view-fullScreen-container",style:t.STYLE_NBODY+"width:"+e+"px;height:"+i+"px;text-align:center;position:absolute;top:0px;left:0;z-index:2000000001;"}).appendTo(!0).html(['<table style="',t.STYLE_NBODY,'width:100%;height:100%;table-layout:auto;border-collapse:separate;">','<tbody style="',t.STYLE_NBODY,'">','<tr style="',t.STYLE_NBODY,'">','<td valign="middle" align="center" style="',t.STYLE_NBODY,"text-align:center;vertical-align:middle;background:url(",t.imageloading,') no-repeat center center;">','<div class="view-prev-picture" style="',t.STYLE_NBODY,'-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;position:absolute;width:50px;height:100%;bottom:0px;top:0px;left:0px">','<div style="position:relative;width:50px; height:40px;top:'+(t(window).height()-40)/2+"px;background:url(",t.imageicon,') no-repeat -225px -92px"></div>',"</div>",'<div class="view-next-picture" style="',t.STYLE_NBODY,'-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;position:absolute;width:50px;height:100%;bottom:0px;top:0px;right:0px">','<div style="position:relative;width:50px; height:40px;top:'+(t(window).height()-40)/2+"px;background:url(",t.imageicon,') no-repeat -178px -92px"></div>',"</div>","</td></tr></table>",'<span class="view-fullScreen-close" style="',t.STYLE_NBODY,"position:absolute;width:28px;height:28px;margin:20px 20px 0 0;top:0;right:0;cursor:pointer;background:url(",t.imageicon,') no-repeat scroll -259px 0;z-index:2000000001;"></span>','<span class="view-fullScreen-download"  style="',t.STYLE_NBODY,"position:absolute;width:28px;height:28px;margin:20px 20px 0 0;top:0;right:50px;cursor:pointer;background:url(",t.imageicon,') no-repeat scroll -219px 0;z-index:2000000001;"></span>'].join("")).fixed(),t(".view-fullScreen-container")},_getMessageHtml:function(e,i){var o="auto";return"system"===e&&t.browser.oldmsie&&(o=Math.min(6*t.enLength(t.clearHtml(i.msg)),340)),i.msgid.indexOf("welcome")>-1&&(i.color="333",i.bold="true"),i.color="333","otherinfo"===e&&(e="left",i.userid="",i.name="",i.msg=['<h1 style="',t.STYLE_BODY,'">','<span style="',t.STYLE_NBODY,"float:left;margin-right:5px;width:15px;height:15px;background:transparent url(",t.imageicon,') no-repeat -199px -38px;"></span>','<span style="',t.STYLE_BODY,'font-weight:bold;">',i.title,"</span>",'<br style="',t.STYLE_NBODY,'clear:both;" />',"</h1>",'<p style="',t.STYLE_BODY,'">',i.msg,"</p>"].join("")),7==i.type&&(i.type=1),"right"===e?['<table style="',t.STYLE_NBODY,'float:right;_float:none;border-collapse:separate;" class="view-history-right" cellpadding="0" cellspacing="0" border="0" class="table">','<tbody style="',t.STYLE_NBODY,'text-align:right;">','<tr style="',t.STYLE_NBODY,'">','<td class="view-history-content" style="',t.STYLE_BODY,'padding:11px 10px;background:#fff;border-radius:3px;border:1px solid #eee;-moz-border-radius:3px;-webkit-border-radius:3px;font-size:12px;">','<div class="view-history-body" style="min-height:20px;',t.STYLE_BODY,/^(2|4)$/i.test(i.type)&&!i.emotion?"text-align:center;display:table-cell;*display:inline-block;vertical-align:middle;/*width:100px;*/min-height:50px;height:85px;*font-size:0px;*line-height:0px;*font-family:Arial;":"display:block;/*width:100%;*/","word-break:break-all;word-wrap:break-word;",1==i.type?"color:#"+i.color+";font:"+("true"==i.italic?"italic":"normal")+" "+("true"==i.bold?"bold":"normal")+" "+i.fontsize+"px/160% Arial,SimSun;text-decoration:"+("true"==i.underline?"underline":"none")+";":"",'">',1==i.type?i.msg:"","</div>",'<div class="view-history-progress" style="',t.STYLE_NBODY,'display:none;border-top:1px solid #30c2fd;background:#fff;height:5px">','<div class="view-history-upload-progress" style="',t.STYLE_NBODY,'height:5px;width:20%;background:#30c2fd;"></div>',"</div>","</td>",'<td style="',t.STYLE_NBODY,'width:25px;overflow:visible;position:relative;">','<span style="width:100%;height:100%;position:absolute;top:8px;display:block;">','<div class="view-history-angle" style="',t.STYLE_NBODY,"position:relative;left:-1px;z-index:1;width:18px;height:16px;background:url(",t.imageicon,') no-repeat -18px -63px;"></div>',"</span>","</td>","</tr>",'<tr style="',t.STYLE_NBODY,'">','<td style="',t.STYLE_BODY,'overflow:visible;text-align:right;position:relative;height:35px;">','<span class="view-history-time" style="',t.STYLE_BODY,'float:right;color:#b9b9c1;line-height:16px;position:absolute;right:150px;top:10px;color:#666;font-size:12px;background:#f0f0f0;border-radius:3px;padding:2px 5px;">',t.formatDate(i.timerkeyid),"</span>",'<span class="view-chat-hidden-area" style="',t.STYLE_NBODY,'float:right;width:1px;height:26px;overflow:visible;position:relative;top:0px;">','<div class="view-history-status" style="',t.STYLE_BODY,'display:none;color:#010002;line-height:26px;width:280px;position:absolute;left:-280px;top:0px;">','<div class="view-history-status-link" style="',t.STYLE_BODY,'float:right;line-height:26px;height:26px;"></div>','<div class="view-history-status-icon" style="',t.STYLE_NBODY,"margin:7px 3px;float:right;display:block;line-height:16px;width:10px;height:10px;background:#fff url(",t.imageicon,') no-repeat -140px -39px;"></div>',"</div>","</span>","</td>",'<td style="',t.STYLE_NBODY,'"></td>',"</tr>","</tbody>","</table>",'<br style="',t.STYLE_NBODY,'clear:both;" />'].join(""):/left|bottom/gi.test(e)?['<table style="',t.STYLE_NBODY,'float:left;float:none;table-layout:auto;border-collapse:separate;" class="view-history-left" cellpadding="0" cellspacing="0" border="0" class="table">','<tbody style="',t.STYLE_NBODY,'">','<tr style="',t.STYLE_NBODY,'">','<td style="',t.STYLE_NBODY,'width:20px;overflow:visible;position:relative;">','<span style="width:100%;height:100%;position:absolute;top:8px;display:block;">','<div class="view-history-angle" style="',t.STYLE_NBODY,"position:relative;right:-1px;top:0px;z-index:1;width:20px;height:18px;background:url(",t.imageicon,') no-repeat 6px -62px;"></div>',"</span>","</td>",'<td class="view-history-content" style="',t.STYLE_BODY,'padding:11px 10px;background:#daf2ff;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px">','<div class="view-history-body" style="min-height:20px;',t.STYLE_BODY,/^(2|4)$/i.test(i.type)&&!i.emotion?"text-align:center;display:table-cell;*display:inline-block;color:#333;vertical-align:middle;/*width:100px;*/min-height:50px;height:85px;*font-size:0px;*line-height:0px;*font-family:Arial;":"display:block;/*width:100%;*/","word-break:break-all;word-wrap:break-word;","bottom"==e?"width:auto;":"",1==i.type?"color:#"+i.color+";font:"+("true"==i.italic?"italic":"normal")+" "+("true"==i.bold?"bold":"normal")+" "+i.fontsize+"px/160% Arial,SimSun;text-decoration:"+("true"==i.underline?"underline":"none")+";":"",'">',/^(1|9)$/i.test(i.type)?i.msg:"","</div>","</td>","</tr>",'<tr style="',t.STYLE_NBODY,'">','<td style="',t.STYLE_NBODY,'"></td>','<td style="',t.STYLE_BODY,'overflow:visible;position:relative;height:35px;">','<span class="view-history-more" style="',t.STYLE_BODY,'margin-right:5px;float:left;color:blue;cursor:pointer;line-height:26px;display:none;">',t.lang.button_more,"</span>",i.userid&&!this.mode.isVisitor(i.userid)&&this.mode.dest.id!=i.userid?['<span class="view-history-destname" style="',t.STYLE_BODY,'padding-right:5px;float:left;color:#b9b9c1;line-height:26px;">',i.name,"</span>"].join(""):"",'<span class="view-history-time" style="',t.STYLE_BODY,'float:left;color:#b9b9c1;line-height:16px;position:absolute;left:160px;top:10px;background:#f0f0f0;color:#666;font-size:12px;border-radius:3px;padding:2px 5px;">',"bottom"==e?"":t.formatDate(i.timestamp||i.timerkeyid),"</span>",'<span class="view-chat-hidden-area" style="',t.STYLE_NBODY,'float:left;width:1px;height:26px;overflow:visible;position:absolute;">','<div class="view-history-status" style="',t.STYLE_BODY,'display:none;color:#010002;line-height:26px;height:26px;width:280px;position:absolute;left:0px;top:0px;">','<div class="view-history-status-icon" style="',t.STYLE_NBODY,"margin:7px 3px;float:left;line-height:26px;display:block;width:10px;height:10px;background:url(",t.imageicon,') no-repeat -140px -39px;"></div>','<div class="view-history-status-link" style="',t.STYLE_BODY,'float:left;line-height:26px;height:26px;">',/^(2|4)$/i.test(i.type)&&!i.emotion?['<a href="javascript:void(0);" style="',t.STYLE_BODY,'">',t.lang.news_download,"</a>"].join(""):[""].join(""),"</div>","</div>","</span>","</td>","</tr>","</tbody>","</table>",'<br style="',t.STYLE_NBODY,'clear:both;" />'].join(""):"first"===e?['<div class="view-history-system" style="',t.STYLE_BODY,'background:transparent;line-height:180%;marign:0 auto;padding:20px 0;text-align:center;word-break:break-all;word-wrap:break-word;">',i.msg,"</div>",'<br style="',t.STYLE_NBODY,'clear:both;" />'].join(""):"goods"===e?['<table style="',t.STYLE_NBODY,'float:left;width:100%;table-layout:auto;border-collapse:separate;" class="view-history-goods" cellpadding="0" cellspacing="0" border="0" class="table">','<tbody style="',t.STYLE_NBODY,'text-align:center;">','<tr style="',t.STYLE_NBODY,'">','<td class="view-history-goods-image" style="',t.STYLE_BODY,'width:50%;min-width:150px;text-align:center;"></td>','<td class="view-history-goods-info" style="',t.STYLE_BODY,'width:50%;text-align:left;"></td>',"</tr>",'<tr style="',t.STYLE_NBODY,'"><td colspan="2" style="',t.STYLE_NBODY,'height:10px;width:100%;"><div style="',t.STYLE_BODY,"margin:0 auto;background:#FFF url(",t.imageicon,') no-repeat 85px -80px;height:10px;width:391px;"></div></td></tr>',"</tbody>","</table>",'<br style="',t.STYLE_NBODY,'clear:both;" />'].join(""):['<div class="view-history-system" style="',t.STYLE_BODY,'marign:20px 0;text-align:center;color:#706E6F;">','<fieldset style="',t.STYLE_BODY,'margin:0 0 10px 0;text-align:center;border-top:1px solid #ccc;">','<legend style="',t.STYLE_BODY,"margin:0 auto;text-align:center;word-break: normal;word-wrap:break-word;font:normal normal normal 12px/160% Arial,SimSun;color:#706e6f;width:",o,';overflow-x:hidden;display:block;" align="center">','<div style="',t.STYLE_BODY,"text-align:center;word-break: normal;word-wrap:break-word;color:#706e6f;width:",o,';overflow-x:hidden;">',i.msg,"</div>","</legend>","</fieldset>","</div>",'<br style="',t.STYLE_NBODY,'clear:both;" />'].join("")},_getViewHtml:function(e){var i=t.browser.msie&&t.browser.ieversion<=8?"":"box-shadow:inset 0px 0px 5px #aaa;-moz-box-shadow:inset 0px 0px 5px #aaa;-webkit-box-shadow:inset 0px 0px 5px #aaa;",o=1==t.server.robot?t.lang.button_switch_manual:"";return"load"==e?['<div class="chat-view-load-icon" style="',t.STYLE_NBODY,"margin:0 auto;width:100px;height:33px;background:transparent url(",t.imageloading,') no-repeat 0px 0px;"></div>','<div class="chat-view-load-info" style="',t.STYLE_BODY,'text-align:center;">',t.lang.chat_info_loading,"</div>",'<div class="chat-view-load-error" style="',t.STYLE_BODY,'text-align:center;margin:120px auto 0;display:none;">',t.lang.chat_info_failure,'<!--<span style="',t.STYLE_BODY,'cursor:pointer;color:#005ffb;text-decoration:none;">',t.lang.chat_info_reload,"</span>--></div>"].join(""):"window"==e?['<div class="chat-view-float-history" style="',t.STYLE_BODY,'width:100%;height:270px;height:267px\\0;_height:269px;background:#fff;padding-top:1px solid #fff\\0;position:absolute;overflow:hidden;z-index:99;display:none;box-shadow:0 5px 3px #888888;">','<iframe class="chat-view-float-iframe" scrolling="no" frameborder="0" style="',t.STYLE_BODY,'display:block;width:100%;height:100%;">',"</iframe>","</div>",'<div class="chat-view-window-history" style="',t.STYLE_BODY,'width:100%;height:270px;height:267px\\0;_height:269px;background-repeat:no-repeat;background-position:center bottom; padding-top:1px solid #fff\\0;position:relative;overflow-x:hidden;overflow-y:scroll;">','<ul style="',t.STYLE_NBODY,'list-style:none;margin:10px 0px 10px 0px;">',"</ul>","</div>",'<div class="chat-view-window-toolbar" style="',t.STYLE_BODY,'height:36px;width:100%;border-top:1px solid #ddd;background:#f9f9f9;">','<div class="chat-view-hidden-area" style="',t.STYLE_NBODY,'width:0px;height:0px;position:relative;overflow:visible;">','<div class="chat-view-window-status-info" style="',t.STYLE_BODY,'background:#66ccff;overflow:hidden;margin-left:10px;width:380px;line-height:30px;height:30px;position:absolute;top:-30px;z-index:99;text-align:center;display:none;"></div>',"</div>",'<div class="chat-view-hidden-area" style="',t.STYLE_NBODY,'width:0px;height:0px;position:relative;overflow:visible;">','<div class="chat-view-suggest-list chat-view-span" style="',t.STYLE_NBODY,'border:1px solid #999;background:#fafafa;width:400px;line-height:30px;height:auto;position:absolute;top:-2px;left:2px;z-index:999;display:none;">','<ul style="',t.STYLE_BODY,'list-style:none;"></ul>',"</div>","</div>",'<div class="chat-view-button chat-view-face" title=',t.lang.button_face,' style="',t.STYLE_BODY,"color:#525252;float:left;margin:11px 0 4px 10px;_margin-left:5px;border:0px solid #ccc;height:16px;display:inline-block;cursor:pointer;width:16px;background:url(",t.themesURI,'face.png) no-repeat;">','<div class="chat-view-hidden-area" style="',t.STYLE_NBODY,'width:0px;height:0px;position:relative;overflow:visible;">','<div class="chat-view-span chat-view-window-face" style="',t.STYLE_NBODY,'display:none;position:absolute;left:-11px;top:-229px;border:1px solid #979A9E;width:273px;height:224px;background:#fff;z-index:1000002;cursor:auto;border-radius:3px;overflow:hidden;">',"</div>","</div>","</div>",'<div class="chat-view-button chat-view-image" title=',t.lang.button_image,' style="',t.STYLE_BODY,"color:#525252;float:left;margin:10px 0 4px 10px;border:0px solid #ccc;height:16px;display:inline-block;cursor:pointer;width:16px;background:url(",t.themesURI,'img.png) no-repeat;"></div>','<div class="chat-view-button chat-view-history" title=',t.lang.button_save,' style="',t.STYLE_BODY,"color:#525252;float:left;margin:10px 0 4px 10px;border:0px solid #ccc;height:16px;display:inline-block;cursor:pointer;width:16px;background:url(",t.themesURI,'save.png) no-repeat;"></div>','<div class="chat-view-button chat-view-file" title=',t.lang.button_file,' style="',t.STYLE_BODY,"color:#525252;float:left;margin:10px 0 4px 10px;border:0px solid #ccc;height:16px;display:inline-block;cursor:pointer;width:16px;background:url(",t.themesURI,'file.png) no-repeat;"></div>','<div class="chat-view-button chat-view-load-history" title=',t.lang.button_view,' style="',t.STYLE_BODY,"color:#525252;float:left;margin:10px 0 4px 10px;border:0px solid #ccc;height:16px;display:inline-block;cursor:pointer;width:16px;background:url(",t.imageicon,') no-repeat -222px -40px;"></div>','<div class="chat-view-button chat-view-capture" title=',t.lang.button_captureImage,' style="',t.STYLE_BODY,"color:#525252;float:left;margin:10px 0 4px 10px;border:0px solid #ccc;height:16px;display:inline-block;cursor:pointer;width:16px;background:url(",t.themesURI,'capture.png) no-repeat;"></div>','<div class="chat-view-capture-options" style="',t.STYLE_BODY,"color:#525252;float:left;margin:7px 0 4px 0px;border:0px solid #ccc;height:20px;width:11px;display:inline-block;cursor:pointer;font-size:8px;background:url("+t.themesURI+'jietu.png) no-repeat 1px 4px;">',"",'<div class="chat-view-capture-hidden-area" style="',t.STYLE_NBODY,'width:1px;height:1px;position:relative;overflow:visible;">','<div class="chat-view-span chat-view-options-capture-menu" style="',t.STYLE_BODY,'display:none;padding:1px;background:#fff;position:absolute;left:-89px;top:-61px;border:1px solid #ccc;width:100px;*width:102px;_width:102px;height:auto;z-index:1000002;cursor:cursor;">','<div class="view-option-hidden talk_selected" style="',t.STYLE_BODY,'padding:3px 0 3px 10px;background:#efefef;">',t.lang.button_capture_hidden_chatWin,"</div>",'<div class="view-option-show" style="',t.STYLE_BODY,'padding:3px 0 3px 10px;">',t.lang.button_capture_show_chatWin,"</div>","</div>","</div>","</div>",'<div class="chat-view-button chat-view-evaluate" title=',t.lang.button_evaluation,' style="',t.STYLE_BODY,"color:#525252;float:left;margin:10px 0 4px 5px;border:0px solid #ccc;height:17px;display:inline-block;cursor:pointer;width:17px;background:url(",t.themesURI,'evaluate.png) no-repeat;"></div>','<div class="chat-view-switch-manual chat-view-robot-button" title="',t.lang.button_switch_manual,'" style="',t.STYLE_BODY,"color:#525252;float:left;padding:0 0 0 0px;margin:10px 0 4px 10px;border:0px solid #ccc;height:16px;display:inline-block;cursor:pointer;width:16px;background:url(",t.imageicon,') no-repeat -265px -40px;display:none;">',o,"</div>",'<div class="chat-view-button chat-view-change-csr" title=',t.lang.button_change_csr,' style="',t.STYLE_BODY,"color:#525252;float:left;margin:10px 0 4px 10px;border:0px solid #ccc;height:16px;display:inline-block;cursor:pointer;width:16px;background:url(",t.imageicon,') no-repeat -244px -41px;"></div>','<div class="chat-view-button chat-view-exp" style="',t.STYLE_BODY,'color:#5c5c5c;float:right;margin:10px 3px;padding:0 3px;border:0px solid #ccc;height:16px;display:inline-block;cursor:pointer;">',t.lang.button_more," &gt&gt;</div>","</div>",'<div class="chat-view-window-editor" style="',t.STYLE_BODY,'height:95px;width:100%;overflow:hidden;">','<textarea placeholder="',t.lang.default_textarea_text,'" style="',t.STYLE_BODY,i,'margin:1px;padding:10px;padding-left:9px;width:383px;width:408px\\9;height:73px;height:93px\\9;outline:0px solid #08f;border:1px solid #ddd;color:#333;resize:none;overflow:hidden;background:#fff;box-shadow:inset 0px 0px 5px #ddd;-moz-box-shadow:inset 0px 0px 5px #ddd;-webkit-box-shadow:inset 0px 0px 5px #ddd;box-sizing:content-box;"></textarea>',"</div>",'<div class="chat-view-window-bottom" style="',t.STYLE_BODY,'height:40px;width:100%;background:#fafafa;border-radius:0px 0px 0px 5px;-moz-border-radius:0px 0px 0px 5px;-webkit-border-radius:0px 0px 0px 5px">','<div class="chat-view-submit-par" style="',t.STYLE_BODY,'position:relative;margin:6px 0;float:right;width:90px;height:28px;line-height:26px;text-align:center;cursor:pointer;background:#b32424;margin-right:10px;border-radius:3px;-moz-border-radius:3px;-webkit-border-radius:3px;">','<div class="chat-view-options" style="',t.STYLE_BODY,'float:right;width:20px;height:28px;line-height:27px;text-align:center;cursor:pointer;background:transparent;color:#fff;">','<span style="width:1px;height:16px;border:none;background:#fff;position:absolute;top:6px;right:20px;filter:alpha(opacity=30); -moz-opacity:0.3;-khtml-opacity: 0.3;opacity: 0.3;"></span>','<span style="display:inline-block;width:12px;height:28px;background:url('+t.themesURI+'send.png) no-repeat 1px 12px; "></span>','<div class="chat-view-hidden-area" style="',t.STYLE_NBODY,'width:1px;height:1px;position:relative;overflow:visible;">','<div class="chat-view-span chat-view-options-menu" style="',t.STYLE_BODY,'display:none;padding:1px;background:#fff;position:absolute;left:-89px;top:-79px;border:1px solid #ccc;width:100px;*width:102px;_width:102px;height:auto;z-index:1000002;cursor:cursor;">','<div class="view-option-enter talk_selected" style="',t.STYLE_BODY,'padding:3px 0 3px 10px;background:#efefef;">',t.lang.button_enter,"</div>",'<div class="view-option-ctrl+enter" style="',t.STYLE_BODY,'padding:3px 0 3px 10px;">',t.lang.button_ctrl_enter,"</div>","</div>","</div>","</div>",'<div class="chat-view-submit" style="',t.STYLE_BODY,'float:right;color:#fff;width:auto;height:28px;line-height:26px;text-align:center;padding:0 22px;cursor:pointer;background:transparent;">',t.lang.chat_button_send,"</div>","</div>",'<span class="chat-view-end-session" style="',t.STYLE_BODY,'text-decoration:none;margin:8px 10px 8px 0;padding:0 10px;float:right;height:24px;line-height:24px;font-size:12px;color:#333;cursor:pointer;">',t.lang.button_end_session,"</span>",'<div style="',t.STYLE_NBODY,'clear:both;"></div>',"</div>"].join(""):"message"==e?['<div class="chat-view-message-announcement" style="',t.STYLE_BODY,'margin:10px 20px 10px 20px;height:auto;max-height:200px;overflow:hidden;display:none;"></div>','<div class="chat-view-message-message-prompt" style="',t.STYLE_BODY,'margin:10px 20px 10px 20px;height:auto;max-height:500px;overflow:hidden;display:none;"></div>','<div class="chat-view-message-body" style="',t.STYLE_BODY,'overflow-x:hidden;overflow-y:auto;width:100%;">','<form name="chat-view-message-form" action="" enctype="multipart/form-data" target="chat-view-submit-iframe" method="post" class="chat-view-message-form" style="',t.STYLE_NBODY,'display:block;">','<input type="hidden" value="'+t.charset+'" name="charset" />','<input type="hidden" value="'+t.source+'" name="parentpageurl" />','<input type="hidden" value="" name="myuid" />','<input type="hidden" value="" name="destuid" />','<input type="hidden" value="" name="ntkf_t2d_sid" />','<input type="hidden" value="" name="source" />','<input type="hidden" value="'+this.settingid+'" name="settingid" />','<div class="chat-view-message-table" style="',t.STYLE_BODY,'width:100%;"></div>',"</form>","</div>"].join(""):['<iframe class="ntkf-alert-iframe" style="',t.STYLE_BODY,'display:none;position:absolute;left:0;top:0;width:100%;height:464px;-moz-opacity:0;opacity:0;filter:alpha(opacity=0);z-index:88888;">',"</iframe>",'<div class="ntkf-alert-background" style="',t.STYLE_BODY,'display:none;position:absolute;left:0;top:0;width:100%;height:464px;background:#000;-moz-opacity:0.35;opacity:0.35;filter:alpha(opacity=35);z-index:99999;">',"</div>",'<div class="ntkf-alert-container" style="',t.STYLE_BODY,'display:none;position:absolute;left:2px;top:0;width:100%;min-height:260px;height:auto;-moz-opacity:1;opacity:1;filter:alpha(opacity=100);border:3px solid #00acff;z-index:2000000000;background:#fff;">',"</div>"].join("");
},_bind:function(){var e=this;this.textEditor=this.chatElement.find(".chat-view-window-editor textarea").css({width:t.browser.Quirks?"410px":"384px",height:t.browser.Quirks?"90px":"70px"}).bind("keypress",function(i){i=t.Event.fixEvent(i),i.stopPropagation(),13==i.keyCode&&i.shitfKey||("Enter"==e._sendKey?13==i.keyCode&&i.ctrlKey||10==i.keyCode?e.textEditor.val(e.textEditor.val()+"\r\n"):13==i.keyCode&&(i.preventDefault(),e._send()):"Ctrl+Enter"==e._sendKey&&/^(10|13)$/.test(i.keyCode)&&i.ctrlKey&&(i.preventDefault(),e._send())),e._editorStart=e._getPositionForTextArea(this)+1}).bind("keyup",function(i){i=t.Event.fixEvent(i);var o=i.keyCode,s=t.enLength(t(this).val());s>e.mode.inputMaxByte&&t(this).val(t.enCut(t(this).val(),e.mode.inputMaxByte));var a=(e.mode.robotKf||e.mode.requestRobot)&&"none"!=t(".chat-view-hidden-area .chat-view-suggest-list").css("display");38==o&&a?(i.preventDefault(),e._selectSuggest(-1)):40==o&&a&&(i.preventDefault(),e._selectSuggest(1))}).bind("click",function(){e._editorStart=e._getPositionForTextArea(this)}).bind("focus",function(){t.promptwindow.stopPrompt(),e.chatElement.find(".chat-view-hidden-area .chat-view-span").display();var i={color:"#000"};t.browser.msie&&t.browser.ieversion<=7?t(this).css(t.merge(i,{width:t(this).parent().width()-26+"px",height:t(this).parent().height()-26+"px","border-width":"1px"})):t(this).css(t.merge(i,{"outline-width":"0px"})),t.browser.html5||t(this).val()==t.lang.default_textarea_text&&t(this).val(""),e._listenTextEditor()}).bind("blur",function(){t.browser.html5||(""===t(this).val()&&t(this).val(t.lang.default_textarea_text),t(this).val()==t.lang.default_textarea_text&&t(this).css({color:"#ccc"})),t.browser.msie&&t.browser.ieversion<=7?t(this).css({"border-width":"0px",width:t(this).parent().width()-24+"px",height:t(this).parent().height()-24+"px"}):t(this).css({"outline-width":"0"}),e._stopListen()}).bind("paste",function(i){var o=function(i){if(i){t.pasteBase64=i;var o=(t(window).height()-510)/2,s=o+480,a=(t(window).width()-640)/2,n=['<div class="pastepic-background" style="width:100%;height:100%;position:absolute;top:0px;left:0px;background-color:#000;opacity:0.6;z-index:5000000;display:none;color:#FFF;"></div>','<div class="pastepic-container" style="top:',o,"px;left:",a,'px;width:640px;height:480px;background-color:#fff;text-align:center;z-index:5000000;margin:auto;position:absolute;display:none;">','<img class="pastepic-show" style="max-width:640px;max-height:480px;" src=""/>',"</div>",'<div class="pastepic-toolbar" style="top:',s,"px;left:",a,'px;width:640px;height:30px;position:absolute;z-index:5000000;margin:auto;text-align:right;background-color:transparent;display:none;">','<div class="pastepic-toolbar-main" style="width:320px;height:30px;line-height:30px;position:relative;float:right;background-color:#F9F9F9;">','<span class="pastepic-describe" style="font-size:12px;font-weight:bold;color:#333333;float:left;margin-left:10px;">是否粘贴此图片</span>','<span class="pastepic-choose-no" style="font-size:12px;color:#333333;cursor:pointer;width:45px;display:inline-block;margin-right:25px;background:url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAANeSURBVDhPXVW/axVBEJ7du7zCMqW1hXX0L0gjRIMWplALRbAIMYnxByiibXgIYhA0gqJgp4JirIMaGxUVbcXOTpuYvNzt3e2O3zf33otxHsfe7c58+83Mt/tcCEEF5iWTqJWNSdTGxifJk5eE0cFLnWDku7d3enksKD8Q1eL0LUk0EDMPB6+SpSiOSIkB3kAbcZiDX1JxPkoCjnexjYMNAW0TD5aIQigCMlF8KzZyFpCA4STHDEfJMB8zW6sHRGBDQEspJgOLf35jA3BBegQdpJhlDTwRorX4ouqninn4DWwIyFfFrs3chNQHdku8eQ4p5+AXAYZaMQaMUtiS+vyEbI2PSrp/zTYimYH9A4hib22KfnoNjl6aZ3el6k4jM3qDKcmUW9IsHJb4YRU+KtWbFyw1SrwNsyPluGtU9Pi8fROmXnkgaXEOqeErbEh5cVLc5zU0A/4oReckGALC/5PyUDaORacnOlovXRJ5ugQgznvJJ09J/PlDGoBlZApanSvLIgdP2WYuY5zBbAMyLS8j5qAuSXProjRPbpuC6Gvlx4ZUUOfysuSHToBdbpFt0/7TIV8bqUzE7HQ235VsakbUNMiKoQxIrXPljvjJkwZGEOp0AOYc8xkaUsPPaonHl0Hc96/cHt3GMnBH2PVv763bFsFThAUTOozZDQG5SwXt8Si5cl3ChcOiX94Zs4SaOTBtPHT46qHU3TMWAzwzhS7JjjYEpM46mkvT25Tq0lEweYtF/PyIZFeXxR2bRVB79NLKQ4mLMxbDhzpNPIM0NoVPGWqtQ6Wb0+O6vs/pxn7RP/u9Fs/vaSgaLctSe91Z3RwTrGNtzGlxc0GrUGhVthhVVaE9fUNCOHK/RD+u4rih0DjL+dV74iZOg0abUs5GHT9r3qxtubaCEYyBYuqgzgYMAxiWVaG9Gwu6fmSPliuPbT6CdVkFLUJpGfQwFnev68bUXg0vH9laKMo+RtBtYVNLihuEZwm78uCTFWvWQX0iSHEOXubTgJY1EO48EDwYtGHKwtsF3Y+KK8sObntdEd+6jNF0h3dcSrzpWhJ0BRHaTtnAwzSFAO4s0CSlzofzrFPW7yaZMzhBRnQd4ZGF7RQ2dEanPCKoz9D2AwtKw+5GziMNB3lt/xVwy5ahc07+ArnLFQPLE82pAAAAAElFTkSuQmCC\') no-repeat 5px 5px">否</span>','<span class="pastepic-choose-yes" style="font-size:12px;color:#333333;cursor:pointer;width:50px;display:inline-block;margin-right:25px;border:1px solid #cfcfcf;height:20px;line-height:20px;padding:0 8px 0 1px;border-radius:3px;background:url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAIAAAAC64paAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAKPSURBVDhP1VLNS1VREJ85531oGomaCMFDREmIIgg3FW0qamGLFyUFtXFlRBgIkS500cciigjSvyCiTRS2blHQ8oGtkvSpkGj4kSX4vF9npt+5T7G1u+bCveeemfnNzG9+HIYh7dXM9ndP9v8mi7I/qaqh9LSL6F1KmerPWrJ0/9v5YqlpfOEeYpQMR0Eo5NPUqjpi9vlWRXyaIXW4wWElnB+ZubIYzAu85F4dna7PNRthA6+QoyTtIoV0bMSDMcCc2oXw+9DUxZ/BDyaXVenc112Xb0Zxj02UCXXrw/LYp/X3pDFK+17gMqqUKweTQ1M9q26NNQZWR/2J0cNvEYYGOYyDROhJ+Xpp/WPC7kxj8U7bWC3VOJS10dRG6cHctc1oA80L8fH9p4Y7X+e5DmUTcoYdZ5VXojVHzrL5/Ovd05m+QLdQ9uvvL6Plq5vxHz+22u6GC8Mdb/JcS5rBZHlljuIKsqYrpZHZYiWspBX02IGT5xpvvpwdSDh2xlnh0w3Fu+3jlms0ZR7DGlZoO8Y/WCpvTY7M9FaiZQEPaUjKPGLkbPONW4Vn1mZZHNhIebTgGD5EJeC8vfbI466JpuyhNMsC3HNPdOlg/+2255ZzhEzcbovC+QUKHr8f0GELua6HXRMt+YJJ41C1t3Wwr/CIU/qhFtTw9zvmRUIsaizqQFCWdNUtvZjrXwzmLrcO9LT0QThgiCnx3UJNANoxrkShrU7o+/eNgli/ZIBVW8QXesGLwbF1ZjfZIBN6AiR48kU4D1EJxSKJVxp2xPCwVZw0AU3/GGSIPSMATugNRMesOdaMABbXkrA11SaYs2nbu4b4OFYnFgyzOgyG+cFejI4yIsZkIO6UJxGJ4N3OgxH9Ben/Y4RnXjBoAAAAAElFTkSuQmCC\') no-repeat 5px 0px">是</span>',"</div>","</div>"].join("");0===t(".pastepic-background").length&&(t(document.body).append(n),t(".pastepic-choose-no").bind("click",function(){l.display(0),r.display(0),h.display(0)}),t(".pastepic-choose-yes").bind("click",function(){l.display(0),r.display(0),h.display(0),e.objImage.base64Transf(t.pasteBase64)}));var l=t(".pastepic-background"),r=t(".pastepic-container"),h=t(".pastepic-toolbar"),d=t(".pastepic-show");d.attr("src",i),l.display(1),r.display(1),h.display(1)}},s=new t.paste(i,o);s.getImgBase64Str()}),""!==this.textEditor.val()||t.browser.html5||this.textEditor.val(t.lang.default_textarea_text),this.chatElement.find(".chat-view-end-session").hover(function(e){t(this).css("color","#005fea")},function(e){t(this).css("color","#010101")}).click(function(i){t.Event.fixEvent(i).stopPropagation(),e._endSession()});var i,o;this.chatElement.find(".chat-view-button,.chat-view-switch-manual").hover(function(e){t.Event.fixEvent(e).stopPropagation(),t(this).attr("talk_disable")||t(this).attr("selected")||(i=t(this).css("background-position").split(" ").shift(),o=t(this).indexOfClass("chat-view-load-history")||t(this).indexOfClass("chat-view-switch-manual")||t(this).indexOfClass("chat-view-change-csr")?" -60px":" -19px",t(this).css({filter:"alpha(opacity=50)","-moz-opacity":"0.5","-khtml-opacity":" 0.5",opacity:"0.5"}))},function(e){t.Event.fixEvent(e).stopPropagation(),t(this).attr("talk_disable")||t(this).attr("selected")||(i=t(this).css("background-position").split(" ").shift(),o=t(this).indexOfClass("chat-view-face")?" -1px":t(this).indexOfClass("chat-view-load-history")||t(this).indexOfClass("chat-view-switch-manual")||t(this).indexOfClass("chat-view-change-csr")?" -40px":" 0px",t(this).css({filter:"alpha(opacity=100)","-moz-opacity":"1","-khtml-opacity":"1",opacity:"1"}))}),this.chatElement.find(".chat-view-face").click(function(i){e.mode.callTrack("10-02-02"),t.Event.fixEvent(i).stopPropagation(),e.chatElement.find(".chat-view-window-face").display(1),e._initFaceGroup()}),this.chatElement.find(".chat-view-image").click(function(i){e.mode.callTrack("10-02-03"),t.Event.fixEvent(i).stopPropagation(),e._image(i)}),this.chatElement.find(".chat-view-file").click(function(i){e.mode.callTrack("10-02-05"),t.Event.fixEvent(i).stopPropagation(),e._file(i)}),this.chatElement.find(".chat-view-history").click(function(i){t.Event.fixEvent(i).stopPropagation(),t(this).attr("talk_disable")||e._download(i)}),this.chatElement.find(".chat-view-load-history").click(function(i){t.Event.fixEvent(i).stopPropagation(),t(this).attr("talk_disable")||e._viewHistory(!t(this).attr("selected"))}),this.chatElement.find(".chat-view-evaluate").click(function(i){e.mode.callTrack("10-02-09"),t.Event.fixEvent(i).stopPropagation(),t(this).attr("talk_disable")||e._evaluate(i)}),this.chatElement.find(".chat-view-capture").click(function(i){e.mode.callTrack("10-02-04"),t.Event.fixEvent(i).stopPropagation(),t(this).attr("talk_disable")||e._capture(i)}),this.chatElement.find(".chat-view-switch-manual").click(function(i){t.Event.fixEvent(i).stopPropagation(),t(this).attr("talk_disable")||e._switchManual(i)}),this.chatElement.find(".chat-view-change-csr").click(function(i){t.Event.fixEvent(i).stopPropagation(),t(this).attr("talk_disable")||e._changeCsr(i)}),this.chatElement.find(".chat-view-exp").click(function(i){t.Event.fixEvent(i).stopPropagation(),e._expansion(i)}),this._eventFunction=function(t){e._hiddenFloatMenu()},t(document.body).click(this._eventFunction),this.chatElement.find(".chat-view-submit-par").hover(function(e){t.Event.fixEvent(e).stopPropagation(),t(this).css({"background-color":"#8f0e0e"})},function(e){t.Event.fixEvent(e).stopPropagation(),t(this).css({"background-color":"#b32424"})}),this.chatElement.find(".chat-view-submit").click(function(i){t.Event.fixEvent(i).stopPropagation(),t(this).attr("talk_disable")||e._send(!0)}),this.chatElement.find(".chat-view-options").click(function(i){t.Event.fixEvent(i).stopPropagation(),e.chatElement.find(".chat-view-hidden-area .chat-view-options-menu").display(1)}),this.chatElement.find(".chat-view-capture-options").click(function(i){t.Event.fixEvent(i).stopPropagation(),e.chatElement.find(".chat-view-capture-hidden-area .chat-view-options-capture-menu").display(1)}),this.chatElement.find(".chat-view-options-menu div").click(function(i){t.Event.fixEvent(i).stopPropagation(),e.chatElement.find(".chat-view-options-menu div").each(function(e,i){t(i).removeClass("talk_selected").css("background","none")}),t(this).indexOfClass("view-option-enter")?e._sendKey="Enter":e._sendKey="Ctrl+Enter",t(this).addClass("talk_selected").css("background","#f1f1f1"),t(this).parent().display()}),this.chatElement.find(".chat-view-options-capture-menu div").click(function(i){t.Event.fixEvent(i).stopPropagation(),e.chatElement.find(".chat-view-options-capture-menu div").each(function(e,i){t(i).removeClass("talk_selected").css("background","none")}),t(this).indexOfClass("view-option-hidden")?t.Capture.captureWithMin=!0:t.Capture.captureWithMin=!1,t(this).addClass("talk_selected").css("background","#f1f1f1"),t(this).parent().display()}),this.options.chatHeader.find(".header-chatrecord-close").css({margin:"20px 5px 0 0",background:"url("+t.imageicon+") no-repeat -60px 0"}).attr("title",t.lang.chat_button_close).hover(function(e){t(this).css("background-position","-60px -20px")},function(e){t(this).css("background-position","-60px 0")}).click(function(i){t.Event.fixEvent(i).stopPropagation(),e._viewHistory(!1)})},audioProgress:function(t,e){},_hiddenFloatMenu:function(){this.chatElement.find(".chat-view-hidden-area .chat-view-span").display(),this.chatElement.find(".chat-view-capture-hidden-area .chat-view-span").display()},disableButton:function(e,i){var o=this,s=[];return e=t.isArray(e)?e:[e],t.each(e,function(t,e){s.push("."+o.buttonSelectors[e])}),s=s.join(","),i?(s.indexOf("chat-view-image")>-1&&this.chatElement.find(".chat-view-image").find("object,embed,form").css("visibility","hidden"),s.indexOf("chat-view-file")>-1&&this.chatElement.find(".chat-view-file").find("object,embed,form").css("visibility","hidden"),s.indexOf("chat-view-change-csr")>-1&&t(".chat-view-change-csr").css("background-position-y"," -40px"),s.indexOf("chat-view-switch-manual")>-1&&t(".chat-view-switch-manual").css("background-position-y"," -40px"),this.chatElement.find(s).attr("talk_disable","disable").css("opacity","0.4"),!1):(s.indexOf("chat-view-image")>-1&&this.chatElement.find(".chat-view-image").find("object,embed,form").css("visibility","visible"),s.indexOf("chat-view-file")>-1&&this.chatElement.find(".chat-view-file").find("object,embed,form").css("visibility","visible"),this.chatElement.find(s).attr("talk_disable","").css("opacity",1),!0)},displayButton:function(e,i){var o=this,s=[];e=t.isArray(e)?e:[e],t.each(e,function(t,e){s.push("."+o.buttonSelectors[e])}),s=s.join(","),this.chatElement.find(s).display(!i)},disabledAudioButton:function(){},_listenTextEditor:function(){var e=this;this._listenTimeID=setInterval(function(){var i=e.textEditor.val(),o=e._cacheListen;t.browser.html5||i!=t.lang.default_textarea_text||(i=""),t.enLength(i)>500&&(i=t.enCut(i,500),e.textEditor.val(i),e.textEditor.scrollTop(e.textEditor.scrollHeight())),e._listenNumber++,(i&&o!==i||!i&&o)&&e.mode.predictMessage(i),e._cacheListen=i},1e3)},_stopListen:function(){this._listenNumber=0,clearInterval(this._listenTimeID),this._listenTimeID=null},_initFaceGroup:function(){var i,o=this,s=t.STYLE_NBODY+"outline:0;float:left;padding:8px;width:23px;height:23px;display:inline;zoom:1;";this._initFace||(this._initFace=!0,this.chatElement.find(".chat-view-face-tags").length||this.chatElement.find(".chat-view-window-face").append(['<div class="chat-view-face-tags" style="',t.STYLE_NBODY,'background:#F1F1F1;clear:both;padding:0 10px;height:38px;border-top:1px solid #D4D4D4;"></div>'].join("")),t.each(this.mode.config.faces,function(a,n){var l="chat-view-face-group-"+a,r="chat-view-face-tag-"+a;o.chatElement.find("."+l).length||o.chatElement.find(".chat-view-window-face").insert('<div class="'+l+' chat-view-face-group" style="'+t.STYLE_NBODY+(0===a?"":"display:none;")+'overflow-x:hidden;overflow-y:auto;margin:10px 0px 10px 10px;clear:left;height:165px;"></div>',"afterbegin"),n.pics===e&&(n.pics=[]),t.each(n.pics,function(t,e){var n=t+1,r=0===a?' title="'+e.sourceurl+'"':' title="" sourceurl="'+e.sourceurl+'"';i=s+"border:1px solid #F6FBFE;border-left:1px solid #DFEFF8;border-bottom:1px solid #DFEFF8;background:#F6FBFE;"+(n<=6?"border-top:1px solid #DFEFF8;":"")+(n%6===0?"border-right:1px solid #DFEFF8;":""),o.chatElement.find("."+l).append('<img src="'+e.url+'" '+r+' border="0" style="'+i+'" />')}),0===a?t({className:"chat-view-face-tag "+r+" tag-selected",title:n.name,index:"0",style:t.STYLE_NBODY+"zoom:1;margin:0 5px 0 0;float:left;background:#fff;position:relative;top:-1px;border-left:1px solid #D4D4D4;border-right:1px solid #D4D4D4;"}).appendTo(o.chatElement.find(".chat-view-face-tags")).append('<img src="'+n.icon+'" border="0" style="'+s+'border:none;" />'):t({className:"chat-view-face-tag "+r,title:n.name,index:a,style:t.STYLE_NBODY+"zoom:1;margin:0 5px 0 0;float:left;position:relative;top:0px;border-left:1px solid #f1f1f1;border-right:1px solid #f1f1f1;"}).appendTo(o.chatElement.find(".chat-view-face-tags")).append('<img src="'+n.icon+'" border="0" style="'+s+'border:none;" />')}),this.chatElement.find(".chat-view-face-group").hover(function(e){t.Event.fixEvent(e).stopPropagation();var i=t.Event.fixEvent(e).target;"img"===i.tagName.toLowerCase()&&t(i).css({cursor:"pointer","background-color":"#FFF"})},function(e){t.Event.fixEvent(e).stopPropagation();var i=t.Event.fixEvent(e).target;"img"===i.tagName.toLowerCase()&&t(i).css({"background-color":"#F6FBFE"})}).click(function(e){t.Event.fixEvent(e).stopPropagation();var i=t.Event.fixEvent(e).target;"img"===i.tagName.toLowerCase()&&(o.chatElement.find(".chat-view-window-face").display(),t(this).indexOfClass("chat-view-face-group-0")?o._insertText("["+t(i).attr("title")+"]"):(t.Log("selected current face:"+t(i).attr("sourceurl")),o.mode.send({type:2,emotion:1,msg:"current face",url:t(i).attr("src"),sourceurl:t(i).attr("sourceurl"),oldfile:"",size:"",extension:""})))}),this.chatElement.find(".chat-view-face-tags").hover(function(e){t.Event.fixEvent(e).stopPropagation();var i=t.Event.fixEvent(e).target;i="img"==i.tagName.toLowerCase()?i.parentNode:i,t(i).indexOfClass("chat-view-face-tag")&&!t(i).indexOfClass("tag-selected")&&t(i).css({"background-color":"#fafafa",top:"-1px","border-left":"1px solid #D4D4D4","border-right":"1px solid #D4D4D4","margin-right":"5px",zoom:"1"})},function(e){t.Event.fixEvent(e).stopPropagation();var i=t.Event.fixEvent(e).target;i="img"==i.tagName.toLowerCase()?i.parentNode:i,t(i).indexOfClass("chat-view-face-tag")&&!t(i).indexOfClass("tag-selected")&&t(i).css({"background-color":"transparent",top:"0px","border-left":"1px solid #f1f1f1","border-right":"1px solid #f1f1f1","margin-right":"5px",zoom:"1"})}).click(function(e){t.Event.fixEvent(e).stopPropagation();var i=t.Event.fixEvent(e).target;i="img"==i.tagName.toLowerCase()?i.parentNode:i,t(i).indexOfClass("chat-view-face-tag")&&(o.chatElement.find(".chat-view-face-tag").css({"background-color":"transparent",top:"0px","border-left":"1px solid #f1f1f1","border-right":"1px solid #f1f1f1","margin-right":"5px",zoom:"1"}).removeClass("tag-selected"),o.chatElement.find(".chat-view-face-group").display(),t(i).css({"background-color":"#fff",top:"-1px","border-left":"1px solid #D4D4D4","border-right":"1px solid #D4D4D4","margin-right":"5px",zoom:"1"}).addClass("tag-selected"),o.chatElement.find(".chat-view-face-group-"+t(i).attr("index")).display(1))}))},_contentFilter:function(e){return"string"!=typeof e.msg||/<.*?\>/gi.test(e.msg)?(1!==e.type&&7!=e.type||!/<img(.*?)src=([^\s]+)(.*?)>/gi.test(e.msg)||(e.msg=e.msg.replace(/<img(.*?)src=([^\s]+)(.*?)>/gi,'<img class="ntalk-preview" '+(7==e.type?" robotImg='true' ":"")+'src="'+t.imageloading+'" sourceurl=$2 style="'+t.STYLE_NBODY+'" />')),e):(e.msg=e.msg.replace(/[\r\n]/gi," <br>"),e.msg&&e.msg.indexOf("xnlink")===-1&&(e.msg=e.msg.replace(/(\s{2})/gi," {$null}")),e.msg=t.myString(e.msg).linkFilter1(t.STYLE_BODY+"color:#0a8cd2;"),e.msg=e.msg.replace(/\{\$null\}/gi,"&nbsp;&nbsp;"),e.msg=e.msg.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;"),e.msg=t.utils.handleLinks(e.msg,{settingid:this.settingid}),e.msg=this._faceFilter(e.msg),e=t.extend({color:"000000",fontsize:"12",bold:"false",italic:"false",underline:"false"},e))},_faceFilter:function(e){var i=e.match(/\[([a-z]+)\]/gi),o=function(e){var i=null;return t.each(t.lang.editorFaceAlt,function(t,o){o&&new RegExp(e.replace(/\[/,"\\[").replace(/\]/,"\\]"),"gi").test("["+o+"]")&&(i=t)}),i};if(!i||!e)return e;for(var s,a=0;a<i.length;a++)(s=o(i[a]))&&(e=e.replace(i[a],'<img src="'+t.sourceURI+"images/faces/"+s+(t.browser.msie6?".gif":".png")+'" style="'+t.STYLE_NBODY+'width:23px;height:23px;margin:0 2px;display:inline;vertical-align:text-bottom;" />'));return e},_image:function(){},_file:function(){},_download:function(){this.mode.download&&this.mode.download(this.settingid)},_viewHistory:function(t){this.mode.viewHistory&&(t?this.chatElement.find(".chat-view-load-history").attr("selected","selected").css("background-position","-220px -60px"):this.chatElement.find(".chat-view-load-history").attr("selected","").css("background-position","-220px -40px"),this._tempHeader.display(!t),this._chatsHeader.display(t),this._chatsElement.css({height:this.chatHistory.height()+"px"}).display(t),t&&this.mode.viewHistory(this.settingid,this._chatsElement.find("IFRAME.chat-view-float-iframe").get(0)))},_evaluate:function(){this.mode.showEvaluation&&this.mode.showEvaluation()},_capture:function(){this.mode.startCapture&&this.mode.startCapture(this.settingid)},_switchManual:function(){this.mode.switchServerType&&this.mode.switchServerType(!0,this.settingid)},_changeCsr:function(){this.mode.changeCustomerServiceInfo&&this.mode.changeCustomerServiceInfo()},_expansion:function(t){this.options.toggleExpansion(this.settingid)},updateMore:function(e){this.chatElement.find(".chat-view-exp").html(t.lang.button_more+(e?" &lt&lt;":" &gt&gt;"))},switchToolbar:function(e,i){var o=this;t.Log("nTalk.chat.view.switchToolbar("+e+")"),e?(this.chatElement.find(".chat-view-button,.chat-view-capture-options").each(function(){var e=t(this).indexOfClass("chat-view-capture-options");(!e&&"disable"!=t(this).attr("talk_disable")||e&&"block"==o.chatElement.find(".chat-view-capture").css("display"))&&t(this).display(1)}),this.displayButton("csr",1!=this.mode.config.changecsr),this.displayButton("history",1!=this.mode.config.chatingrecord),this.displayButton("loadhistory",1!=this.mode.config.viewchatrecord),this.displayButton(["capture","capoptions"],0===this.mode.config.captureimage),this.displayButton("evaluate",0===this.mode.config.evaluation),this.chatElement.find(".chat-view-exp").display(this.mode._moreData&&this.mode._moreData.length),this.chatElement.find(".chat-view-switch-manual").display()):(2==t.server.robot?(this.chatElement.find(".chat-view-button,.chat-view-capture-options").each(function(){var e=t(this).indexOfClass("chat-view-capture-options");("disable"==t(this).attr("talk_disable")||e&&"none"==o.chatElement.find(".chat-view-capture").css("display"))&&t(this).display()}),this.displayButton("loadhistory",1!=this.mode.config.viewchatrecord),this.displayButton("history",1!=this.mode.config.chatingrecord),this.displayButton(["capture","capoptions"],0===this.mode.config.captureimage),this.displayButton("evaluate",0===this.mode.config.evaluation)):this.chatElement.find(".chat-view-button,.chat-view-capture-options").each(function(){t(this).display()}),this.chatElement.find(".chat-view-exp").display(this.mode._moreData&&this.mode._moreData.length),this.chatElement.find(".chat-view-switch-manual").display(1),this.chatElement.find(".chat-view-change-csr").display(0))},_send:function(e){if(this.chatElement.find(".chat-view-hidden-area .chat-view-suggest-list").display(),this.isRobotSuggest=!0,"disable"==t(".chat-view-submit").attr("talk_disable")||/QUERY|QUEUE/i.test(this.mode.statusConnectT2D))return!1;var i=this._clearEditor();i.length&&i!=t.lang.default_textarea_text&&this.mode.send(i),t.browser.html5||e!==!0||this.textEditor.css({color:"#ccc"}).val(t.lang.default_textarea_text).get(0).focus()},_endSession:function(){this.mode.endSession()},_clearEditor:function(){var t=this.textEditor.val().replace(/(^\s*)|(\s*$)/g,"");return this.textEditor.val(""),t},callChatResize:function(t,e){this.chatHistory.css({height:e-172+"px"}),this.chatElement.find(".chat-view-float-history, .chat-view-float-history iframe").css({height:e-165+"px"}),this.chatElement.find(".chat-view-window-status-info").css("width",t-40+"px"),this.evalDialog&&this.evalDialog.resize(),this.textEditor.css({width:t-22+"px"}),this.scroll&&this.scroll.resizeScroll()},changeQueueStyle:function(){return!1},audioView:function(e){if(!this.msgid&&t.musicEl)return t.musicEl.emit(),void(t.musicEl=null);var i,o,s,a,n,l=this,r=l.msgid,h=l.duration,d=t("."+r).find(".view-history-body"),c=!(r.toLowerCase().indexOf("j")>-1);switch(c?(o=t.sourceURI+"images/kfSound.png",s=t.sourceURI+"images/kfSound.gif",a="#FFFFFF",n="right",durationAlign="left"):(o=t.sourceURI+"images/mySound.png",s=t.sourceURI+"images/mySound.gif",a="#CEF2FF",n="left",durationAlign="right"),e){case"init":t.Log("[nTalk music]: mp3 view init, msgid is "+r);var p=['<div id="duration_',r,'" style="',t.STYLE_BODY,"height:24px;line-height:24px;padding:4px 4px 0px;float:",durationAlign,'" >',h,"''</div>",'<div id="player_',r,'" style="',t.STYLE_BODY," width:80px;height:24px;padding:4px 0;background:",a,";border-radius:5px;border: none;text-align:",n,'">','<img width="24px" height="24px" src="',o,'"/>',"</div>"].join("");d.parent().css("padding","0px"),d.append(p),t.browser.msie&&t.browser.ieversion<=7&&(t("#player_"+r).css("width","50px"),t("."+r).find("table").css("width","100px"));break;case"play":t.Log("[nTalk music]: mp3 view play, msgid is "+r),t.musicEl&&(t.Log("[nTalk music]: stop playing mp3 view, msgid is "+t.playMsgid,2),t.musicEl.emit()),t.musicEl=l,i=t("#player_"+r+" img")[0],i.src=i.src.replace("png","gif");break;case"stop":t.Log("[nTalk music]: mp3 view stop, msgid is "+r),t.musicEl=null,i=t("#player_"+r+" img")[0],i.src=i.src.replace("gif","png")}},audioBindEvent:function(e){var i=this.msgid;switch(e){case"init":t.Log("[nTalk music]: mp3 event init, msgid is "+i);var o=this,s=t("#player_"+i);s.click(function(){t.Log("[nTalk music]: mp3 trigger click, msgid is "+i),o.emit()})}},starLevel:function(e){if(!(t(".nt-evaluation-starlevel").length>0)){var o="",s="nt-evaluation-starlevel",a={"nt-evaluation-starlevel-span":"padding: 0px; margin:11px 0px 14px 10px; border: none; width: 90px; max-width: 90px; height:16px; line-height:16px; max-height: none; clear: none; position: static; display: inline-block; float: left;visibility: visible; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; cursor: auto; background-color: transparent;","nt-evaluation-starlevel":""},n=!1,l=t.sourceURI+"images/evaluate/fullstar.png",r=t.sourceURI+"images/evaluate/emptystar.png",h=t.sourceURI+"images/evaluate/halfstar.png";for(e!=Math.ceil(e)&&(n=!0),i=0;i<Math.floor(e);i++)o+='<img class="'+s+'" style="'+t.STYLE_BODY+" "+a[s]+'" src="'+l+'" nodeid="fullstar"/>';for(n&&(o+='<img class="'+s+'" style="'+t.STYLE_BODY+" "+a[s]+'" src="'+h+'" nodeid="fullstar"/>'),i=0;i<5-Math.ceil(e);i++)o+='<img class="'+s+'" style="'+t.STYLE_BODY+" "+a[s]+'" src="'+r+'" nodeid="fullstar"/>';o='<span class="nt-evaluation-starlevel-span" style="'+t.STYLE_BODY+" "+a["nt-evaluation-starlevel-span"]+'">'+o+"</span>",t(".chat-header-body").append(o)}}};var r=t.Class.create();r.prototype={_width:0,_height:0,_isMessageView:!1,element:null,title:"",status:0,count:0,initialize:function(e,i,s){var a=this;t.Log("new nTalk.minimizeView()",1),this.status=e.status||0,this._isMessageView=i,this.callback=s||o,this.element=t(".ntalk-minimize-window"),this._width=213,this._height=44,this.element.length||(this.element=t({className:"ntalk-minimize-window",style:t.STYLE_BODY+"width:"+(this._width-2)+"px;height:"+(this._height-2)+"px;border:1px solid #c8c7c6;background:#e5e5e4;cursor:pointer;z-Index:2000000000;"}).appendTo(!0).gradient("top","#e5e5e4","#f2f3f3").fixed({left:t(window).width()-this._width-2,top:t(window).height()-this._height-2}).html(['<div class="ntalk-minimize-icon" style="',t.STYLE_BODY,"float:left;margin:4px 8px;_margin:4px 4px;width:35px;height:35px;background:url(",t.imageicon,') no-repeat -383px -8px;"></div>','<div class="ntalk-minimize-title" style="',t.STYLE_BODY,'float:left;margin:4px 0;line-height:35px;overflow:hidden;width:160px;height:35px;max-width:162px;"></div>','<div style="',t.STYLE_NBODY,'clear:both;"></div>'].join(""))),t(window).bind("resize",function(t){a._fiexd(t)}),this.update(e.name||"",e.logo||""),this.status?this.online():this.offline(),this.element.click(function(e){t.Event.fixEvent(e).stopPropagation(),a.remove()})},online:function(){this.element.find(".ntalk-minimize-icon").css("opacity",1)},offline:function(){this.element.find(".ntalk-minimize-icon").css("opacity",.5)},update:function(e,i){if(this.title=e?t.utils.handleLinks(t.lang.toolbar_min_title,{destname:e}):t.lang.toolbar_default_text,this.element.find(".ntalk-minimize-title").html(this.title),i&&i!=t.CON_SINGLE_SESSION){var o,s=this;t.require(i+"#image",function(e){return e.error?void t.Log("load logo:"+i,2):(o=t.zoom(e,35,35),void s.element.find(".ntalk-minimize-icon").css("background-position","-500px -8px").html('<img src="'+i+'" width="'+o.width+'" height="'+o.height+'" style="'+t.STYLE_NBODY+"margin:"+(35-o.height)/2+"px "+(35-o.width)/2+"px;width:"+o.width+"px;height:"+o.height+'px;" />'))})}else this.element.find(".ntalk-minimize-icon").css("background-position","-383px -8px")},remove:function(){t(window).removeEvent("resize",this._fiexd),this.stopFlicker(),this.element.remove(),this.callback()},startFlicker:function(i,o){var s=this,a=this.count>99?"99+":this.count,n=i?1e3:500;o=o||0,i===e&&this.stopFlicker(!0),t.Log("$.minView.startFlicker("+t.JSON.toJSONString(arguments)+") timeid:"+this.timeID,1),i?this.element.css({"border-color":"#d55f01"}).gradient("top","#ff8803","#ff7b16"):this.element.css({"border-color":"#c8c7c6"}).gradient("top","#e5e5e4","#f2f3f3").find(".ntalk-minimize-title").html(t.utils.handleLinks(t.lang.toolbar_min_news,{count:'<span style="'+t.STYLE_BODY+'color:#fff;font-weight:bold;">'+a+"</span>"})),o>=7||(this.timeID=setTimeout(function(){o++,s.startFlicker(!i,o)},n))},stopFlicker:function(e){t.Log("$.minView.stopFlicker()",1),clearTimeout(this.timeID),this.timeID=null,e||(this.count=0),this.element.find(".ntalk-minimize-icon").css("background-position","-98px -38px"),this.element.css({"border-color":"#d55f01"}).gradient("top","#e5e5e4","#f2f3f3").find(".ntalk-minimize-title").html(this.title)},_fiexd:function(e){this.element=t(".ntalk-minimize-window"),this.element&&this.element.length&&this.element.fixed({width:this.width-2,height:this.height-2,left:t(window).width()-this.width-2,top:t(window).height()-this.height-2})}};var h=t.Class.create();h.prototype={name:"chatManageView",defaultOptions:{dropHeight:72,width:407,height:492,minWidth:415,minHeight:520,leftElementWidth:140,rightElementWidth:208,resizeHeight:622,drag:!0,resize:!1,fixed:!0,zIndex:1e6},_flickerTimeID:[],_objView:null,_manageMode:null,tagKey:"",tagTitle:"",extended:null,options:null,header:null,body:null,leftContent:null,leftElement:null,chatBody:null,chatContainter:null,rightElement:null,chatWidth:0,chatHeight:0,CON_ICON_WIDTH:62,CON_ICON_HEIGHT:62,initialize:function(e,i){this.options=t.extend({},this.defaultOptions,e),this.extended={leftElement:!1,rightElement:!1},this._manageMode=i,this._getChatPosition(e.position||{}),this._create(),this._bind()},close:function(){t.Log("nTalk.chatManageView.close()",1);try{t.browser.oldmsie?this._objView.containter.display():this._objView.containter.remove()}catch(e){t.Log(e,3)}},addChatTag:function(e){var i,o=this;this.leftContent&&(this.tagKey=e,this.tagTitle=t.lang.toolbar_default_text,i=t({tag:"li",style:t.STYLE_NBODY+"margin:5px 0 0 5px;list-style:none;border:1px solid #fafafa;border-right:none;position:relative;cursor:pointer;",className:this.tagKey,key:this.tagKey}).appendTo(this.leftContent).html(['<div class="tag-head-icon" style="',t.STYLE_NBODY,'width:12px;height:12px;overflow:hidden;position:absolute;left:0;margin:11px 0px 11px 11px;background:#666;"></div>','<div class="tag-content-text" style="',t.STYLE_BODY,'margin-left:30px;height:35px;line-height:35px;overflow:hidden;">',this.tagTitle,"</div>",'<div class="tag-button-close" style="',t.STYLE_NBODY,'width:15px;height:15px;position:absolute;left:110px;top:10px;"></div>'].join("")).click(function(t){o._onSwitchChat(this,t)}).hover(this._onOverChatTag,this._onOutChatTag),this._onSelectedChatTag(i),i.find("div.tag-button-close").click(function(t){o._onCloseChatTag(this,t)}),this.leftContent.find("li").length>1&&!this.extended.leftElement&&this.toggleExpansion("leftElement",!0),this.leftBody.scrollTop(this.leftBody.scrollHeight()))},removeChatTag:function(t){this.leftContent.find("li."+t).remove(),this.leftContent.find("li").length<=1&&this.extended.leftElement&&this.toggleExpansion("leftElement",!1)},updateChatTag:function(e,i,o){var s,a=this.header.find(".chat-header-icon"),n=this.header.find(".chat-header-name"),l=this.header.find(".chat-header-sign");if(this.leftContent.find("li."+e+" .tag-head-icon").css("background-color",1!==i.status?"#666":"#060"),o!==!0){if(this.leftContent.find("li."+e+" .tag-content-text").html(i.id==t.CON_SINGLE_SESSION?t.lang.toolbar_default_text:i.name),!i.id)return void this.header.find(".chat-header-icon,.chat-header-name,.chat-header-sign").css("visibility","hidden");t.CON_MULTIPLAYER_SESSION===i.logo?i.logo=t.imagemultiplayer:t.CON_SINGLE_SESSION===i.logo&&(i.logo=t.imagesingle),a.css("visibility","visible").css("background-image","none"),a.find("img").length&&a.find("img").attr("src")==i.logo?a.find("img").attr({
"data-single":t.CON_MULTIPLAYER_SESSION!=i.logo?"1":"0",width:"62",height:"62"}).css({margin:"0px ",width:"62px",height:"62px"}):a.html('<img data-single="1" onerror="nTalk.loadImageAbnormal(this, event)" src="'+i.logo+'" border="0" width="62" height="62" style="'+t.STYLE_NBODY+'margin:0px 0px;width:62px;height:62px;background:#fff;border:none;" />'),0===i.status&&t.CON_SINGLE_SESSION!==i.id?a.find("img").css("opacity","0.5"):a.find("img").css("opacity","1"),n.css("visibility","visible").html(i.title||i.name),t.evaluateStarLevel?l.css("display","none"):(s=Math.max(0,this.headerlogo.width()-n.width()-25),l.css("visibility","visible").attr("title",i.sign).css("width",s+"px").html(i.sign))}},switchChatTag:function(e){var i=t("li."+e,this.leftContent);i.length&&this._onSelectedChatTag(i),this._manageMode.callSwitchChat(e)},toggleExpansion:function(e,i){t.inArray(["leftElement","rightElement"],e)===!1&&(e="leftElement"),i=t.isBoolean(i)?i:!this.extended[e],"rightElement"===e?(i?(this[e].css({width:this.options.rightElementWidth+"px",display:"block"}),this.chatWidth=this.options.width+this.options.rightElementWidth):i||(this[e].css({width:this.options.rightElementWidth+"px",display:"none"}),this.chatWidth=this.options.width),this.extended[e]=i,this.chatHeight=this.options.height+this.options.dropHeight,this.chatWidth+=this.extended.leftElement?this.options.leftElementWidth:0):(i?(this.chatWidth=this.options.width+this.options.leftElementWidth,this[e].css("display","block"),this.chatContainter.css("border-bottom-left-radius","0px")):i||(this.chatWidth=this.options.width,this[e].css("display","none"),this.chatContainter.css("border-bottom-left-radius","5px")),this.extended[e]=i,this.chatWidth+=this.extended.rightElement?this.options.rightElementWidth:0),this._objView.minWidth=this.defaultOptions.width+(this.extended.leftElement?this.options.leftElementWidth:0)+(this.extended.rightElement?this.options.rightElementWidth:0),this.headBody.css("width",this.chatWidth+"px"),this.headerlogo.css("width",this.chatWidth-207+"px"),this.body.css("width",this.chatWidth-(this.extended.rightElement?this.options.rightElementWidth:0)+"px"),this._objView.changeAttr(this.chatWidth,this.chatHeight);var o=this.header.find(".chat-header-name"),s=this.header.find(".chat-header-sign");if(t.evaluateStarLevel)s.css("display","none");else{var a=Math.max(0,this.headerlogo.width()-o.width()-25);s.css("visibility","visible").css("width",a+"px")}return this.extended[e]},updateRightData:function(e,i){var o=this,s=!1;return this.settingid=e,i&&i.length?(this._clearTag(),t.each(i,function(t,e){e.data&&e.data.length&&(e.selected===!0&&(s=!0),s||t!=i.length-1||(e.selected=!0),o._addRightLabel(e.title,e.data,i.length,e.selected))}),void this._bindTag()):void this.toggleExpansion("rightElement",!1)},updateViewStatus:function(t){},updataSkin:function(e,i,o){var s,a=/^#[0-9a-f]{6}$/i;if(i=o="#b32424",i==o)if(a.test(i)){var n=t.toHSL(i).l;this.headBody.css({background:i,color:n<.75?"#fff":"#525252"}),this.rightElement.find(".window-right-head").css({background:i,color:n<.75?"#fff":"#525252"})}else this.headBody.css({background:"url("+i+") repeat"}),this.rightElement.find(".window-right-head").css({background:"url("+i+") repeat"});else this.headBody.gradient("top",i,o),this.rightElement.find(".window-right-head").gradient("top",i,o);s=this._manageMode.get(),s&&a.test(e)?s.view.chatElement.find(".chat-view-window-history").css("background-color",e):s&&e&&s.view.chatElement.find(".chat-view-window-history").css("background-image","url("+e+")")},minimize:function(t){this._objView.minimize(t)},maximize:function(t){this._objView.maximize(t)},hidden:function(){this._objView.minimize(null,!0),t.Log("chatManageView.hidden:"+this._objView.containter.css("visibility"),2)},visible:function(){this._objView.maximize(null,!0),t.Log("chatManageView.visible:"+this._objView.containter.css("visibility"),2)},labelFlicker:function(t,i,o){var s=this,a=i?1e3:500;o=o||0,i===e&&this.stopFlicker(t),i?this.leftContent.find("."+t).css({"background-color":"#FE800F"}).addClass("talk_flicker"):this.leftContent.find("."+t).css({"background-color":"#fafafa"}).addClass("talk_flicker"),o>=7||(this._flickerTimeID[t]=setTimeout(function(){o++,s.labelFlicker(t,!i,o)},a))},stopFlicker:function(t){clearTimeout(this._flickerTimeID[t]),this._flickerTimeID[t]=null,this.leftBody.find("."+t).css({"background-color":"#fafafa"}).removeClass("talk_flicker")},_create:function(){function e(){for(var e=(document.getElementById("nTalk_imgCarousel"),t(".nTalk_right_imgCarousel")),i=t(".nTalk_right_imgCarousel").find("li").length,o="",s=0;s<i-1;s++)o+='<span style="margin:0;padding:0;width:6px;height:6px;display:inline-block;margin-right:6px;border-radius:6px;background:url('+t.imageicon+');background-position:-415px -320px;cursor:pointer;" id="nTalk_imgCarousel_dot'+s+'"></span>';t("#nTalk_imgCarousel_dot").html(o),t("#nTalk_imgCarousel_dot").find("span").eq(0).css("background-position","-405px -320px");var a=1,n=!1;carousel=function(o){i<=2||(clearInterval(window.timer2),window.timer2=setInterval(function(){return 1==n?(clearInterval(window.timer),void clearInterval(window.timer2)):void move(e,a*-208,150,function(){for(var o=0;o<t("#nTalk_imgCarousel_dot").find("span").length;o++)t("#nTalk_imgCarousel_dot").find("span").eq(o).css("background-position","-415px -320px");a==i-1?t("#nTalk_imgCarousel_dot0").css("background-position","-405px -320px"):t("#nTalk_imgCarousel_dot"+a).css("background-position","-405px -320px"),a++,i<=a&&(a=1,e.css("left","0px"))})},6e3))},move=function(t,e,i,o){clearInterval(window.timer);var s=e-parseInt(t.css("left"));window.timer=setInterval(function(){var a=e-parseInt(t.css("left")),n=Math.floor(a/i*12),l=parseInt(t.css("left"));s>0?l<e?(n=Math.abs(n)<1?1:n,l+=n,t.css("left",l+"px")):(t.css("left",e+"px"),clearInterval(window.timer),o&&o()):l>e?(n=Math.abs(n)<1?-1:n,l+=n,t.css("left",l+"px")):(t.css("left",e+"px"),clearInterval(window.timer),o&&o())},15)},carousel(),t("#nTalk_imgCarousel").hover(function(){n=!0},function(){n=!1,carousel()});for(var l=t("#nTalk_imgCarousel_dot").find("span"),r=0;r<l.length;r++)l.eq(r).bind("click",function(){a=parseInt(this.id.replace(/nTalk_imgCarousel_dot/,"")),move(e,a*-208,150);for(var i=0;i<t("#nTalk_imgCarousel_dot").find("span").length;i++)t("#nTalk_imgCarousel_dot").find("span").eq(i).css("background-position","-415px -320px");t("#nTalk_imgCarousel_dot").find("#nTalk_imgCarousel_dot"+a).css("background-position","-405px -320px")})}var i=this,o=t.extend({},this.options,{width:this.options.width,height:this.options.height+this.options.dropHeight,minWidth:this.defaultOptions.minWidth,minHeight:this.defaultOptions.minHeight});t.themesURI&&(t.imageicon=t.themesURI+"chaticon."+(t.browser.msie6?"gif":"png"),t.require([t.imageicon],function(e){e.error&&t.Log("cache chat icon failure",3)})),this._objView=new t.Window(t.extend({onChanage:function(t){i._callResize.call(i,t)},onClose:function(){i._callClose.call(i)},onMinimize:function(){i._callMinimize.call(i)},onMaximize:function(){i._callMaximize.call(i)},onMaxResize:function(){i._callMaxResize.call(i)}},o)),this.header=this._objView.header,this.body=this._objView.body,this.chatWidth=this.options.width,this.chatHeight=this.options.height+this.options.dropHeight,this._objView.buttonClose.hover(function(){t(this).css("background-position","-392px -257px")},function(){t(this).css("background-position","-392px -226px")}).attr("title",t.lang.chat_button_close).css({height:"24px",width:"24px",margin:"20px 5px 0 0",background:"url("+t.imageicon+") no-repeat -392px -226px"}),this._objView.buttonResize&&this._objView.buttonResize.css({width:"12px",height:"15px",background:"url("+t.imageicon+") no-repeat -298px -5px"}),this._objView.buttonMax.hover(function(e){var i=t(this).css("background-position").split(" ").shift();t(this).css("background-position",i+" -257px")},function(e){var i=t(this).css("background-position").split(" ").shift();t(this).css("background-position",i+" -226px")}).css({height:"24px",width:"24px",margin:"20px 5px 0 0",background:"url("+t.imageicon+") no-repeat -361px -226px"}).attr("title",t.lang.chat_button_resize_max),this._objView.buttonMin.hover(function(){t(this).css("background-position","-299px -257px")},function(){t(this).css("background-position","-299px -226px")}).css({width:"24px",height:"24px",margin:"20px 5px 0 0",background:"url("+t.imageicon+") no-repeat -299px -226px"}).attr("title",t.lang.chat_button_min),t(".ntalk-window-containter").css("height","564px").css("border-top-right-radius","5px").css("border-top-left-radius","5px"),this.headBody=t({className:"chat-header-body",style:t.STYLE_BODY+"background:#b32424;z-index:0;color:#525252;"}).appendTo(this.header,!0).css({position:"absolute","border-bottom":"0",top:"24px","box-shadow":"0px px  2px 2px  rgba(7,0,2,0.35)  inset","border-radius":"5px 5px 0px 0px","-moz-border-radius":"5px 5px 0px 0px","-webkit-border-radius":"5px 5px 0px 0px",width:this.options.width+"px",height:this.options.dropHeight-24+"px"}),this.headerlogo=t({tag:"div",className:"chat-header-logo",style:t.STYLE_BODY+"color:#ffff;margin:0;float:left;height:21px;line-height:20px;position:absolute;left:102px;top:12px;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;width:200px;"}).appendTo(this.headBody),this.headName=t({tag:"span",className:"chat-header-name",style:t.STYLE_BODY+"color:#ffffff;margin:0;display:inline-block;float:left;height:20px;line-height:20px;max-width:220px;visibility:hidden;overflow:hidden;font-weight:normal;cursor:auto;font-size:20px;color:#fff;margin-right:10px;"}).appendTo(this.headerlogo).html(""),t({tag:"span",style:t.STYLE_BODY+"background:rgba(255,255,255, 0.5);width:1px;height:21px;float:left;display:inline-block;margin-right:10px;"}).appendTo(this.headerlogo),this.headSign=t({tag:"span",className:"chat-header-sign",style:t.STYLE_BODY+"color:#c3c3c3;margin:0;display:inline-block;float:left;height:20px;line-height:22px;visibility:hidden;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;cursor:auto;color:#e5a9a9;"}).appendTo(this.headerlogo),this.headIcon=t({tag:"div",className:"chat-header-icon",style:t.STYLE_NBODY+"visibility:hidden;border-radius:0px;overflow:hidden;background:url("+t.imageicon+");background-repeat:no-repeat;background-position:-374px 0; background-color:#ffffff;position:absolute;left:30px;top:0px;width:"+this.CON_ICON_WIDTH+"px;height:"+this.CON_ICON_HEIGHT+"px;border:none;z-index:1;"}).appendTo(this.header,!0),this.chatBody=this._objView.chatBody,this.leftElement=t({className:"body-chat-tags",style:t.STYLE_NBODY+"display:none;float:left;background:#fafafa;overflow:hidden;"}).css({"border-left":"1px solid #5f6467","border-bottom":"1px solid #5f6467","border-radius":"0px 0px 0px 5px",width:this.options.leftElementWidth-1+"px",height:this.options.height-1+"px"}).appendTo(this.chatBody),this.chatContainter=t({className:"body-chat-containter",style:t.STYLE_NBODY+"float:left;overflow:hidden;background:#fff;"}).css({"border-radius":"0px 0px 0px 5px","border-left":"1px solid #ddd","border-bottom":"1px solid #ddd","border-right":"1px solid #ddd","-moz-border-radius":"0px 0px 0px 5px","-webkit-border-radius":"0px 0px 0px 5px",width:+this.options.width-2+"px",height:+this.options.height-1+"px"}).appendTo(this.chatBody),t({style:t.STYLE_NBODY+"clear:both;"}).appendTo(this.chatBody),this.rightElement=this._objView.rightElement.css({width:this.options.rightElementWidth+"px"}),this.imgCarousel=t({className:"nTalk_imgCarousel",style:t.STYLE_BODY+"margin:0;padding:0;width:206px;height:278px;float:left;border-left:1px solid #ddd;border-right:1px solid #ddd;position:relative;overflow:hidden;background:#fff;"}).appendTo(this.rightElement),callbacknameCarousel="callback_"+t.randomChar(),queryStringCarousel=t.toURI({position:350,callback:callbacknameCarousel}),window[callbacknameCarousel]=function(i){var o,s=[];if("success"==i.msg){if(i.data.length>0){o=i.data.length>=6?6:i.data.length;for(var a=0;a<o;a++)s.push('<li style="margin:0;padding:0;list-style:none;float:left;width:208px;height:278px;overflow:hidden;"><a href="'+i.data[a].url+'"><img style="display:block;border:none;outline:none;" name="'+i.data[a].name+'" title="'+i.data[a].name+'" src="'+i.data[a].img+'" /></a></li>'),a>=o-1&&s.push('<li style="margin:0;padding:0;list-style:none;float:left;width:208px;height:278px;overflow:hidden;"><a href="'+i.data[0].url+'"><img style="display:block;border:none;outline:none;" name="'+i.data[0].name+'" title="'+i.data[0].name+'" src="'+i.data[0].img+'" /></a></li>')}var n='<ul class="nTalk_right_imgCarousel" style="width:'+208*(o+1)+'px;margin:0;padding:0;list-style:none;height:278px;overflow:hidden;position:absolute;left:0;top:0;">'+s.join("")+"</ul>";t(".nTalk_imgCarousel").html(n),t({id:"nTalk_imgCarousel_dot",style:t.STYLE_BODY+"width:100%;height:10px;position:absolute;left:0;bottom:10px;text-align:center;line-height:10px;filter:alpha(opacity=80); -moz-opacity:0.8; -khtml-opacity: 0.8; opacity: 0.8;"}).appendTo(".nTalk_imgCarousel"),e()}},t.require("https://api-service.wbiao.com/ad/ntalk/?"+queryStringCarousel+"#rnd"),this.rightBody=t({className:"window-right-body",style:t.STYLE_BODY+"width:207px;background:#fff;overflow:hidden;float:left;border-right:1px solid #ddd;border-bottom:1px solid #ddd;"}).css({height:+this.options.height-279+"px","border-radius":"0px 0px 5px 0px","-moz-border-radius":"0px 0px 5px 0px","-webkit-border-radius":"0px 0px 5px 0px"}).appendTo(this.rightElement),this.buttonScrollTop=t({tag:"div",className:"nTalk-scroll-top",style:t.STYLE_NBODY+"height:20px;width:100%;z-index:99;background:url("+t.imageicon+") no-repeat 20px -92px;display:block;cursor:pointer;"}).appendTo(this.leftElement),this.leftBody=t({tag:"div",className:"nTalk-scroll-body",style:t.STYLE_NBODY+"overflow:hidden;height:424px;"}).appendTo(this.leftElement),this.leftContent=t({tag:"ul",className:"ntalke-scroll-content",style:t.STYLE_NBODY}).appendTo(this.leftBody),this.buttonScrollBottom=t({tag:"div",className:"nTalk-scroll-bottom",style:t.STYLE_NBODY+"height:20px;width:100%;z-index:99;background:url("+t.imageicon+") no-repeat 20px -108px;display:block;cursor:pointer;"}).appendTo(this.leftElement)},_bind:function(){var e=this;this.buttonScrollTop.click(function(t){e._verificationScroll(!0)&&e.leftBody.scrollTop(e.leftBody.scrollTop()-40)}).hover(function(i){e._verificationScroll(!0)&&t(this).css("background-position","-79px -92px")},function(e){t(this).css("background-position","20px -92px")}),this.buttonScrollBottom.click(function(t){e._verificationScroll(!1)&&e.leftBody.scrollTop(e.leftBody.scrollTop()+40)}).hover(function(i){e._verificationScroll(!1)&&t(this).css("background-position","-79px -108px")},function(e){t(this).css("background-position","20px -108px")})},_onOverChatTag:function(e){for(var i=this;"LI"!==i.tagName.toUpperCase();)i=i.parentNode;t(i).find(".tag-button-close").css({background:"url("+t.imageicon+") no-repeat -159px -39px"}),t(i).indexOfClass("talk_flicker")||t(i).css({"border-top":"1px solid #ccc","border-bottom":"1px solid #ccc","border-left":"1px solid #ccc",left:"1px",background:"#fff"})},_onOutChatTag:function(){for(var e=this;"LI"!==e.tagName.toUpperCase();)e=e.parentNode;t(e).find(".tag-button-close").css({background:"none"}),t(e).indexOfClass("talk_flicker")||t(e).indexOfClass("talk_selected")||t(e).css({"border-top":"1px solid #fafafa","border-bottom":"1px solid #fafafa","border-left":"1px solid #fafafa",left:"0px",background:"#fafafa"})},_onSelectedChatTag:function(e){var i=this;t("li",this.leftContent).each(function(e,o){t(o).removeClass("talk_selected"),t(o).indexOfClass("talk_flicker")||i._onOutChatTag.apply(o)}),this.stopFlicker(t(e).attr("key")),t(e).addClass("talk_selected").css({"border-top":"1px solid #ccc","border-bottom":"1px solid #ccc","border-left":"1px solid #ccc",left:"1px",background:"#fff"})},_callResize:function(e){var i=e.width,o=e.height;t(".ntalk-window-containter").css("height",o+"px"),this.extended.leftElement&&(i-=this.options.leftElementWidth),this.extended.rightElement&&(i-=this.options.rightElementWidth),this.options.width=i,this.options.height=o-this.options.dropHeight,this.headBody.css("width",e.width+"px"),this.body.css("width",this.options.width+(this.extended.leftElement?this.options.leftElementWidth:0)+"px"),this.leftElement.css({width:this.options.leftElementWidth-1+"px",height:this.options.height-1+"px"}),this.leftBody.css("height",this.options.height-40+"px"),this.chatContainter.css({width:this.options.width-2+"px",height:this.options.height-1+"px"}),this.messageElement=this.chatContainter.find(".chat-view-message"),this.messageElement.css("height",this.options.height-2+"px"),this.chatContainter.find(".chat-view-message-table-iframe").css("height",this.options.height+"px"),this.rightBody.css({height:this.options.height-279+"px"});var s=this.options.height-29;this.rightElement.find(".view-right-content").css({height:s-276+"px"}),this.rightElement.find(".window-right-content iframe").attr("height",s).css({height:s-278+"px"}),this._manageMode.callManageResize(this.options.width,this.options.height)},_callMaxResize:function(){var e=this.options.height<this.defaultOptions.resizeHeight;this.chatHeight=this.options.dropHeight+(e?this.defaultOptions.resizeHeight:this.defaultOptions.height),this._objView.changeAttr(this.chatWidth,this.chatHeight),e?this._objView.buttonMax.css("background-position","-330px -226px").attr("title",t.lang.chat_button_resize_min):this._objView.buttonMax.css("background-position","-361px -226px").attr("title",t.lang.chat_button_resize_max),this._callResize({width:this.chatWidth,height:this.chatHeight})},_callMaximize:function(){},_callClose:function(){this._manageMode.close()},_callMinimize:function(){this._manageMode.callMinimize()},_onSwitchChat:function(e,i){var o=t(e).attr("key");t.Event.fixEvent(i).stopPropagation(),this._onSelectedChatTag(e),this._manageMode.callSwitchChat(o)},_onCloseChatTag:function(e,i){var o,s=e;for(t.Event.fixEvent(i).stopPropagation();"LI"!==s.tagName.toUpperCase();)s=s.parentNode;t(s).removeClass("talk_selected"),o=s.className.replace(/^\s*|\s*$/g,"")||"",this._manageMode.closeChat(o)},_getChatPosition:function(e){var i,o;if(!e||t.isEmptyObject(e))this.options.left=Math.max(0,t(window).width()-this.options.width),this.options.top=Math.max(0,t(window).height()-this.options.height-this.options.dropHeight);else if(e.rightline&&e.width)this.options.left=Math.max(0,(t(window).width()-e.width)/2+e.width-this.options.width),this.options.top=Math.max(0,t(window).height()-this.options.height-this.options.dropHeight);else if((e.id||e.entryid)&&t.isDefined(e.left)&&t.isDefined(e.left))o=e.id||e.entryid||"",o=/(^[#\.])|\s+/gi.exec(o)?o:"#"+o,t(o).length?(i=t(o).offset(),e.left=e.left||0,e.top=e.top||0,this.options.left=Math.min(i.left-this.options.width+e.left,t(window).width()-this.options.width),this.options.top=Math.min(i.top+e.top,t(window).height()-this.options.height-this.options.dropHeight)):(this.options.left=Math.max(0,t(window).width()-this.options.width),this.options.top=Math.max(0,t(window).height()-this.options.height-this.options.dropHeight));else{switch(e.position){case"left-top":this.options.left=0,this.options.top=0;break;case"center-top":this.options.left=Math.max(0,(t(window).width()-this.options.width)/2),this.options.top=0;break;case"right-top":this.options.left=Math.max(0,t(window).width()-this.options.width),this.options.top=0;break;case"left-center":this.options.left=0,this.options.top=Math.max(0,(t(window).height()-this.options.height-this.options.dropHeight)/2);break;case"center-center":this.options.left=Math.max(0,(t(window).width()-this.options.width)/2),this.options.top=Math.max(0,(t(window).height()-this.options.height-this.options.dropHeight)/2);break;case"right-center":this.options.left=Math.max(0,t(window).width()-this.options.width),this.options.top=Math.max(0,(t(window).height()-this.options.height-this.options.dropHeight)/2);break;case"left-bottom":this.options.left=0,this.options.top=Math.max(0,t(window).height()-this.options.height-this.options.dropHeight);break;case"center-bottom":this.options.left=Math.max(0,(t(window).width()-this.options.width)/2),this.options.top=Math.max(0,t(window).height()-this.options.height-this.options.dropHeight);break;default:this.options.left=Math.max(0,t(window).width()-this.options.width),this.options.top=Math.max(0,t(window).height()-this.options.height-this.options.dropHeight)}this.options.left+=e.xoff||0,this.options.top+=e.yoff||0}this.options.left=Math.min(Math.max(this.options.left,0),t(window).width()-this.options.width),this.options.top=Math.min(Math.max(this.options.top,0),t(window).height()-this.options.height-this.options.dropHeight)},_verificationScroll:function(t){var e=this.leftBody.scrollHeight()-this.leftBody.height();return!!(t&&e>0&&self.leftBody.scrollTop()>0)||!t&&e>0&&e>this.leftBody.scrollTop()},_addRightLabel:function(e,i,o,s){var a,n,l,r,h=this,d=/^https?:\/\/(.*?)/gi,c=t.randomChar(),p=this.options.height-33;if(this.rightTags||(this.rightTags=t({className:"window-right-tags",style:t.STYLE_NBODY+"background:#fff;z-index:-1;overflow:hidden;height:31px;border-top:1px solid #e4e4e4;"}).appendTo(this.rightBody),this.rightTags.insert('<div style="'+t.STYLE_NBODY+'clear:both;"></div>')),this.rightContent||(this.rightContent=t({className:"window-right-content",style:t.STYLE_NBODY+"overflow:hidden;background:#fff;position:relative;top:-1px;z-index:1;border-radius:0px 0px 5px 0px;-moz-border-radius:0px 0px 5px 0px;-webkit-border-radius:0px 0px 5px 0px"}).appendTo(this.rightBody)),n=t.STYLE_BODY+"background-color:#fff;height:29px;line-height:29px;text-align:center;cursor:pointer;border-bottom:1px solid #e4e4e4;float:left;",n+=1==o?"width:206px;":1==this.rightTags.find("div").length?"width:"+(2==o?103:67)+"px;border-right:1px solid #D5D5D5;":this.rightTags.find("div").length<o?"width:"+(2==o?103:67)+"px;border-right:1px solid #D5D5D5;":"width:"+(2==o?103:67)+"px;",e.indexOf("售后服务")>-1&&(e="售后服务点"),l=t({className:c,title:e,style:n}).appendTo(this.rightTags,this.rightTags.find("div").last()).html(e),r=this.rightContent.insert(['<div class="',c,' view-right-content" style="',t.STYLE_BODY,"background-color:#fff;width:100%;height:"+p+'px;overflow-x:hidden;overflow-y:auto;display:none;border-radius:0px 0px 5px 0px;-moz-border-radius:0px 0px 5px 0px;-webkit-border-radius:0px 0px 5px 0px"></div>'].join("")),t.isArray(i)){a=t({tag:"ul",style:t.STYLE_BODY+"margin:10px 0 10px 30px;list-style:disc;background-color:#fff;"}).appendTo(r).click(function(e){var i=t.Event.fixEvent(e).target;if("li"===i.tagName.toLowerCase()){var o=t(i).attr("talk_title"),s=t(i).attr("talk_content");h._manageMode.showFAQ(h.settingid,o,s)}});for(var g=0;g<i.length;g++)t({tag:"li",talk_title:i[g].title,talk_content:i[g].con,title:t.clearHtml(i[g].con||""),style:t.STYLE_BODY+"list-style:none;margin-top:5px;cursor:pointer;background-color:#fff;color:#666;font-size:12px;position:relative;"}).appendTo(a).html(t.clearHtml(i[g].title||"")).insert('<span style="display:block;width:4px;height:4px;position:absolute;left:-10px;top:5px;background:url('+t.imageicon+') no-repeat -392px -320px;border-radius:4px;"></span>')}else d.test(i)?(i+=(i.indexOf("?")==-1?"?":"&")+t.toURI({lan:t.extParmas.lan,sellerid:this._manageMode.sellerid,userid:t.user.id,exparams:t.global.exparams||""}),t({className:"window-right-iframe",tag:"iframe",width:"100%",frameborder:"0",height:p,scrolling:"auto",style:t.STYLE_NBODY+"width:100%;height:"+p+"px;"}).appendTo(r.css("overflow-y","hidden")).attr("src",i)):e.indexOf("售后服务")>-1?(e="售后服务点",getgetprovince=function(){var e={url:"https://api-service.wbiao.com/api/xiaoneng/getProvinceList",dataType:"json",crossDomain:!0,success:function(e){for(var i=0;i<e.length;i++)t({tag:"option",value:e[i].provinceCode}).appendTo(".nTalk-getprovince").insert(e[i].provinceName)},error:function(e){t.Log(e)}};t({tag:"option",value:"",selected:"true"}).appendTo(".nTalk-getprovince").insert("省份/直辖市"),h._ajax.ajax(e),getcity("")},getcity=function(e){if(""==e)t({tag:"option",value:""}).appendTo(".nTalk-getcity").insert("城市");else{t({tag:"option",value:"",selected:"true"}).appendTo(".nTalk-getcity").insert("城市");var i={url:"https://api-service.wbiao.com/api/xiaoneng/getCityList?provinceCode="+e,dataType:"json",crossDomain:!0,success:function(e){for(var i=0;i<e.length;i++)t({tag:"option",value:e[i].cityCode}).appendTo(".nTalk-getcity").insert(e[i].cityName)},error:function(e){t.Log(e)}};h._ajax.ajax(i)}getstore("")},getstore=function(e){if(""==e)t({tag:"option",value:"",selected:"true"}).appendTo(".nTalk-getstore").insert("合作维修点");else{t({tag:"option",value:"",selected:"true"}).appendTo(".nTalk-getstore").insert("合作维修点");var i={url:"https://api-service.wbiao.com/api/xiaoneng/getShopList?cityCode="+e,dataType:"json",crossDomain:!0,success:function(e){for(var i=0;i<e.length;i++)t({tag:"option",value:e[i].shopName+"+ntalk"+e[i].address+"+ntalk"+e[i].phone}).appendTo(".nTalk-getstore").insert(e[i].shopName)},error:function(e){t.Log(e)}};h._ajax.ajax(i)}},t({className:"window-right-text",style:t.STYLE_BODY+"margin:5px;word-wrap:break-word;overflow:hidden;"}).appendTo(r),t({className:"nTalk-getprovince",tag:"select",value:"省",style:"margin:0;padding:0;width:176px;height:28px;border:1px solid #e4e4e4;color:#666;margin-bottom:10px;margin-left:10px;outline:none;display:block;float:left;border-radius:3px;"}).appendTo(".window-right-text"),t({className:"nTalk-getcity",tag:"select",style:"margin:0;padding:0;width:176px;height:28px;border:1px solid #e4e4e4;color:#666;margin-bottom:10px;margin-left:10px;outline:none;display:block;float:left;border-radius:3px;"}).appendTo(".window-right-text"),t({className:"nTalk-getstore",tag:"select",style:"margin:0;padding:0;width:176px;height:28px;border:1px solid #e4e4e4;color:#666;margin-bottom:10px;margin-left:10px;outline:none;display:block;float:left;border-radius:3px;"}).appendTo(".window-right-text"),t({className:"nTalk-storeDetial",tag:"div",style:"margin:0;padding:0;width:176px;height:auto;overflow:hidden;border-top:1px dashed #e4e4e4;float:left;margin-left:10px;float:left;padding-top:10px;"}).appendTo(".window-right-text"),getgetprovince(),t(".nTalk-getdetial").bind("click",function(){}),t(".nTalk-getprovince").bind("change",function(){t(".nTalk-storeDetial").find("*").remove(),t(".nTalk-getcity").find("*").remove(),t(".nTalk-getstore").find("*").remove(),getcity(this.value)}),t(".nTalk-getcity").bind("change",function(){t(".nTalk-storeDetial").find("*").remove(),t(".nTalk-getstore").find("*").remove(),getstore(this.value)}),t(".nTalk-getstore").bind("change",function(){t(".nTalk-storeDetial").find("*").remove();var e=t(".nTalk-getstore").get(0).value.split("+ntalk"),i=[];if(e.length>0){for(var o=0;o<e.length;o++)i.push("<span>"+e[o]+"</span><br/>");t(".nTalk-storeDetial").html(i.join(""))}})):t({className:"window-right-text",style:t.STYLE_BODY+"margin:5px;word-wrap:break-word"}).appendTo(r).html(i);return s&&this._selectedTag(l),l},_bindTag:function(){var t=this;this.rightTags&&this.rightTags.find("[class]").click(function(){t._selectedTag(this)})},_selectedTag:function(e){var i=this;this.rightTags.find("[class]").each(function(o,s){var a=t.myString(s.className.replace("talk_selected","")).trim();t(e).indexOfClass(a)?(t(s).addClass("talk_selected").css({height:"30px","border-bottom":"none",background:"#fff","font-weight":"bold"}),i.rightContent.find("."+a).display(1)):(t(s).removeClass("talk_selected").css({height:"29px","border-bottom":"1px solid #e4e4e4",background:"#fbfafa","font-weight":"normal"}),i.rightContent.find("."+a).display())})},_clearTag:function(){this.rightBody.find("*").remove(),this.rightTags=null,this.rightContent=null},_ajax:{createXHR:function(){try{return new window.XMLHttpRequest}catch(t){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}}},xmlrequest:function(){var t=this.createXHR();return t?"withCredentials"in t?t:window.XDomainRequest===n?t:(t=new XDomainRequest,t.readyState=0,t.status=100,t.onreadystatechange=s,t.onload=function(){t.readyState=4,t.status=200;var e=new ActiveXObject("Microsoft.XMLDOM");e.async="false",e.loadXML(t.responseText),t.responseXML=e,t.response=t.responseText,t.onreadystatechange()},t.ontimeout=t.oerror=function(){t.readyState=4,t.status=500,t.onreadystatechange()},t):t},ajax:function(t){var e=function(){},i=t.dataType||"text",o=t.success||e,s=t.error||e,a=t.load||e,n=this.xmlrequest();if(!n)return s("no xhr"),null;var l=function(){var e;if(4===n.readyState){var l=n.status||0;if(200===l){if("json"===i){try{e=JSON.parse(n.responseText),o(e,n)}catch(r){s(n.responseText,n,"response to json exception")}return}return void o(n.responseText,n)}if("json"===i){try{e=JSON.parse(n.responseText),s(e,n)}catch(r){s(n.responseText,n,"response to json exception")}return}o(n.responseText,n,"Server exception")}t.load&&/^(0|1|2|3)$/i.test(n.readyState)&&a(n.responseText,n,"Server exception")};if(n.onreadystatechange=l,t.responseType){if("undefined"==typeof n.responseType)return s("",n,"Browser does not support setting response type"),null;n.responseType=t.responseType}var r=t.headers||{};t.crossDomain||r["X-Requested-With"]||(r["X-Requested-With"]="XMLHttpRequest");var h=t.type||"GET";try{n.open(h,t.url)}catch(d){}var c=t.data||null;try{n.send(c)}catch(d){}return n}}},"undefined"==typeof t.ntView&&(t.ntView={chatView:l,minimizeView:r,chatManageView:h})}(nTalk);
/* @file chat.js
 * @date 2018.09.12 19:11:34 
 */
!function(t,e){var i=/[\r\n]/gi,s=function(){};t.extend({default_connect_robot:!0}),t.Capture={udCapCtl:null,setupFrame:null,version:"1.6.1",mimeType:"application/xiaonengcapture-plugin",license:"C35F3907AADCC3BB0FEB1DAC6866D806A0DAA7C07A001D97E14ECFBE1D27CC99891F79A7D86AA9CCAFF6B24C1CC1BA89143E5F61849BCC87E12ED104A23B4F980EDCEBE5471FEDE121826153381CC7A3E040D9D5374D13A587BE7B4011FCA44C6E849C8717E483905FB038986FC7F8376E849C8717E483905FB038986FC7F837310A71452C349CA1EB060B439E6535037D30D63B4FEE80AB2C8102DFC48E0C486E849C8717E483905FB038986FC7F8376E849C8717E483905FB038986FC7F8376E849C8717E483905FB038986FC7F837",setup:"setup/Xiaonengcapture.msi",inited:!1,loaded:!1,callback:null,supportActiveX:!1,captureWithMin:!0,init:function(e){this.inited&&e||(this.inited=!0,t.Log("filetranserver:"+e),this.id="setFrame-"+t.randomChar(),this.name=this.id,this.PostUrl=e+"/imageupload.php?"+t.toURI({action:"uploadimage",siteid:t.global.siteid,roomid:"t2d",type:"json",charset:t.charset}),this.supportActiveX=void 0!==window.ActiveXObject,(this.supportActiveX&&"Win64"==window.navigator.platform||"x64"==window.navigator.cpuClass)&&(this.setup="setup/Xiaonengcapture64.msi"),this.loaded=!1,this.udCapCtlSpan=t({tag:"div",className:"nTalk-hidden-element",id:"udCapSpan",style:t.STYLE_NBODY+"left:-1000px;top:-1000px;"}).appendTo(!0),this.setupFrame=t({tag:"iframe",className:"nTalk-hidden-element",id:this.id,src:"",style:"display:none;"}).appendTo(!0))},start:function(e,i,n){t.Log("nTalk.Capture.start("+e+", "+i+", callback)");var a=this;this.settingid=e,this.callback=n||s;var o=navigator.userAgent.match(/Chrome\/([0-9]+)/);o&&o.length>=2&&o[1]>=42?alert(t.lang.capture_forbidden):t.Capture.installCheck()&&(this.captureWithMin&&t.chatManage.view.hidden(),setTimeout(function(){(a.supportActiveX||a.loaded)&&a.doCapture(i)},300))},doCapture:function(e){if(e&&this.udCapCtl.StartCapture)this.udCapCtl.StartCapture();else try{this.udCapCtl.Capture()}catch(e){this.udCapCtl&&this.udCapCtl.StartCapture?this.udCapCtl.StartCapture():(t.chatManage.view.visible(),alert(t.lang.capture_reload))}},hasVersion:function(t){"v"==t.substring(0,1)&&(t=t.substring(1,t.length));var e=this.version.split("."),i=t.split(".");return parseInt(e[0])>parseInt(i[0])||(parseInt(e[0])==parseInt(i[0])&&parseInt(e[1])>parseInt(i[1])||parseInt(e[0])==parseInt(i[0])&&parseInt(e[1])==parseInt(i[1])&&parseInt(e[2])>parseInt(i[2]))},addEvent:function(t,e,i){if(this.udCapCtl.attachEvent)this.udCapCtl.attachEvent(t,e);else{var s=e.name||e.toString().match(/^function\s?([^\s(]*)/)[1]||i,n=e.toString().substring(e.toString().indexOf("("),e.toString().indexOf(")")+1),a=document.createElement("script");a.setAttribute("for",this.udCapCtl.id),a.event=t+n,a.appendChild(document.createTextNode(s+n+";")),document.body.appendChild(a)}},_onBeforeCapture:function(){t.Log("Capture._onBeforeCapture",2)},_onCaptureCanceled:function(){t.Log("Capture._onCaptureCanceled"),t.chatManage.view.visible()},_onCaptureCompleted:function(e){t.Log("Capture._onCaptureCompleted("+e+")"),t.chatManage.view.visible()},_onBeforeUpload:function(e,i){t.Log("Capture._onBeforeUpload("+e+", "+i+")")},_onUploadCompleted:function(e){t.Log('Capture._onUploadCompleted("'+e+'")');var i,s=t.Capture,n=500;try{i=t.JSON.parseJSON(e)}catch(s){e=e.substring(e.indexOf("{"),e.indexOf("}")+1);try{i=t.JSON.parseJSON(e)}catch(t){return}}!1===s.callback.call()&&(n=0),s._callback("fIM_startSendFile",["","uploadimage",i.oldfile]),setTimeout(function(){s._callback("fIM_receiveUploadSuccess",["","uploadimage",i])},n)},_onUploadFailed:function(e){t.Log("Capture._onUploadFailed("+e+")",2)},_callback:function(e,i){i.push(this.settingid),t.hasOwnProperty(e)?t[e].apply(this,i):t.Log("nTalk."+e+"(...)",2)},installCheck:function(){if(this.loaded=!1,this.udCapCtl&&(this.loaded=!0),this.supportActiveX){if(t("#udCapSpan").html('<object id="udCaptureCtl" width="0" height="0" classid="CLSID:0FAE7655-7C34-4DEE-9620-CD7ED969B3F2"></object>'),this.udCapCtl=t("#udCaptureCtl").get(0),void 0===this.udCapCtl.PostUrl)return confirm(t.lang.capture_install)?(t("#udCapSpan").html(""),this.udCapCtl=null,this.startSetup()):(t("#udCapSpan").html(""),this.udCapCtl=null),!1;if(this.hasVersion(this.udCapCtl.GetVersion()))return confirm(t.lang.capture_activex_update)&&this.startSetup(),!1;this.udCapCtl.PostUrl=this.PostUrl,this.udCapCtl.License=this.license,this.addEvent("OnBeforeCapture",nTalk.Capture._onBeforeCapture,"nTalk.Capture._onBeforeCapture"),this.addEvent("OnCaptureCanceled",nTalk.Capture._onCaptureCanceled,"nTalk.Capture._onCaptureCanceled"),this.addEvent("OnCaptureCompleted",nTalk.Capture._onCaptureCompleted,"nTalk.Capture._onCaptureCompleted"),this.addEvent("OnBeforeUpload",nTalk.Capture._onBeforeUpload,"nTalk.Capture._onBeforeUpload"),this.addEvent("OnUploadCompleted",nTalk.Capture._onUploadCompleted,"nTalk.Capture._onUploadCompleted"),this.addEvent("OnUploadFailed",nTalk.Capture._onUploadFailed,"nTalk.Capture._onUploadFailed"),this.loaded=!0}else if(navigator.plugins){var e=navigator.mimeTypes&&navigator.mimeTypes[this.mimeType]?navigator.mimeTypes[this.mimeType].enabledPlugin:0;if(e){var i="v1.0.0",s=e.description.split(" ");if("v"==s[s.length-1].substring(0,1)&&(i=s[s.length-1]),this.hasVersion(i))return confirm(t.lang.capture_other_update)&&this.startSetup(),!1;t("#udCapSpan").html('<embed id="udCaptureCtl" width="0" height="0" type="'+this.mimeType+'"></embed>'),this.udCapCtl=t("#udCaptureCtl").get(0),this.udCapCtl.PostUrl=this.PostUrl,this.udCapCtl.License=this.license,this.udCapCtl.OnBeforeCapture="nTalk.Capture._onBeforeCapture",this.udCapCtl.OnCaptureCanceled="nTalk.Capture._onCaptureCanceled",this.udCapCtl.OnCaptureCompleted="nTalk.Capture._onCaptureCompleted",this.udCapCtl.OnBeforeUpload="nTalk.Capture._onBeforeUpload",this.udCapCtl.OnUploadCompleted="nTalk.Capture._onUploadCompleted",this.udCapCtl.OnUploadFailed="nTalk.Capture._onUploadFailed",this.loaded=!0}!this.loaded&&confirm(t.lang.capture_install)&&this.startSetup()}return this.loaded},startSetup:function(){this.setupFrame.attr("src",t.baseURI+this.setup)}},t.extend({CON_SINGLE_SESSION:"SINGLE",CON_MULTIPLAYER_SESSION:"MULTIPLAYER",imageicon:"",imagebg:"",imagesingle:"",imagemultiplayer:"",loadImageAbnormal:function(e,i){if("ntalk-enterprise-logo"==t(e).attr("data-type"))e.src=t.sourceURI+"images/blank.gif";else try{var s=t(e).parent().width(),n=t(e).parent().height();t(e).css({margin:"0px"}).attr({width:s,height:n,src:"1"==t(e).attr("data-single")?t.imagesingle:t.imagemultiplayer})}catch(e){t.Log("img parent is null",2)}},imgScrollBottom:function(){var e=nTalk.global.settingid;nTalk.chatManage.get(e)&&!/^guest/.test(t.global.shortid)&&t.flashserver.history_version&&2!=t.flashserver.history_version?nTalk.chatManage.get(e).view.scroll.scrollBottom():setTimeout(function(){/^guest/.test(t.global.shortid)&&t.flashserver.history_version&&2!=t.flashserver.history_version&&nTalk.chatManage.get(e)&&nTalk.chatManage.get(e).view.scroll.scrollBottom()},500)},zoom:function(e,i,s){var n,a,o={width:i,height:s};return e&&e.width?(n=e.width>i?i:e.width,(a=n/e.width*e.height)>s&&(n=(a=s)/e.height*e.width),t.extend(o,{width:n,height:a})):o},entityList:{"&":"&amp;","<":"&lt;","＜":"&lt;",">":"&gt;","＞":"&gt;","＆":"&amp;","©":"&copy;","®":"&reg;",'"':"&quot;","'":"&apos;","＂":"&quot;"},charFilter:function(e){var i,s,n=function(e){for(var i in t.entityList)"function"!=typeof t.entityList[i]&&(e=e.replace(new RegExp(""+i,"g"),t.entityList[i]));return e};if(t.isArray(e))for(i=[],s=0;s<e.length;s++)"object"==typeof e[s]?i[s]=t.charFilter(e[s]):"string"==typeof e[s]?i[s]=n(e[s]):i[s]=e[s];else if("object"==typeof e){i={};for(s in e)"function"!=typeof e[s]&&("object"==typeof e[s]?i[s]=t.charFilter(e[s]):"string"==typeof e[s]?i[s]=n(e[s]):i[s]=e[s])}else i=n(e);return i}}),t.chatConnect=t.Class.create(),t.chatConnect.prototype={name:"chatConnect",debug:!1,options:null,switchTimeId:null,error:!1,initialize:function(e,i){this.debug&&t.Log("create chatConnect()",1),this.options=t.extend({devicetype:t.browser.mobile?3:0,chattype:"0",chatvalue:"0"},t.whereGet(e,["requestRobot","siteid","settingid","tchatmqttserver","tchatgoserver","surl","cid","u","n","sid","groupid","rurl","statictis","htmlsid","connectid","userlevel","disconnecttime","mini","chattype","chatvalue","edu_invisitid","edu_visitid","usertag","userrank","leftchat","startType"],["requestRobot","siteid","settingid","tchatmqttserver","tchatgoserver","serverurl","machineID","userid","username","sessionid","destid","resourceurl","statictis","htmlsid","connectid","userlevel","disconnecttime","mini","chattype","chatvalue","edu_invisitid","edu_visitid","usertag","userrank"])),this.options.requestRobot&&t.Robot?(t.global.connect="robot",this._createRobotConnect()):(t.browser.supportMqtt||t.flash.support)&&this.options.tchatmqttserver&&1==t.server.tchatConnectType?(t.Log("mqtt connect."),t.global.connect="mqtt",this._createMqttConnect()):(t.Log("commet connect."),t.global.connect="comet",this.startCometConnect())},startCometConnect:function(){var e=this;t.require({TChat:"comet.chat.js"+t.baseExt},function(i){i?(t.Log("Loaded $comet.chat mode complete",3),e._createCometConnect()):t.Log("Loaded $comet.chat mode failed",3)})},sendMessage:function(e){var i=t.JSON.toJSONString(e);this.debug&&t.Log("chatConnect.sendMessage("+i+")"),this.connect&&t.isFunction(this.connect.sendMessage)?this.connect.sendMessage(i):t.Log("connect.sendMessage is undefined",3)},predictMessage:function(e){this.debug&&t.Log("chatConnect.predictMessage("+e+")"),this.connect&&t.isFunction(this.connect.predictMessage)&&this.connect.predictMessage(e)},setTextStyle:function(e){this.debug&&t.Log("chatConnect.setTextStyle("+t.JSON.toJSONString(e)+")"),this.connect&&t.isFunction(this.connect.setTextStyle)&&this.connect.setTextStyle(e)},disconnect:function(){if(this.debug&&t.Log("chatConnect.disconnect()"),this.connect&&t.isFunction(this.connect.closeTChat)){try{this.connect.closeTChat()}catch(t){}t.global.connect==t.CON_CONNECT_FLASH&&t.flash.remove(this.connect),this.connect=null}},closeTChat:function(){this.debug&&t.Log("chatConnect.closeTChat()"),this.disconnect()},switchConnect:function(){this.stopSwitchConnect(),t.Log("connect tchat abnormalities["+t.global.connect+"], switch the connection type.",2),this.options.requestRobot||"comet"==t.global.connect?(this.error=!0,t.Log("switch connect tchat type failure",3)):(this.connect&&t.isFunction(this.connect.remove)&&this.connect.remove(),this.connect&&t.isFunction(this.connect.disconnect)&&this.connect.disconnect(),t.global.connect=t.CON_CONNECT_COMET,this.startCometConnect())},stopSwitchConnect:function(){this.debug&&t.Log("chatConnect.stopSwitchConnect"),clearTimeout(this.switchTimeId),this.switchTimeId=null},_createCometConnect:function(){t.Log("chatConnect._createCometConnect()",1),this.connect=new t.TChat(this.options,t.server)},_createRobotConnect:function(){if(t.Log("chatConnect._createRobotConnect()",1),!t.Robot)return!1;this.connect=new t.Robot(this.options)},_createMqttConnect:function(){if(!t.Connection)return t.Log("load tchat connect object fail.",3),!1;this.connect=new t.Connection.TChat(this.options)}},t.chatMode=t.Class.create(),t.chatMode.prototype={name:"chatMode",debug:!1,view:null,options:null,manageMode:null,hash:new t.HASH,hashCache:new t.HASH,htmlsid:0,connectId:"",siteid:"",settingid:"",config:null,connected:!1,defData:null,_sendNum:0,_changeCsrNum:0,_changeCsrMaxNum:5,_reconnectCount:0,_startQueue:!1,_queueNum:1,statusConnectT2D:"WAIT",statusConnectTChat:"WAIT",_submitRating:!1,_Evaluable:!1,_Enableevaluation:!1,_currentView:"",inputMaxByte:0,selected:!1,floatTimeID:null,dest:null,hashDest:new t.HASH,sessionid:"",user:null,_moreData:null,unread:0,userNumber:0,userList:[],sessionType:null,enterData:null,captureing:!1,waitTimeID:null,cacheTimeID:null,server:[],passive:0,evaluateSign:null,receiveMsgCount:0,requestRobot:!1,enterUserId:null,startCSSwitch:"",CON_GENERAL:1,CON_ADPTER:1e4,CON_INVITE:10001,CON_VIEW_LOADING:"loading",CON_VIEW_ERROR:"error",CON_VIEW_WINDOW:"window",CON_VIEW_MESSAGE:"message",CON_OFFLINE:0,CON_ONLINE:1,CON_INVISIBLE:2,CON_BUSY:3,CON_AWAY:4,CON_LOGIN_FAILURE:0,CON_LOGIN_SUCCESS:1,CON_CONNECT_FAILURE:2,CON_CONNECT_SUCCESS:3,CON_DISCONNECT:4,CON_CLOSE_CONNECT:5,CON_MOBILE_SHOW_GOODSINFO:0,CON_ROBOT_ID:"_ISME9754_T2D_webbot",CON_ROBOT_ERROR_MESSAGE:"ROBOT_ERROR_MESSAGE",CON_ROBOT_NO_ANSWER:"非常对不起哦，这个问题在我知识范围外，我会努力去学习的！",robotID:"",robotSessionID:"",lastSessionID:"",t2dMode:null,uploadingid:{},evalRequestType:"POST",evalFailCount:0,startType:0,robotSystemMessage:{message:"留言",fq:"FQ,放弃排队",ch:"CH,查看排队情况"},initialize:function(e,i){this.defData={type:1,userid:"",name:"",logo:"",msg:""},this.sessionid="",this.dest={id:"",name:""},this._moreData=[],this.user={id:t.user.id},this.hash.clear(),this.options=t.extend({},e),this.manageMode=i,this.siteid=this.options.siteid,this.sellerid=this.options.sellerid,this.settingid=this.options.settingid,this.edu_invisitid=this.options.edu_invisitid,this.edu_visitid=this.options.edu_visitid,this.itemid=this.options.itemid,this.htmlsid=this.options.htmlsid,this.connectId=this.options.connectid,this.selected=!0,this.unread=0,this._submitRating=!1,this._Evaluable=!1,this._currentView=this.CON_VIEW_LOADING,this.robotID=this.siteid+this.CON_ROBOT_ID,this._callbackGoodsinfo="scriptCallReceiveGoodsinfo_"+this.settingid,window[this._callbackGoodsinfo]=null,this._callbackHistoryMessage="scriptCallHistoryMessageList_"+this.settingid,window[this._callbackHistoryMessage]=null,this.historyMessagePage=1,this.historyMessagePageStatus=1,this.historyEndTime=(new Date).getTime().toString().slice(0,10),this.requestTimeout=null,this.defStyle={bold:!1,color:"000000",fontsize:"14",underline:!1},this.waitTimeID=[],this.cacheTimeID=[];var s=this,n=t.ntView?t.ntView.chatView:t.chatView;this.view=new n({siteid:this.siteid,settingid:this.settingid,width:this.manageMode.view.options.width,height:this.manageMode.view.options.height,chatHeader:this.manageMode.view.header,chatContainter:this.manageMode.view.chatContainter,toggleExpansion:function(t){s.toggleExpansion(t)}},this);var a=t.ntView?t.ntView.eduWapAutoView:t.eduWapAutoView;t.isAutoEdu&&t.browser.mobile&&(this.eduWapAutoView=new a(this.settingid)),this.setDest(),this.inputMaxByte=600,this.initConfig(),t.browser.mobile||t.Capture.init(this.server.filetranserver),this.view.disableButton(["history","evaluate","capture"],!0),this.view.createFileButton(this.server),this.supMediaMessage(),this.callStat("24")},toggleExpansion:function(t){return this.manageMode.callToggleExpansion(t)},getExpansionStatus:function(){return this.manageMode.view.extended.rightElement},loadLink:function(e,i){var s,n,a=this,o=t.isDefined(this.server.queryurl)&&this.server.queryurl?this.server.queryurl:"";!o||!e||!/^\d+\.\d+\.\d+\.\d+$/gi.test(t.domain)&&e.indexOf(t.domain)<=-1&&t.global.pageinchat||(t.Log("nTalk.chatMode.loadLink("+e+")"),s="callback_"+t.randomChar(),n=t.toURI({query:"getwebinfo",weburl:e,ctype:1,siteid:this.siteid,batch:0,callbackname:s}),window[s]=function(e){if(t.Log("nTalk.chatMode.loadLink() callback: "+t.JSON.toJSONString(e),1),e.customer="",a.view.viewLinkContainer&&e.title){if(e.customs&&e.customs.length>0)for(var s=0;s<e.customs.length;s++)e.customs[s]&&e.customs[s].name&&e.customs[s].content&&(e.customer+=e.customs[s].name+e.customs[s].content+"<br/>");a.view.viewLinkContainer(e,i)}},t.require(o+"?"+n+"#rnd"))},callTrack:function(e,i){var s={siteid:this.siteid,userid:t.user.id,sid:this.getHtmlSid(),nodeid:e,nodeparam:i};{if(this.server.trackserver)return t.require(this.server.trackserver+"/track.php?"+t.toURI(s)+"#rnd#image",function(i){!0===i.error&&t.Log("call trackServer error: "+e,3),t(i.error?i.target:i).remove()}),!0;t.Log("nTalk.chatMode.callTrack("+e+"): trackserver error",1)}},callStat:function(e){var i=new RegExp("^(1|2|4|5|6|7|8|18|19|20|21)","gi"),s=new RegExp("^(0|5|14|15|16|17|10|11|12|13|22|23|24)$","gi"),n={type:"chatjs",siteid:this.siteid,kfid:this.dest.id||"",guestid:t.user.id,action:e,htmlsid:this.getHtmlSid(),chatsession:this.sessionid||"",settingid:this.settingid,userrank:this.options.userrank,usertag:this.options.usertag};if(!t.global.statictis&&i.test(e))return!1;if(2===t.global.statictis&&!s.test(e))return!1;this.debug&&t.Log(this.settingid+":chat.callStat("+e+")");var a;return"kf_9740"===this.siteid?(n=t.extend(n,{c:"addmessage",m:"collection"}),a="http://bkpi-sunlands.ntalker.com/index.php?"):(n=t.extend(n,{m:"Count",a:"collection"}),a=this.server.mcenter+"statistic.php?"),t.require(a+t.toURI(n)+"#rnd",function(i){!0===i.error&&t.Log("call statictis error: "+e,3),t(i.error?i.target:i).remove()}),!0},close:function(){this.statusConnectTChat="CLOSECHAT",this.disconnect(),!t.xpush||!t.browser.oldmsie&&t.browser.supportMqtt||t.xpush.startXpush(),this.userList=[],this.sessionid="",this.view.close(),this.callStat("23"),2==this.server.isnoim&&"1"==t.cache.get("opd")&&t.base&&t.base.startIM()},start:function(e){var i,s;if(this.config&&!t.isEmptyObject(this.config)){if(t.Log(this.settingid+":chatMode.start()"),t.isFunction(this.manageMode.callVerification)&&(i=this.manageMode.callVerification(this.settingid,this.config)))return i.showMessage("system0",{type:9,msg:t.utils.handleLinks(t.lang.system_merge_session,{destname:i.dest.name})}),i.send(e),t.chatManage.switchChatTag(i.settingid),void t.Log("Only one customer to open a chat window",2);this.dest.kfid=this.getDest(!0),(!1===(s=t.base.checkID(this.options.destid))||s!=t.CON_CUSTOMER_ID&&s!=t.CON_GROUP_ID)&&(this.options.destid=this.getDest(!0)),this.options.single||(t.base.checkID(this.options.destid)==t.CON_GROUP_ID?this.options.single=0:this.options.single=1),this.callStat("8"),this.getCustomerServiceInfo(this.options.destid,this.options.single)}else t.Log("chatMode.start():config is null",3)},reconnect:function(e,i,s,n,a){if(e){for(;e&&"LI"!=e.tagName.toUpperCase()&&e.parentNode;)e=e.parentNode;t(e).remove()}/QUERY|QUEUE/i.test(this.statusConnectT2D)?t.Log("reconnect:"+this.statusConnectT2D):/QUEUE|READY|COMPLETE/i.test(this.statusConnectTChat)?t.Log("reconnect:"+this.statusConnectTChat):(i&&(this.options.destid=i||"",this.options.single=s||"0",this.options.edu_invisitid=n||"",this.options.edu_visitid=a||""),this._currentView!==this.CON_VIEW_WINDOW&&this.switchUI(this.CON_VIEW_WINDOW),this.start())},createConnect:function(){var e,i=this,s=1===this.t2dMode?this.lastSessionID:this.sessionid;t.Log("connect tchat sessioId>>"+this.sessionid,1),e={tchatgoserver:this.server.tchatgoserver,tchatmqttserver:this.server.tchatmqttserver,siteid:this.siteid,settingid:this.settingid,surl:this.server.flashserver,rurl:t.baseURI,u:t.user.id,n:t.user.name,groupid:this.dest.id,destname:this.dest.name,sid:s,cid:t.global.pcid,htmlsid:this.getHtmlSid(),connectid:this.connectId,statictis:t.global.statictis,userlevel:t.global.isvip||"0",disconnecttime:this.config.contime||180,mini:0,chattype:t.global.chattype||"1",chatvalue:3==t.global.chattype?t.global.inviteid:t.global.chatvalue||"0",loadnid:t.CON_LOAD_MODE_NID,requestRobot:this.requestRobot,edu_invisitid:t.chatManage.get(this.settingid).options.edu_invisitid,edu_visitid:t.chatManage.get(this.settingid).options.edu_visitid,userrank:this.options.userrank,usertag:this.options.usertag,leftchat:this.options.config.leftchat,startType:this.startType},this.callTrack("10-01-01","start connect"),this.connect&&(this.statusConnectTChat="WAIT",this.statusConnectT2D="WAIT",this.disconnect()),this.connect=new t.chatConnect(e,this.server.close_tchat_flash||"0"),this.requestRobot&&setTimeout(function(){i.connect.error&&(clearTimeout(this._connectTimeout),i.switchUI(i.CON_VIEW_MESSAGE,"TIMEOUT"))},6e3),this._connectTimeout=setTimeout(function(){i.callTrack("10-01-03","connect time out"),i.debug&&t.Log("connect timeout 60s"),i.switchUI(i.CON_VIEW_MESSAGE,"TIMEOUT")},6e4)},supMediaMessage:function(){var e=this;t.listenerMessage(function(i){switch(i.method){case"OpenWebUrl":"function"==typeof window.openURLToBrowser?window.openURLToBrowser(i.url):window.open(i.url);break;case"OpenDialog":window.openURLToBrowser,alert(i.msg);break;case"OpenNTalkerPage":e.switchUI(e.CON_VIEW_MESSAGE);break;case"SendMessage":switch(i.msg[0]){case"0":e.send(i.msg[2]);break;case"1":chat.showMessage("left",{type:1,msg:t.utils.handleLinks(i.msg[2],{destname:chat.dest.name})});break;case"2":var s=t.getTime(),n={localtime:s,timerkeyid:s,msgid:e.getMsgId(s)},a=t.extend({},e.defData,n,{msg:i.msg[2].replace(/</gi,"&lt;").replace(/>/gi,"&gt;")});e.connect.sendMessage(a);break;default:t.Log("postMessage is no")}case"Openkeyboard":case"Closekeyboard":break;case"windowHeight":t("#"+i.msg.uri)&&(t.browser.mobile?(i.msg.widthSe&&(document.getElementById(i.msg.uri+"").style.width=i.msg.widthSe+"px"),document.getElementById(i.msg.uri+"").style.height=i.msg.heightSe+"px",document.getElementById(i.msg.uri+"").setAttribute("scrolling","no")):(i.msg.widthSe&&(document.getElementById(i.msg.uri+"").style.width=i.msg.widthSe+"px"),i.msg.heightSe&&(document.getElementById(i.msg.uri+"").style.height=i.msg.heightSe+"px",document.getElementById(i.msg.uri+"").setAttribute("scrolling","no"))))}})},getHtmlSid:function(){return this.htmlsid?(this.htmlsid=t.getTime()-this.htmlsid.substring(0,this.htmlsid.length-3)>144e5?t.getTime(2):this.htmlsid,this.htmlsid):""},disconnect:function(){var e=this;"CLOSECHAT"==this.statusConnectTChat?(this.showMessage("system",{type:9,msg:t.utils.handleLinks(t.lang.system_end_session,{settingid:this.settingid})}),t.base.fire("SessionEnd",[{type:1,settingid:this.settingid||"",sessionid:this.sessionid||""}])):"COMPLETE"==this.statusConnectTChat?(0!==this.config.enable_auto_disconnect&&this.showMessage("system",{type:9,msg:t.utils.handleLinks(t.lang.system_auto_disconnect,{settingid:this.settingid})}),t.base.fire("SessionEnd",[{type:2,settingid:this.settingid||"",sessionid:this.sessionid||""}])):"WAIT"==this.statusConnectTchat&&this._clearChangeCsrNum(),this._stopConnectTimeout(),this.view.disableButton(["evaluate","capture"],!0),this.manageMode.view.updateViewStatus(!0),t.Log(e.settingid+":chatMode.disconnect()",1),this.connected=!1,this.statusConnectTChat="DISCONNECT",this.setDest({status:0}),this.chatFlashGoUrl&&t.require(this.chatFlashGoUrl+"#rnd",function(i){e.chatFlashGoUrl="",t(i.error?i.target:i).remove()}),this._queueTimeID&&(clearTimeout(this._queueTimeID),this._queueTimeID=null),t.each(this.waitTimeID,function(t,e){clearTimeout(e)}),this.waitTimeID=[],t.each(this.cacheTimeID,function(t,e){clearTimeout(e)}),this.cacheTimeID=[],this.connect&&this.connect.disconnect()},endSession:function(){var e=this;if(this.manageMode.hash.count()>1)if(t.Log("...............close",2),this.config&&1==this.config.enableevaluation&&!this._submitRating&&this._Evaluable&&this._currentView==this.CON_VIEW_WINDOW){if(!1===this.showEvaluation(1,"",function(){e.manageMode.closeChat(e.settingid)}))try{e.manageMode.closeChat(e.settingid)}catch(e){t.Log(e,3)}}else this.manageMode.closeChat(this.settingid);else this.manageMode.close()},switchUI:function(e,i){this.view.switchUI(e),this._currentView=e,t.Log(this.settingid+":chatMode.switchUI("+e+", "+i+")"),e===this.CON_VIEW_MESSAGE&&(this.callTrack("10-01-08"),this.manageMode.view&&t.isFunction(this.manageMode.view.updateViewStatus)&&this.manageMode.view.updateViewStatus(!0),this.disconnect(),this.callStat("22"),this.createMessageForm())},createMessageForm:function(){var e;this.config.form_message&&"string"!=typeof this.config.form_message&&this.config.form_message.length||(this.config.form_message=this.config.message_form),this.config.form_message&&"string"!=typeof this.config.form_message&&this.config.form_message.length&&!this.config.preferlan||(this.config.form_message=t.lang.default_message_form_fields||""),this.dest=this.getDest(!1),this.setDest({status:0}),e={myuid:t.user.id,destid:this.dest.id,sid:this.sessionid||"",source:"",content:""},this.hashCache.each(function(t,i){1==i.type?e.content+=i.msg+"\n":/^(2|4)$/.test(i.type)&&(e.fileError=!0)}),this.hashCache.clear(),this.view.createMessageForm(this.config.form_message,this.config.disable_message,this.config.form_announcement||this.config.announcement||"",e)},submitMessageForm:function(){var e,i={t:"leaveMsg",siteid:this.siteid,sellerid:this.sellerid,settingid:this.settingid};"kf_9740"===this.siteid?(i=t.extend(i,{c:"addmessage",m:"queryService"}),e="http://bkpi-sunlands.ntalker.com/index.php?"):(i=t.extend(i,{m:"Index",a:"queryService"}),e=this.server.mcenter+"queryservice.php?"),1==t.global.message&&(i=t.extend(i,{opId:t.global.opId}));var s=t(".chat-view-message-form input[name=msg_email]"),n=s.val().replace(/(^\s*)|(\s*$)/g,"");s.val(n),this.view.submitMessageForm(this.config.form_message,e+t.toURI(i)+"#rnd")},_stopConnectTimeout:function(){clearTimeout(this._connectTimeout),this._connectTimeout=null},cancelUpload:function(e){var i="uploadfile"==e?"objFile":"objImage";t.Log(this.settingid+":chatMode.cancelUpload()"),this.view[i].cancelUpload&&this.view[i].cancelUpload(),this.view.updateMessage(this.uploadmsgid,"uploadfile"==e?4:2,-1)},_uploadReady:function(e){var i="uploadfile"==e?"objFile":"objImage";t.Log(this.settingid+":chatMode._uploadReady("+i+")",1),t.isFunction(this.view[i].setUploadServer)&&this.view[i].setUploadServer(this.server.filetranserver)},startUpload:function(e,i){var s=t.hexToDec(i||"").replace(/.*?(\u201c|\\u201c)/gi,"").replace(/(\u201d|\\u201d).*?$/gi,"");this.uploadmsgid=this.showMessage("right",{type:"uploadfile"==e?4:2,status:"UPLOADING",oldfile:t.browser.mobile?"":s})},startCompress:function(t){this.uploadmsgid=this.showMessage("right",{type:"uploadfile"==t?4:2,status:"COMPRESS"})},uploadSuccess:function(e,i){i=t.isObject(i)?i:t.JSON.parseJSON(i),i=t.protocolFilter(i),this.view.updateMessage(this.uploadmsgid,"uploadfile"==e?4:2,i),t.Log(this.settingid+": $.chatMode.uploadSuccess()",1),this.send(t.extend(i,{msg:i})),this.uploadmsgid=""},uploadFailure:function(e,i){if(!this.uploadmsgid){this.uploadmsgid=this.showMessage("right",{type:"uploadfile"==e?4:2,oldfile:(t.browser.mobile,""),name:i.name,size:i.size})}this.view.updateMessage(this.uploadmsgid,"uploadfile"==e?4:2,-2,i),this.uploadmsgid=""},uploadProgress:function(t,e){this.view.updateMessage(this.uploadmsgid,"uploadfile"==t?4:2,e)},showEvaluation:function(e,i,s){if(0==e&&this.view.evalDialog)return!1;if("WAIT"==this.statusConnectTChat&&0!=e)return!1;if(this.passive=e,i&&(this.evaluateSign=i),!0===this._submitRating&&0!=e)return!1;if(2==this.config.evaluateVersion)try{var n=t.JSON.parseJSON(this.config.newevaluate);return this.showEvaluationVersion2(n,s),!0}catch(e){t.Log("This newevaluate JSON is wrong, change evaluate to version 1.0"),this.config.evaluateVersion=1}this.manageMode.callReceive(this.settingid);this.config.form_evaluation&&"string"!=typeof this.config.form_evaluation&&this.config.form_evaluation.length||(this.config.form_evaluation=this.config.evaluation_form),this.config.form_evaluation&&"string"!=typeof this.config.form_evaluation&&this.config.form_evaluation.length&&!this.config.preferlan||(this.config.form_evaluation=t.lang.default_evaluation_form_fields||[]),this.config.evaluation_form_title||(this.config.evaluation_form_title=t.lang.default_evaluation_form_title||"");for(var a=0;a<this.config.form_evaluation.length;a++)this.config.form_evaluation[a]=t.extend(this.config.form_evaluation[a],{titlewidth:/zh_cn|en_us/gi.test(t.lang.language)?"5px":"10px",inputwidth:"auto",optionLine:!0,messageid:"alert-form-"+this.config.form_evaluation[a].name}),"textarea"==this.config.form_evaluation[a].type&&(this.config.form_evaluation[a]=t.extend(this.config.form_evaluation[a],{input:{width:"95%",height:"70px"}}));return this.evaluationElement=this.view.createEvaluation(this.config.form_evaluation,this.config.evaluation_form_title,this.config.startColor,this.config.endColor,s),!0},showEvaluationVersion2:function(e,i){var s=this;t.require({evaluateTree:s.config.evaluateFile+t.baseExt},function(){if(t.evaluateTree||(t.evaluateTree=new t.EvaluateTree(e)),s.config.enable_labelCounts){t.evaluateTree.clearAnswerCount();var n=t.evaluateTree.levelNodes[3],a="";for(nodeIndex in n)a+=n[nodeIndex].substring(1)+",";labeids=a.substring(0,a.lastIndexOf(","));window.labelCounts=function(e){try{var i="string"==typeof e?t.JSON.parseJSON(e):e;for(eid in i)t.evaluateTree.getNode("a"+eid).count=i[eid]}catch(e){t.Log("labelCounts.callback:"+e.message,3)}},e={kfid:s.dest.id,labids:labeids,callback:"labelCounts"},t.require(t.server.settingserver+"/index.php/api/setting/returnLabids?"+t.toURI(e)+"#rnd",function(){s.evaluationElement=s.view.createEvaluationVersion2(t.evaluateTree,i)})}else s.evaluationElement=s.view.createEvaluationVersion2(t.evaluateTree,i)})},getNewMessageConfig:function(){return this.config.new_leave_message||(this.config.new_leave_message={}),this.config.new_leave_message.disable_message=this.config.disable_message,this.config.new_leave_message},submitEvaluationForm:function(e,i){var s=this;if(2!=this.config.evaluateVersion)t.FORM.verificationForm(this.config.form_evaluation,function(t){if(s.evaluateSign&&0==s.passive){i={name:"evalute_start",title:"评价方式",value:{value:"0",text:s.passive+"_"+s.evaluateSign}};t.push(i)}else{var i={name:"evalute_start",title:"评价方式",value:{value:"0",text:s.passive+"_"}};t.push(i)}s.postEvaluate(t),e&&setTimeout(function(){e.call(s)},500)},this.evaluationElement,i);else{var n=t.EvaluateVerificate.getEvaluateSubmitData();if(t.isArray(n)){if(s.evaluateSign&&0==s.passive){a={id:"6",question:"评价发起的方式evalute_start",answer:[{labid:"-2",lab:s.passive+"_"+s.evaluateSign,score:"0"}]};n.push(a)}else{var a={id:"6",question:"评价发起的方式evalute_start",answer:[{labid:"-2",lab:s.passive+"_",score:"0"}]};n.push(a)}s.postEvaluate(n),e&&setTimeout(function(){e.call(s)},500)}else i.call(s,n)}},postEvaluate:function(e){try{e[2]&&"proposal"==e[2].name&&(e[2].value=nTalk.filterXSS(e[2].value))}catch(t){}var i=this;this.evaluationHidden=!0,e=this._formatEvaluationData(e),this.chatgourl||(t.Log("chatMode.postEvaluate():chatgourl:"+this.chatgourl,3),this.chatgourl=this.mdyServerAddr(this.server.tchatgoserver)),this.manageMode.addHistoryPageCount();var s=function(){t.Log("evaluate submit complete.",1),t.browser.mobile?evMsg=t.lang.system_mobile_evaluation:evMsg=t.utils.handleLinks(t.lang.system_evaluation,{evaluation:t.enCut(e.info,120)}),i.showMessage("info",{type:9,msg:evMsg})},n=function(){i.evalFailCount++,i.evalFailCount<3?h():(i.evalFailCount=0,t.Log("evaluate submit complete.",1),i.showMessage("info",{type:9,msg:"评价失败"}))},a=[function(e){"AJAX"===i.evalRequestType&&e&&e.status||"POST"===i.evalRequestType?(s(),i.evalFailCount=0):(t.Log(e.errormsg),n())},function(){t.Log("evaluate submit error.",1),n()}],o={action:"onremark",myuid:this.user.id,clientid:this.clientid,sessionid:this.sessionid,rnd:t.getTime(1)},r={url:t.server.tstatus,dataType:"json",crossDomain:!0,data:t.extend({},o,e.data,{type:0}),success:function(t){funcArr[0](t)},error:function(e){t.Log(e),i.evalRequestType="POST",h()}},h=function(){"AJAX"===i.evalRequestType?t.doAjaxRequest(r):new t.POST(i.chatgourl+"?"+t.toURI(o),e.data,a)};h()},download:function(){if(t.Log("download recording file"),"WAIT"!=this.statusConnectTChat){var e=t.toURI({m:"Msg",a:"downloadMsg",uid:this.user.id,sid:this.sessionid,lang:t.language,tzo:(new Date).getTimezoneOffset()/60,ts:t.getTime()}),i=this.server.mcenter+"historymessage.php?"+e;"function"==typeof window.openURLToBrowser?window.openURLToBrowser(i):this.view.displayiFrame.attr("src",i)}},viewHistory:function(e,i){var s=("gy_1000"===t.global.siteid?"http://bkpirb.ntalker.com/index.php/messageweb/webAppIndex?":this.server.mcenter)+"index.php/messageweb/webAppIndex?"+t.toURI({userid:this.user.id,lang:t.language,tzo:(new Date).getTimezoneOffset()/60,ts:t.getTime()});t.Log("view chats,iFrame:"+i+", url:"+s,2),t(i).attr("src",s)},startCapture:function(){var e=this;this.connected&&!0!==this.captureing&&(this.captureing=!0,t.Log(this.settingid+":chatMode.startCapture()"),t.Capture.start(this.settingid,!1,function(){e.captureing=!1,t.Log("Capture.onUploadCompleted()")}),setTimeout(function(){e.captureing=!1},500))},switchServerType:function(e,i){e?(t.Log("switch connect t2dstatus"),1==t.server.robot?(this.robotSessionID=this.sessionid,this.requestRobot=!1,this.view.disableButton("manual",!0),this.statusConnectTChat="CLOSECHAT",this.disconnect(),this.view.switchToolbar(!0),this.sendFirstMessage(),this.reconnect()):2==t.server.robot&&this.manualServiceInfo()):(t.Log("switch connect robot"),1==t.server.robot?(this.robotSessionID="",this.requestRobot=!0):2==t.server.robot&&(this.lastSessionID="",this.t2dMode=2===i?i:1),this.view.disableButton("manual",!1),this._stopQueue(),this.callMethod[this.callBack]=s,this.statusConnectT2D="COMPLETE",this.statusConnectTChat="WAIT",this.disconnect(),this.view.switchToolbar(!1),this.sendFirstMessage(),this.reconnect())},minimize:function(){this.selected=!1,this.view.minimize()},maximize:function(){t.Log(this.settingid+":chatMode.maximize()"),this.selected=!0,this.unread=0,this.view.maximize(),this.setDest()},Message_Filter:function(e){var i=t("#kf-wbiaoId").val();t.browser.mobile&&function(){var t=location.search,e=new Object;if(-1!=t.indexOf("?")){var s=t.substr(1);strs=s.split("&");for(var n=0;n<strs.length;n++)e[strs[n].split("=")[0]]=decodeURIComponent(strs[n].split("=")[1])}i=e.kf_wbiaoId}();try{i&&t.require("https://api-service.wbiao.com/api/xiaoneng/keyWordSaveXn?session="+i)}catch(e){t.log("kf_wbiaoId is error",1)}},receive:function(e){this._connectTimeout&&this._stopConnectTimeout();var i,s=this.checkHistoryVersion();t.isObject(e)?t.Log(this.settingid+":chatMode.receive("+t.JSON.toJSONString(e)+")"):(t.Log(this.settingid+":chatMode.receive("+e+")"),e=t.JSON.parseJSON(e)),2==s&&1==+e.history||(e=this._filterReceive(e),"wx_1000"===this.siteid&&(!/1|2|4/.test(e.type)||!e.msg||e.history||/5|9/.test(e.type)||e.msgsystem?t.Log("系统消息："+e.msg,1):this.Message_Filter()),t.clearHtml(e.msg)!=this.CON_ROBOT_NO_ANSWER&&e.msg!=this.CON_ROBOT_ERROR_MESSAGE||(e.msg=this.config.robot_noanswer||e.msg),this.hash.contains(e.msgid)||1==e.history&&e.systype&&2!=e.history||(this.noticeMessageCountNew(),!1!==e&&(i=t.base.checkID(e.userid)==t.CON_CUSTOMER_ID?"left":"right",2==s&&e.speak_type&&(i=0==e.speak_type?"right":"left"),this.showMessage(i,e)),t.base.checkID(e.userid)==t.CON_CUSTOMER_ID&&this.addDestList({id:e.userid||"",name:e.name||e.nickname||e.username,logo:e.logo||""})))},suggest:function(t){return this.view.suggest(t)},robot2GetSuggest:function(e){if(!e||e&&(t.enLength(e)>25||e.length<2))t(".chat-view-hidden-area .chat-view-suggest-list").display();else{var i=this;window.__robot2_callback=function(e){try{e="string"==typeof e?t.JSON.parseJSON(e):e}catch(e){t.Log("Robot.callback:"+e.message,3)}e.list&&e.list.length>10&&(e.list=e.list.slice(0,10)),e.list=e.list.reverse(),i.robot2Suggest(e)},data={action:"ig",q:e,sessionid:this.sessionid,clientid:t.global.pcid,type:"jsonp",callbackname:"__robot2_callback"},t.require(this.server.robotserver+"/robot/app?"+t.toURI(data)+"#rnd")}},robot2Suggest:function(e){var i=[];if(e&&e.list&&0===e.status)return t.each(e.list,function(t,e){i.push(e.question)}),this.view.suggest(i,"robot2.0")},requestHistoryMessage:function(){if(!/^guest/.test(t.global.shortid)){var e,i=this;if(2==this.checkHistoryVersion()&&this.historyMessagePageStatus){if(this.historyMessagePage>10)return this.dontHaveHistoryMessage(),void t.Log("you can see ten pages message Only ");if(this.historyMessagePageStatus=0,1!=i.historyMessagePage&&t(".ntalker-historymessage-status").css({display:"block"}).html(t.lang.history.loading),!t.flashserver.apiserver)return void i.errorHistoryMessage();var n=(new Date).getTime().toString().slice(0,10),a=this.sellerid?this.sellerid:this.siteid,o=a+"_ISME9754_"+t.global.shortid+n,r=t.MD5(o);e=t.protocolFilter(t.flashserver.apiserver)+"/history/api_request_new.php?"+t.toURI({site_id:a,user_id:t.global.shortid,page:1,per_page:20,times:n,end_time:this.historyEndTime,token:r}),window[this._callbackHistoryMessage]=function(e){try{if(0==e.length)i.dontHaveHistoryMessage();else{if(0==e[0].error)return void i.dontHaveHistoryMessage();i.historyMessagePage++,i.showHistoryMessage(e),i.historyMessagePageStatus=1,i.view.iSmousewheel=!0}}catch(e){i.errorHistoryMessage(),t.Log("some error happen in historymessage"+e.message)}},t.require(e+"&callback="+this._callbackHistoryMessage+"#rnd",function(e){e.error&&(window[this._callbackHistoryMessage]=s,1!=i.historyMessagePage&&setTimeout(function(){t(".ntalker-historymessage-status").css({display:"block"}).html(t.lang.history.fail_to_load)},5e3)),t.Log("request the historymessage success")})}else t.Log("requesting data now please hold a minutes")}},clearRequestTimeout:function(){},dontHaveHistoryMessage:function(){t(".ntalker-historymessage-status").html(t.lang.history.nomore_data)},showHistoryMessage:function(e){var i=this;t.each(e,function(e,s){var n=s.msg_type,a=null,o=null,r=new Date(s.time.replace(/\-/g,"/")).getTime(),h=s.message;try{h=nTalk.filterXSS(h)}catch(t){}if(5!=n){switch(a={timestamp:r,sessionid:s.session_id,settingid:s.setting_id,speak_type:s.speaker_type,name:s.speaker_name,userid:s.speaker_id,logo:s.avatar,history:2,type:s.msg_type,msgid:s.msg_id},i.historyEndTime=r.toString().slice(0,10),n){case"2":var c=h.substring(h.indexOf('src="')+5,h.lastIndexOf('">'));o=c.indexOf("emoticon")>-1?{emotion:"1",url:c,sourceurl:c.replace(/32/,"50")}:c.indexOf("_thumb")>-1?{url:c,sourceurl:s.sourceurl||c.replace(/_thumb/,""),size:h.substr(h.indexOf("size:")+5)}:{url:c.replace(/&amp;/gi,"&"),sourceurl:s.sourceurl||c.replace(/image2/,"download2").replace(/&amp;/gi,"&"),size:h.substr(h.indexOf("size:")+5)};break;case"4":var l=h.substring(h.indexOf("filename")+9,h.indexOf("size"));emotion=l.substring(l.lastIndexOf(".")+1),o={url:h.substring(h.indexOf("url:")+4,h.indexOf("filename")).replace(/&amp;/gi,"&"),oldfile:l,size:h.substring(h.indexOf("size:")+5)};break;case"6":o={url:h.substring(h.indexOf("mp3:")+4,h.indexOf(" length:")),length:h.substring(h.indexOf("length:")+7)};break;case"7":var u=h.substring(h.indexOf("richmessage:")+12);if(h=nTalk.base64.decode(u),(d=new RegExp(/\[[0-9]*\].+[\n]/g)).test(h)){m=(h=h.replace("&amp;lt;![CDATA[","").replace("<![CDATA[","").replace("]]>","")).match(d);if(h=h.replace(/&amp;/gi,"&"),h=h.replace(/[\n]/gi,""),h=h.replace(/</g,"&lt;"),h=h.replace(/>/g,"&gt;"),m&&m.length>0)for(var e=0,g=m.length;e<g;e++){f=m[e].replace(/[\n]/g,"");if(h.indexOf("&lt;")>-1||h.indexOf("&gt;")>-1)p="[xnlink]"+f+"[/xnlink]\n";else p="[xnlink]"+f+"[/xnlink]";h=h.replace(f,p)}}o={msg:h=(h=h.replace(/&lt;/g,"<")).replace(/&gt;/g,">")};break;case"8":o={url:h.substring(h.indexOf("videoUrl:")+9,h.indexOf(" pictureurl")-1),pictureurl:h.substring(h.indexOf("pictureurl=")+12,h.indexOf(" oldfile=")-1)};break;default:"ch"==h?h="查看排队情况":"fq"==h&&(h="放弃排队");var d=new RegExp(/\[[0-9]*\].+[\n]/g);if(d.test(h)){var m=(h=h.replace("&amp;lt;![CDATA[","").replace("<![CDATA[","").replace("]]>","")).match(d);if(((h=h.replace(/&amp;/gi,"&")).indexOf("&lt;")>-1||h.indexOf("&gt;")>-1)&&(h=h.replace(/[\n]/gi,"")),m&&m.length>0)for(var e=0,g=m.length;e<g;e++){var f=m[e].replace(/[\n]/g,"");if(h.indexOf("&lt;")>-1||h.indexOf("&gt;")>-1)p="[xnlink]"+f+"[/xnlink]\n";else var p="[xnlink]"+f+"[/xnlink]";h=h.replace(f,p)}}o={msg:h=(h=h.replace(/&lt;/g,"<")).replace(/&gt;/g,">")}}a=t.extend(a,i.defStyle,o);var v=t.chatManage.get();v&&v.receive(a)}}),t(".ntalker-historymessage-status").css({display:"block"}).html(t.lang.history.drag_for_more)},errorHistoryMessage:function(){t(".ntalker-historymessage-status").html(t.lang.history.fail_to_load),t.Log("there are some error when request historyPage")},checkHistoryVersion:function(){return 2===this.config.history_version&&t.global.shortid&&!/^guest/.test(t.global.shortid)?2:1},sendFirstMessage:function(){if(this.requestRobot&&0!==this.config.enable_robotgreeting&&1==t.server.robot){if(!this.config.robot_greeting)return;this.showMessage("left",{msgid:"welcome_robot",type:1,history:1,msg:this.config.robot_greeting||""})}else if(0!==this.config.enable_artificialgreeting){if(2==t.server.robot&&this.robotKf)return;var e=this.config.greet_detail?this.config.greet_detail:t.utils.handleLinks(t.lang.system_first_news,{name:this.config.name});this.showMessage("left",{msgid:"welcome",type:1,msg:e})}},send:function(e,i,s){var n;e.flowid&&(n=e.flowid,e=e.message);var a=t.getTime(),o={localtime:a,timerkeyid:a,msgid:this.getMsgId(a)};if(n&&(o.flowid=n),e="string"==typeof e?t.extend({},this.defData,o,{msg:e.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")}):t.extend({},this.defData,o,e),!this.connected)return/FAILURE|QUEUE/i.test(this.statusConnectTChat)||(t.Log("connected:"+this.connected+", statusConnectTChat:"+this.statusConnectTChat+", start",1),this.statusConnectTChat="QUEUE",this.start(e)),this.hashCache.add(e.msgid,e),!1;if("string"==typeof e.msg&&-1===e.msg.indexOf("faqvote:")&&(e.msg=t.enCut(e.msg,this.inputMaxByte)),t.Log(this.settingid+":chatMode.send("+(t.isObject(e)?t.JSON.toJSONString(e):e)+")",1),1==e.type||2==e.type&&1==e.emotion){var r=t.extend({},e);i&&(r.msg=i),r.msg.indexOf("faqvote:")>-1&&s?(e.msg=s,e.hidden=r.msg,r.msg=s,this.showMessage("right",r)):this.showMessage("right",r)}else/^(2|4|6)$/gi.test(e.type)&&this.hash.add(e.msgid,e);return/^(1|2|4|6)$/gi.test(e.type)&&(this._sendNum++,this._changeCsrNum++,this._changeCsrNum==this._changeCsrMaxNum&&this.view.disableButton("csr",!1)),this.connect&&this.connect.sendMessage(e),this.clearMessageCount(e),!0},noticeMessageCountNew:function(t){"function"==typeof webInfoChanged&&t&&/(^1|2|4|6|7)$/i.test(t.type)&&"welcome"!==t.msgid&&1!=t.history&&"true"!=t.msgsystem&&(this.receiveMsgCount++,webInfoChanged(400,'{"num":'+this.receiveMsgCount+', "showNum":1}',!1))},clearMessageCount:function(){this.noticeMessageCount=0,"function"==typeof webInfoChanged&&webInfoChanged(400,'{"num":0, "showNum":1}',!1)},resend:function(t){if(!this.hash.contains(t))return!1;this.send(this.hash.items(t))},predictMessage:function(e){this.connected&&this.connect&&(t.Log("$.chatMode.predictMessage("+e+")"),this.connect.predictMessage(e),2==t.server.robot&&this.robotKf&&this.view.isRobotSuggest&&this.robot2GetSuggest(e))},_filterReceive:function(e){var i=this;return this.user.id==e.userid||t.base.checkID(e.userid)===t.CON_VISITOR_ID?e.msgid=e.msgid?e.msgid:this.getMsgId(e.timerkeyid):1!=+e.history&&/^(1|2|4)$/.test(e.type)&&(t.promptwindow.startPrompt("",t.lang.news_new,!0),this.manageMode.callReceive(this.settingid),this.selected||this.unread++),e.msgid=e.msgid||e.timerkeyid,this.jetLag?e.timestamp=e.timestamp+parseInt(this.jetLag):e.timestamp=e.timestamp,e.timerkeyid=e.timestamp,e.localtime=e.timestamp,1==e.msgType?(this.view.updateMessage(e.msgid,1,t.lang.system_send_failure),this.callTrack("10-01-04","flash timeout, message send failure"),!1):2==e.msgType?!t.isObject(e.msg)&&(this.callTrack("10-01-04","common message send failure"),this.view.updateMessage(e.msgid,1,t.lang.system_send_failure),!1):9===e.type?(this.callTrack("10-01-04","message is too fast to send"),e.msgid=e.msgid||this.getMsgId(e.timeData),this.view.updateMessage(e.msgid,1,t.lang.system_send_failure),this.view.displayStatusInfo&&(this.view.displayStatusInfo(!0,t.lang.system_fast_messaging),this.floatTimeID=setTimeout(function(){clearTimeout(i.floatTimeID),i.floatTimeID=null,i.view.displayStatusInfo(!1)},3e3)),!1):e},showMessage:function(e,i){1==i.type&&"inputting"!=i.tag&&(i.msg=nTalk.filterXSS(i.msg));var s=t.getTime(),n=this;if(1!=this.config.leftchat||0==this.startType||"system"!=e){if(2!=i.history&&(i=t.extend({localtime:s,timerkeyid:s,msgid:this.getMsgId(s),msg:""},"left"==e?this.dest:this.defData,i)),1==i.type&&i.url){var a=this.supMedia(i.url,i.msgid,i.msg);i.msg=a.temp,e=a.position}if(!this.hash.contains(i.msgid)||2==i.history){if(i.msgid.indexOf("welcome")>-1&&(i.timerkeyid=-1,i.localtime=-1),i.logo&&(i.logo=t.protocolFilter(i.logo)),i.url&&(i.url=t.protocolFilter(i.url)),i.sourceurl&&(i.sourceurl=t.protocolFilter(i.sourceurl)),i.mp3&&(i.mp3=t.protocolFilter(i.mp3)),i.msg&&"string"==typeof i.msg&&i.msg.indexOf("xnlink")>-1&&(i.xnlink=!0),i.systype){if("2"===i.systype){for(2===this.connect.connect.robotQueue||i.history||(this.callStat("11"),this.connect.connect.robotQueue=2,this.connect.connect.clearSessionIdle(),this.view.disableButton("manual",!0));-1!==i.msg.indexOf("\n");)i.msg=i.msg.replace("\n","<br>");var o=i.msg.match(new RegExp(/[0-9]+/gi));if(o&&o.length>0&&o[0]){var r='<font class="chat-view-queue-num" style="'+t.STYLE_BODY+'color:red;font-weight:bold;">'+o[0]+"</font>";i.msg=i.msg.replace(/[0-9]+/,r)}}else"1"!==i.systype||i.history?("3"!==i.systype||i.history||(this.callStat("23"),this.htmlsid=t.getTime(2)),"4"!==i.systype||i.history||(t(".welcome").length>0&&(t(".welcome").remove(),n.hash.remove("welcome")),this.callStat("10"),setTimeout(function(){n.sendFirstMessage(),n.setRobot2Param(!1)},500)),"4"!==i.systype||i.history||this.callStat("10"),this.connect.connect.robotQueue=0,this.view.disableButton("manual",!1)):this.connect.connect.robotQueue=1;if(e="left","2"===i.systype||"5"===i.systype){var h=this.config.robotSystemMessage||this.robotSystemMessage;t.each(h,function(e,s){if("message"==e)i.msg=t.utils.handleLinks(i.msg.replace(s,"[link message={$settingid} source=2]"+s+"[/link]"));else{s=s.split(",");for(var a=0;a<s.length;a++){var o='<a style="'+t.STYLE_BODY+"display:inline-block;color:#005ffb;text-decoration:none;font-size:"+(t.browser.mobile?14:12)+'px;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\''+n.settingid+"').send('"+e+"', '"+s[a]+"');return false;\" >"+s[a]+"</a>";i.msg.indexOf(s[a])>-1&&(i.msg=i.msg.replace(s[a],o))}}})}i.msgid="robot_toast"+(/2|4|5/gi.test(i.systype)?2:i.systype),i.type=1,i.msg=i.msg,i.fontsize=t.browser.mobile?14:12,t("."+i.msgid).length>0&&t("."+i.msgid).remove()}return this.hash.add(i.msgid,i),this.view.showMessage(e,i)}}},supMedia:function(t,e,i){return this.view.supMedia(t,e,i)},_sendGoodsinfo:function(){var e,i=this;this.options.itemid&&(this.callStat("20"),e=this.server.mcenter+"/goodsinfo/api.php?"+t.toURI({siteid:this.siteid,itemid:this.options.itemid,itemparam:this.options.itemparam,sellerid:this.options.sellerid,user_id:t.global.shortid}),this.hashCache.add(t.getTime(1),{type:5,msg:{msgtype:5,productInfoURL:e+"&type=2&ts="+t.getTime()}}),window[this._callbackGoodsinfo]||t.browser.mobile&&!this.CON_MOBILE_SHOW_GOODSINFO?t.Log("CON_MOBILE_SHOW_GOODSINFO:"+this.CON_MOBILE_SHOW_GOODSINFO):(window[this._callbackGoodsinfo]=function(t){i._showGoodsinfo(t)},t.require(e+"&type=jsonp&lan="+t.lang.language+"&callback="+this._callbackGoodsinfo+"#rnd",function(e){t(e.error?e.target:e).remove()})))},_showGoodsinfo:function(t){t?this.showMessage("goods",{type:13,msg:t}):this.showMessage("goods",{type:3})},isVisitor:function(e){return t.base.checkID(e)===t.CON_VISITOR_ID},getDest:function(e){var i=this.config;if(t.Log("chatMode.getDest("+e+")"),e)return temp=i.icon||i.list||i.toolbar||i.featureset||null,temp&&temp.members.groupID&&temp.members.idList.length?temp.members.groupID:"";if(this.dest&&this.dest.id&&this.dest.id!=this.robotID&&this.dest.id!=t.CON_SINGLE_SESSION&&-1==this.dest.id.indexOf("GT2D"))return this.dest;this.dest.id="",this.dest.name="";var s=(i.icon||i.list||i.toolbar||i.featureset).members;return{id:s.idList[0],name:s.nameList[0],sign:s.sigList[0]}},setDest:function(e){var i=this;(e=e||{}).phone&&t.browser.mobile&&this.manageMode.view.setPhoneNumber(e.phone),e.logo&&e.logo.indexOf("rand")<0&&(e.logo=e.logo+"?rand="+nTalk.randomChar()),t.Log(this.settingid+":chatMode.setDest("+(e?t.JSON.toJSONString(e):"")+")"),t.each(e,function(t,e){i.dest[t]=e||i.dest[t]}),e&&!t.isEmptyObject(e)&&this.addDestList({id:e.id,name:e.name,logo:e.logo}),this.config&&"trial"==this.config.mode?this.dest.title=t.lang.chat_title_ext+" "+this.dest.name:this.dest.title=this.dest.name,this.dest.attr={width:t.browser.mobile?35:55,height:t.browser.mobile?35:55},this.dest.logo?(t.CON_MULTIPLAYER_SESSION===this.dest.logo||this.userNumber>1&&!t.browser.mobile?this.dest.logo=t.imagemultiplayer:t.CON_SINGLE_SESSION===this.dest.logo&&(this.dest.logo=t.imagesingle),this.selected&&this.manageMode.callSetDest(this.settingid,t.extend({},this.dest)),t.require(this.dest.logo+"#image",function(e){this.src===i.dest.logo&&(!0!==this.error?(i.dest=t.extend({},i.dest,{logo:i.dest.logo,image:this,attr:t.zoom(this,i.dest.attr.width,i.dest.attr.height)}),i.hashDest.items(i.dest.id,t.extend({},i.dest))):i.dest.logo=t.imagesingle,i.selected?i.manageMode.callSetDest(i.settingid,t.extend({},i.dest)):i.manageMode.callSetDestStatus(i.settingid,t.extend({},i.dest),!0))})):i.selected&&(i.dest.logo=i.userNumber>1?t.imagemultiplayer:t.imagesingle,i.manageMode.callSetDest(this.settingid,t.extend({},this.dest)))},setUser:function(e){this.user=t.extend(this.user,e),this.defData=t.extend(this.defData,{userid:this.user.id||"",name:this.user.name||"",logo:this.user.logo||""})},showInputState:function(e){var i="background:transparent url("+t.sourceURI+"images/mobileicon.png) no-repeat -22px -250px;",s=this.hashDest.items(e);this.showMessage("bottom",{userid:s?s.id:e,name:s?s.name:"",logo:s?s.logo:"",tag:"inputting",type:1,msg:['<span class="view-history-body-wait" style="',t.STYLE_NBODY,"margin:0 10px;display:block;width:32px;height:20px;",i,'"></span>'].join("")}),this.view.showInputState()},initConfig:function(){var e;this.options.config&&!t.isEmptyObject(this.options.config)?(this.switchUI(this.CON_VIEW_WINDOW,"LOAD_COMPLETE"),this.config=t.extend({settingid:this.settingid},this.options.config),this.options.config.service?this.server=t.extend({},t.server,t.protocolFilter(this.options.config.service)):(t.Log("config file version error.",3),this.server=t.extend({},t.server,{tchatserver:"",tchatgoserver:"",filetranserver:""})),this.config.logo=t.protocolFilter(this.config.logo),"1"==this.server.robot&&"1"==this.config.robot&&this.server.roboturl&&(1==this.options.manual?this.requestRobot=!1:0===this.config.robot_mode&&(!this.config.robot_inherits_state||1==this.config.robot_inherits_state&&t.default_connect_robot)&&(this.requestRobot=!0),t.Log("nTalk.chatMode.initConfig(): requestRobot:"+this.requestRobot)),this._initChatConfig(),e=!t.browser.mobile&&this.config.logo?'<p style="'+t.STYLE_BODY+'background-color:transparent;text-align:center;"><img data-type="ntalk-enterprise-logo" src="'+this.config.logo+'" style="'+t.STYLE_BODY+'text-align:center;display:inline;" onerror="nTalk.loadImageAbnormal(this, event)" onload="nTalk.imgScrollBottom()"/></p>':"",this.setDest({id:this.siteid,logo:this.config.logo||"",name:t.utils.handleLinks(t.lang.system_title_news,{name:this.config.name||""}),status:0}),this.showMessage("first",{type:0,msg:e}),window.IScroll&&!/^guest/.test(t.global.shortid)&&(e||(t(".first").css({width:"100%",height:"0"}),t(".view-history-system").css({width:"100%",height:"0"})),this.requestHistoryMessage()),this.sendFirstMessage(),1==this.config.enable_audio&&this.audioInit(),t.base.fire("OpenChatWindow",[])):this.switchUI(this.CON_VIEW_ERROR,"LOAD_FAIED")},audioInit:function(){var e=this;t.Audio&&t.Audio.start(this.server.filetranserver,{action:"uploadaudio",roomid:"T2D",siteid:this.siteid,settingid:this.settingid},function(i){t.Log("set Audio Button disabled:"+i,2),e.view.disabledAudioButton(i)})},audioUpload:function(e,i){var s,n,a,o=this;if("uploading"===e.status)this.uploadingid[i]||(this.uploadingid[i]="temp",this.uploadingid[i]=this.showMessage("right",{type:6,msg:"uploading"})),s=(e.event.loaded/e.event.total*100).toFixed(2),this.uploadingid[i]&&"temp"!=this.uploadingid[i]&&this.view.audioProgress(this.uploadingid[i],s);else if("success"===e.status)var r=setInterval(function(){if(o.uploadingid[i]&&"temp"!=o.uploadingid[i]){clearInterval(r),n=e.event.target||e.event.currentTarget||e.event.srcElement,t.Log(n.responseText);try{a=t.JSON.parseJSON(n.responseText)}catch(t){}a.type=6,a.sourceurl=a.url,a.url=a.mp3,a.duration=a.length,delete a.mp3,o.view.updateMessage(o.uploadingid[i],6,a),t.Log("audioUpload:"+t.JSON.toJSONString(a),2),o.send(t.extend(a,{msg:a})),o.view.showAudioResult(o.uploadingid[i]),o.uploadingid[i]=""}},200);else"error"===e.status?o.view.showAudioResult(o.uploadingid[i]):t.Log(e,3)},_initChatConfig:function(){var e,i=this,s=[];if(t.isDefined(this.config.message_skin)&&("chat/2"==this.config.message_skin||""===this.config.message_skin||this.config.message_skin.indexOf("|")>-1))this.config.message_skin=this.config.message_skin?this.config.message_skin:"#2c2c2e|#474749",this.config.startColor=this.config.message_skin.substr(0,this.config.message_skin.indexOf("|")),this.config.endColor=this.config.message_skin.substr(this.config.message_skin.indexOf("|")+1);else{var n={"chat/1":"#4297e0","chat/3":"#575757","chat/4":"#f25488","chat/5":"#52ab52","chat/6":"#9bc942","chat/7":"#4297e0","chat/8":"#4297e0","chat/9":"#4297e0","chat/10":"#4297e0"};n[this.config.message_skin]?this.config.startColor=this.config.endColor=n[this.config.message_skin]:this.config.startColor=this.config.endColor=this.config.message_skin}this.config.chatBackground=t.isDefined(this.config.message_content_skin)?this.config.message_content_skin:"#FFFFFF",this.view.disableButton("face",0===this.config.enable_face),this.view.displayButton("face",0===this.config.enable_face),this.view.disableButton(["image","file"],0===this.config.transferfiles),0===this.config.transferfiles||t.browser.android&&0===this.config.androidtransf||t.browser.mobile&&!t.browser.android&&0===this.config.othertransf?this.view.displayButton(["image","file"],!0):this.view.displayButton(["image","file"],!1),t.browser.mobile&&(0===this.config.enable_audio||2==this.config.enable_audio&&t.browser.gecko)&&this.view.hideAudioButton(),this.view.disableButton("history",0===this.config.chatingrecord),this.view.displayButton("history",0===this.config.chatingrecord),this.view.disableButton("loadhistory",1!=this.config.viewchatrecord),this.view.displayButton("loadhistory",1!=this.config.viewchatrecord),this.view.disableButton("evaluate",0===this.config.evaluation),this.view.displayButton("evaluate",0===this.config.evaluation),this.view.disableButton(["capture","capoptions"],0===this.config.captureimage),this.view.displayButton(["capture","capoptions"],0===this.config.captureimage),this.view.disableButton("csr",1!=this.config.changecsr),this.view.displayButton("csr",1!=this.config.changecsr),this.view.displayButton("xiaonengver",0===this.config.xiaonengver),this.requestRobot&&0===this.config.robot_mode&&this.view.switchToolbar(!1);var a=!0;this.config.faces=this.config.faces||[],e={id:"-1",name:"",icon:"",pics:[]},t.each(t.lang.editorFaceAlt,function(i,s){a&&(e.icon=t.sourceURI+"images/faces/"+i+(t.browser.msie6?".gif":".png"),a=!1),e.pics.push({id:i,url:t.sourceURI+"images/faces/"+i+(t.browser.msie6?".gif":".png"),sourceurl:t.lang.editorFaceAlt[i]})}),this.config.faces.length&&"-1"==this.config.faces[0].id||this.config.faces.unshift(e),!this.config.rightlabel||t.isEmptyObject(this.config.rightlabel)?this.config.rightlabel=t.lang.rightlabel:this.config.rightlabel=t.merge({},this.config.rightlabel),t.each(this.config.rightlabel,function(e,n){switch(e){case"about":var a=i.config.introduction,o=/\[tab\s+(.*?)\](.*?)\[\/tab\]/gi;o.test(a)?(a=a.replace(o,"$1"),a=t.utils.handleLinks(a,{siteid:i.siteid,user_id:t.global.shortid,lang:t.language||"",itemid:i.itemid||"1111",erpparam:t.global.erpparam||"",itemparam:i.options.itemparam,sellerid:i.options.itemparam?"":i.options.sellerid}),s.push(t.extend(n,{data:a}))):a&&s.push(t.extend(n,{data:a}));break;case"faq":i.config.faqlist&&i.config.faqlist.length&&s.push(t.extend(n,{data:i.config.faqlist||[]}));break;case"linkinpage":s.push(n);default:var r=t.extend({},n);r.data=t.utils.handleLinks(n.data,{siteid:i.siteid,user_id:t.global.shortid,itemid:i.itemid||"1111",itemparam:i.options.itemparam}),r.data&&s.push(r)}}),this._moreData=s,this.manageMode.callConfigLoaded&&this.manageMode.callConfigLoaded(this.settingid,this.config,s),this.displayMoreData()},displayMoreData:function(){if(this.view.displayButton&&!t.browser.mobile)return this._moreData&&this._moreData.length&&!1!==t.global.pageinchat?("1"!=this.config.autoexpansion||this.getExpansionStatus()||(this.view.chatElement.find(".chat-view-exp")&&this.view.chatElement.find(".chat-view-exp").html(t.lang.button_more+" &lt;"),this.toggleExpansion(this.settingid)),!1):(this.view.displayButton("exp",!0),!0)},getCustomerServiceInfo:function(e,i,s){this.callTrack("10-01-05","start t2d connect");var n,a=this;this.callMethod=this.callMethod||window,this.callBack="callBack_chat_"+t.randomChar(),this.callMethod[this.callBack]=function(){"function"==typeof window.nTalk.fIM_getSessionCustomerServiceInfo?window.nTalk.fIM_getSessionCustomerServiceInfo.apply(a,arguments):window.nTalk.Log("nTalk.fIM_getSessionCustomerServiceInfo is undefined",3)},this.requestRobot?(this.dest.destid=this.robotID,n={status:1,userid:this.dest.destid,nickname:this.config.robot_name||t.lang.robot_name,usericon:this.config.robot_logo||"",signature:"",sessionid:""},this.callMethod[this.callBack](n,this.settingid)):this._getCustomerServiceForT2dStatus(e,i,s)},changeCustomerServiceInfo:function(){this.startCSSwitch="START",2==t.server.robot&&(this.t2dMode=0,this.lastSessionID=""),this.getCustomerServiceInfo(this.getDest(!0),0,this.getDest().id)},manualServiceInfo:function(){this.send(t.lang.button_switch_manual),this.view.disableButton("manual",!0)},_getCustomerServiceForT2dStatus:function(e,i,s){t.Log("chatMode._getCustomerServiceForT2dStatus("+e+", "+i+")",1);var n,a=this,o=t.base.checkID(e);if(this._connectTimeout)t.Log("Connect tchat...",2);else if(t.user.id&&t.global.pcid)if(!1===o||o!=t.CON_CUSTOMER_ID&&o!=t.CON_GROUP_ID)this.showMessage("system",{type:9,msg:t.lang.system_no_user});else{var r={};if(2==t.server.robot){var h=this.lastSessionID||this.sessionid?this.lastSessionID||this.sessionid:null,c=this.t2dMode,l=s||(this.dest&&this.dest.id&&0===t.base.checkID(this.dest.id)?this.dest.id:null);r={sid:h,trf:c,ruids:l=null===this.t2dMode?null:l}}n=t.toURI(t.extend({query:"requestchat",sitid:this.siteid,uid:t.user.id,uids:e,ruids:s,issingle:i,cid:t.global.pcid,type:t.global.isvip,userlevel:t.global.userlevel,usertag:t.global.usertag,userrank:t.global.userrank,callbackname:this.callBack},1==t.flashserver.reversechat?{}:{settingid:this.settingid},r),!0),this.view.displayStatusInfo&&"QUEUE"!==this.statusConnectT2D&&this.view.displayStatusInfo(!0,t.lang.system_allocation_service),t.Log("QueryString:"+n),t.Log(":::"+this.server.t2dstatus+"?"+n+"#rnd",1),this.statusConnectT2D="QUERY",t.require(this.server.t2dstatus+"?"+n+"#rnd",function(e){t.Log("request t2dstatus complete: error:"+(e.error||"")+", reconnect:"+a._reconnectCount+", statusConnectT2D:"+a.statusConnectT2D),(e.error||"QUERY"==a.statusConnectT2D)&&(a.callTrack("10-01-07","t2d abnormal"),a._reconnectCount++,a.statusConnectT2D="WAIT",a._reconnectCount<3?setTimeout(function(){a.reconnect()},1e3):(a._reconnectCount=0,a._failure("3TH_REQUEST"))),t(e.error?e.target:e).remove()})}},callBackCustomerServiceInfo:function(e){var i=this,n="";if(this.options.edu_invisitid&&t.isEdu&&3==e.status&&(e.status=1),1==this.options.config.leftchat&&0!=this.manageMode.chat.startType&&(n=this.options.config.announcement||t.lang.leftchat_message,this.showMessage("left",{type:1,msg:n})),t.Log(this.settingid+":chatMode.callBackCustomerServiceInfo("+t.JSON.toJSONString(e)+")",1),!e||e.error||3!=e.status&&(!e.userid||!e.externalname&&!e.nickname))return this.callTrack("10-01-07","result params abnormal"),"no free users"==e.error?n=t.lang.system_no_free_user:"over rechatnum"==e.error?(n=t.lang.system_over_rechatnum,this.view.disableButton("csr",!0)):"no user2"==e.error&&(n=t.lang.system_no_user),""!==n?(this.showMessage("system",{type:9,msg:n}),this.callStat("13"),this.statusConnectT2D="COMPLETE",this.view.displayStatusInfo&&this.view.displayStatusInfo(!1),this._stopQueue(),void(this.robotKf&&setTimeout(function(){i.t2dMode=null,i.reconnect(),t.Log("please set manual customer in robot setting group")},2e3))):(this._abnormal(e.error||""),this.startCSSwitch="",void(this.view.displayStatusInfo&&this.view.displayStatusInfo(!1)));if(this.callTrack("10-01-06","success"),"START"==this.startCSSwitch&&(this.startCSSwitch="SHOW"),this._clearChangeCsrNum(),this.sessionid=e.sessionid||"",t.Log("get sessioId>>"+this.sessionid,1),e.usericon="null"==e.usericon?"":e.usericon,e.usericon="null"==e.usericon?"":e.usericon,this.setDest({id:e.userid,name:e.externalname||e.nickname||"",sign:e.signature||"",logo:t.protocolFilter(e.usericon||""),status:e.status||0,phone:e.mobile||e.phone||""}),this.callMethod[this.callBack]=s,e.status===this.CON_OFFLINE?(this.statusConnectT2D="COMPLETE",this._offline()):e.status===this.CON_BUSY?(this.statusConnectT2D="QUEUE",this._queueNum=+e.num+1,this._busy()):(this.statusConnectT2D="COMPLETE",this._online()),2==t.server.robot&&1==e.usertype&&this.setRobot2Param(!0),0!==this.config.sessioncarry){var a={};window.localStorage.carry_dest?a=t.JSON.parseJSON(window.localStorage.carry_dest):a[this.settingid]=this.dest.id;var o={};for(k in a)k!==this.settingid&&(o[this.settingid]=this.dest.id);a=t.JSON.toJSONString(t.extend(a,o)),window.localStorage.carry_dest=a}this.config.enable_starLevel&&!i.getStarLevel&&(i.getStarLevel=!0,window.startLevel=function(e){try{t.evaluateStarLevel=5,e>=55&&e<=59?t.evaluateStarLevel=4:e<55&&(t.evaluateStarLevel=3)}catch(e){t.Log("startLevel.callback:"+e.message,3)}},startLevelData={siteid:i.dest.id.substr(0,i.dest.id.indexOf("_ISME")),kfid:i.dest.id,callback:"startLevel"},t.require(t.server.settingserver+"/index.php/api/setting/returnCount?"+t.toURI(startLevelData)+"#rnd",function(){i.view.starLevel&&i.view.starLevel(t.evaluateStarLevel)}))},setRobot2Param:function(t){t?(this.robotKf=!0,this.view.switchToolbar(!1),this.t2dMode=2):(this.robotKf=!1,this.view.switchToolbar(!0),this.t2dMode=null)},_abnormal:function(e){var i=t.utils.handleLinks(t.lang.system_abnormal,{settingid:this.settingid});this.callStat("13"),this.connected=!1,this._stopQueue(),this.showMessage("system",{type:9,msg:i}),t.Log("Customer information request an exception.("+e+")",3)},_failure:function(e){var i=t.utils.handleLinks(t.lang.system_failure,{settingid:this.settingid});this.view.displayStatusInfo&&this.view.displayStatusInfo(!1),this.connected=!1,this._stopQueue(),this.showMessage("system",{type:9,msg:i}),t.Log("Customer information request fails.("+e+")",3)},_offline:function(){var e=t.utils.handleLinks(t.lang.system_offline,{destname:this.dest.name,settingid:this.settingid});this.view.displayStatusInfo&&this.view.displayStatusInfo(!1),this.callStat("12"),this.connected=!1,this._stopQueue(),this.showMessage("system",{msg:e,type:9}),1==this.server.robot&&this.server.roboturl&&1==this.config.robot&&(parseFloat(this.config.robot_mode)>0||1==this.options.manual)?this.switchServerType(!1,"OFFLINE"):this.switchUI(this.CON_VIEW_MESSAGE,"OFFLINE")},_online:function(){var e=this;this.view.displayStatusInfo&&(this.view.displayStatusInfo(!1),t.browser.safari&&!navigator.cookieEnabled&&setTimeout(function(){e.view.displayStatusInfo(!0,t.lang.system_cookie,{"font-size":"12px","line-height":"27px",padding:"0 45px"},!0)},1e3)),this.callStat("10"),this._stopQueue(),t.Log("connect user "+this.dest.name+"...",1),this.createConnect()},_busy:function(){var e,i,s;if(this.connected=!1,this.view.displayStatusInfo&&this.view.displayStatusInfo(!1),this._startQueue)this.view.chatHistory.find(".chat-view-queue-num").html(this._queueNum.toString());else{if(1==this.server.robot&&this.server.roboturl&&1==this.config.robot&&2==parseFloat(this.config.robot_mode))return this.statusConnectT2D="COMPLETE",void this.switchServerType(!1,"BUSY");if(!0!==this._startQueue){this._startQueue=!0,this.callStat("11");var n=this;this.view.disableButton(["image","file","submit"],!0),this._queueTime=0,this._queueTimeID=setInterval(function(){n._queueTime%3==0&&n.getCustomerServiceInfo(n.options.destid,n.options.single,""),n._queueTime++,n.view.chatHistory.find(".chat-view-queue-time").html(t.secondsToMinutes(n._queueTime))},1e3)}if(!this.view.chatHistory.find(".chat-view-queue-num").length){i='<font class="chat-view-queue-num" style="'+t.STYLE_BODY+'color:red;font-weight:bold;">'+this._queueNum.toString()+"</font>",s="",toRobotMessage="";var a,o;t.browser.mobile?(a=t.lang.system_mobile_queue1||t.lang.system_queue1,o=t.lang.system_mobile_queue2||t.lang.system_queue2):(a=t.lang.system_queue1,o=t.lang.system_queue2),queue1message=t.utils.handleLinks(o,{settingid:this.settingid,count:i,time:s}),e=t.utils.handleLinks(a,{settingid:this.settingid,count:i,time:s,br:"",torobot:toRobotMessage}),1===this.config.disable_message?this.showMessage("system",{type:0,msg:queue1message}):this.showMessage("system",{type:0,msg:e}),this.view.changeQueueStyle()}}},_stopQueue:function(){this._startQueue=!1,clearInterval(this._queueTimeID),this.view.disableButton(["image","file","submit"],!1)},_ready:function(e,i){t.Log(this.settingid+"::chatMode._ready()",1),this.connect&&this.connect.stopSwitchConnect(),this.statusConnectTChat="READY","zh_cn"!==t.lang.language.toLowerCase()&&(this.debug&&t.Log(this.settingid+":chat.connect.setTextStyle"),this.connect&&this.connect.setTextStyle({fontsize:20})),this.callStat("4")},_connectSuccess:function(e){this.callTrack("10-01-02","connect success");var i,s=this,n=0;e&&(i="string"==typeof e?t.JSON.parseJSON(e):e,this.setUser({id:i.myuid||"",name:i.myuname||"",sign:i.signature||"",logo:t.protocolFilter(i.mylogo||"")}),this.sessionid=i.sessionid||"",this.sessionid&&this.callStat("0"),this.jetLag=t.getTime()-i.timesample,1==t.server.robot&&this.mergeSession(this.dest.id,this.sessionid,function(){t.Log("merge session")})),this._stopConnectTimeout(),this.statusConnectTChat="COMPLETE",t.Log("connect "+this.dest.name+" complete",1),"function"==typeof im_destUserInfo?im_destUserInfo({id:this.dest.id,name:this.dest.name}):t.browser.mobile&&t.postMessage(window.parent,["destInfo",this.dest.id,this.dest.name].join(","),"*"),t.browser.mobile&&this.manageMode&&t.isFunction(this.manageMode.view.updateViewStatus)&&this.manageMode.view.updateViewStatus(!1),this.view.removeMessage("system"),"SHOW"!=this.startCSSwitch||this.requestRobot||(this.userList=[],this.startCSSwitch="",this.showMessage("system",{type:9,msg:t.utils.handleLinks(t.lang.system_switch_session,{destname:this.dest.name})})),t.waitMessage.each(function(t,e){s.waitTimeID[s.waitTimeID.length]=setTimeout(function(){s.send(e)},n),n+=600}),this._sendGoodsinfo(),this.hashCache.each(function(t,e){s.cacheTimeID[s.cacheTimeID.length]=setTimeout(function(){s.send(e)},n),n+=600}),this.hashCache.clear(),this.view.disableButton("history",!1),this.requestRobot||1!=this.config.robot_inherits_state||(t.default_connect_robot=!1)},_connectException:function(){t.Log(this.settingid+":chatMode._connectException()"),this.connected=!1,this.statusConnectTChat="FAILURE",this.showMessage("system",{type:9,msg:t.utils.handleLinks(t.lang.system_connect_wait,{settingid:this.settingid})})},_connectResult:function(e,i,s){if(s=t.hexToDec(s),t.Log(this.settingid+":chatMode.connectResult("+t.JSON.toJSONString(arguments)+")"),this.connected&&e===this.CON_CLOSE_CONNECT)this.statusConnectTChat="CLOSECHAT";else switch(this.connected&&e===this.CON_DISCONNECT&&this.disconnect(),this.connected||e!==this.CON_LOGIN_SUCCESS||(this.connected=!0),e){case this.CON_LOGIN_SUCCESS:this.view.disableButton("capture",!1),this._connectSuccess(i);break;case this.CON_LOGIN_FAILURE:case this.CON_CONNECT_FAILURE:this.view.disableButton("capture",!0),this._connectException()}},mdyServerAddr:function(t){return t.replace(/\/flashgo/i,"/httpgo")},setFlashGoServer:function(e){var i;t.Log(this.settingid+':chatMode.setFlashGoServer("'+e+'")'),e&&(e=this.mdyServerAddr(e),i=/cid=(\-?\d+)/gi.exec(e),this.chatFlashGoUrl=t.protocolFilter(e),this.chatgourl=t.protocolFilter(e.substr(0,e.indexOf("?"))),this.clientid=i&&2==i.length?i[1]:"")},notifySessionSence:function(e){t.Log("chatMode.notifySessionSence("+e+")",1);try{e=t.JSON.parseJSON(e)}catch(t){}1===e.evaluable?this._Evaluable=!0:this._Evaluable=!1,1===e.enableevaluation?this._Enableevaluation=!0:this._Enableevaluation=!1,2==t.server.robot&&(0===e.scenemode?this.setRobot2Param(!1):1===e.scenemode&&this.setRobot2Param(!0)),t.browser.mobile&&this.view.displayEvClose(this._Enableevaluation?1:0),this.view.disableButton("evaluate",!this._Evaluable),-1==e.score?(this._submitRating=!1,this.showMessage("info",{type:9,msg:t.lang.system_evaluation_failure})):e.score>0&&(this._submitRating=!0)},notifyUserList:function(e){t.Log(this.settingid+":chatMode.notifyUserList("+e+")");try{e=t.JSON.parseJSON(e)}catch(t){e=[]}for(var i=[],s=0;s<e.length;s++)t.base.checkID(e[s].userid)===t.CON_CUSTOMER_ID&&(i.push(e[s]),this.addDestList({id:e[s].userid||"",name:e[s].externalname||e[s].nickname||e[s].username||"",logo:e[s].usericon||""}));this.userList=i,this.userNumber=this.userList.length,t.Log(this.settingid+":chatMode.notifyUserList:"+e.length),this.userNumber>1&&this.callStat("21")},userEnter:function(e){var i,s=t.lang.system_add_session,n=!0;try{i=t.JSON.parseJSON(e)}catch(t){i=null}if(t.base.checkID(i.userid)==t.CON_CUSTOMER_ID&&0!==this.userList.length){for(var a=0;a<this.userList.length;a++)this.userList[a].userid==i.userid&&(n=!1);n&&(this.userList.push(i),this.userNumber=this.userList.length),this.userList.length>1&&this._clearChangeCsrNum(),t.Log(this.settingid+":["+this.userList.length+"]chatMode.userEnter("+e+")"),this.addDestList({id:i.userid||i.id,name:i.externalname||i.nickname||i.username||i.name,logo:i.logo||""}),s&&this.userNumber>1&&(this.enterUserId=i.userid,this.showMessage("system",{type:9,msg:t.utils.handleLinks(s,{destname:i?i.externalname||i.nickname||"":this.dest.name}),enter:1}))}},userLeave:function(e){this.enterData=null,t.Log(this.settingid+":chatMode.userLeave("+e+")");var i=t.extend({},this.hashDest.items(e));if(i&&!t.isEmptyObject(i)){if(this.userList.length<2)return;for(var s=[],n=0;n<this.userList.length;n++)this.userList[n].userid!=e&&s.push(this.userList[n]);if(this.userList=s,this.userNumber=this.userList.length,!(s=this.userList[0]))return;this.setDest({id:s.userid||"",name:s.externalname||s.nickname||"",sign:s.signature||"",logo:t.protocolFilter(s.usericon||s.logo||""),status:s.status}),i.name&&i.id&&-1==i.id.indexOf("robot")&&this.showMessage("system",{type:9,msg:t.utils.handleLinks(t.lang.system_go_away_session,{destname:i.name}),enter:1})}else t.Log("chatMode.userLeave(): dest info is null",2)},_userInfo:function(e){var i;if("object"==typeof e)i=e;else try{i=t.JSON.parseJSON(e)}catch(t){return}if(i.status===this.CON_OFFLINE||i.status===this.CON_AWAY){if(1!=this.options.config.leftchat)return this.statusConnectTChat="CLOSECHAT",void this.disconnect();i.status=1}if(this.dest.id!=i.userid&&1!=i.status)return t.Log(">userid:"+this.dest.id+"!="+i.userid+" ,>"+(this.dest.id!=i.userid)+", "+i.status+"!=1>"+(1!=i.status),1),void t.Log("Switch to is not online customer service does not update the customer information ",2);this.setDest({id:i.userid||this.dest.id,name:i.externalname||i.nickname||this.dest.name,sign:i.signature||this.dest.sign,logo:t.protocolFilter(i.usericon||i.logo||this.dest.logo),phone:i.mobile||i.phone||"",status:i.status})},addDestList:function(e){var i,s,n,a;if(e&&!t.isEmptyObject(e)&&(e.id||e.userid))return s=e.userid||e.id,n=e.externalname||e.nickname||e.username||e.name,a=e.usericon||e.logo||"",t.Log("add or update dest info:"+t.JSON.toJSONString(e),2),this.hashDest.contains(s)?(i=t.extend({},this.hashDest.items(e.id),{id:s,name:n,logo:a}),this.hashDest.items(i.id,i)):(i={id:s,name:n,logo:a},this.hashDest.add(i.id,i)),i},getMsgId:function(e){for(e=e||t.getTime();this.hash.contains(e+"J");)e++;return parseFloat(e)+"J"},mergeSession:function(e,i,s){if(this.robotSessionID){var n=this,a={siteid:this.siteid,robotsessionid:this.robotSessionID,sessionid:i||this.sessionid,destid:e,myuid:t.user.id};new t.POST(this.server.mcenter+"/message.php?m=Message&a=updateRobotMsg",a,function(e){t.Log("send hidtory message complete"),setTimeout(function(){s.call(n)},50)})}},_clearChangeCsrNum:function(){this._changeCsrNum=0,this.view.disableButton("csr",!0)},_filterNullChar:function(e){var s=this;return t.each(e,function(n,a){t.isObject(a)||t.isArray(a)?e[n]=s._filterNullChar(a):e[n]="number"==typeof a?a:a.replace(i,"")}),e},_formatEvaluationData:function(e){var i="",s=t.getTime(),n={type:5,timerkeyid:s,msgid:this.getMsgId(s)};if(e=this._filterNullChar(e),2==this.config.evaluateVersion?n.msg=t.extend({msgtype:3},{newevaluate:e}):n.msg=t.extend({msgtype:3},{evaluate:e}),2==this.config.evaluateVersion){for(var a in e)if(e[a]&&e[a].answer){var o=e[a].answer;for(var r in o)o[r]&&o[r].lab&&(i+=o[r].lab+"; ")}}else for(var a in e)if(e[a]&&e[a].value&&!t.isFunction(e[a])&&e.hasOwnProperty(a)){if("evalute_start"==e[a].name)break;"string"==typeof e[a].value?i+=e[a].value+"; ":i+=e[a].value.text+"; "}return t.Log("submitData::"+t.JSON.toJSONString(n)),{data:this._toEvaluateXML(n),info:t.enCut(i,50)}},_toEvaluateXML:function(e){var i,s;e=t.charFilter(e),i=t.whereGet(e,["type","msgid"]);for(var n in i)void 0===i[n]&&delete i[n+""];return(s={flashuid:e.timerkeyid,msg:{msg:t.extend(e.msg,{attributes:i})}}).msg.msg.newevaluate&&(s.msg.msg.newevaluate=t.JSON.toJSONString(s.msg.msg.newevaluate)),s.msg.msg.evaluate&&(s.msg.msg.evaluate=t.JSON.toJSONString(s.msg.msg.evaluate)),s.msg=t.jsonToxml(s.msg),s}},t.chatManage={name:"chatManage",view:null,options:null,hash:new t.HASH,hashWait:new t.HASH,hashConfig:new t.HASH,hashStatus:new t.HASH,objMinView:null,cacheLeft:null,cacheTop:null,htmlSID:"",connectId:"",open:function(e,i,s,n,a,o,r,h,c,l){t.Log("$.chatManage.open("+t.JSON.toJSONString(arguments)+")");var u=this;if(t.xpush&&t.xpush.clearSettingUnReadMsgCount(e),this.htmlSID=t.getTime(2),this.settingid=e||i,this.destid=i||"",this.itemid=s,this.itemparam=n,this.sellerid=a,this.single=r||(this.destid?1:0),this.manual=h||"0",this.edu_visitid=l||"",this.edu_invisitid=c||"",this.clearHistoryPageCount(),this.view&&this.objMinView&&this.objMinView.remove(),this.createClientID(),this.hash.contains(this.settingid))this.hash.items(this.settingid)&&(t.Log("$.chatManage.switchChat("+this.settingid+")",1),this.chat=this.hash.items(this.settingid),this.get(this.settingid).connect&&this.get(this.settingid).connect.connect||this.get(this.settingid).reconnect("",this.destid,this.single,this.edu_invisitid,this.edu_visitid),this.chat.selected||t.isEdu&&t.browser.mobile||this.switchChat(this.settingid));else{if(this.hashWait.contains(this.settingid))return void t.Log("wait open chat",2);this.hashWait.add(this.settingid,"wait"),t.base.showLoading(),this.loadConfig(e||t.global.settingid,function(e){t.browser.mobile?u.loadWapView(e,function(){u.initChatManage(o,e)}):u.initChatManage(o,e)},this.settingid)}return!0},loadWapView:function(e,i){var s="chat.view.wap.js";!t.flashserver.layout||"2"!=t.flashserver.layout&&"3"!=t.flashserver.layout||t.isEdu||(s="chat.view.wap.theme"+t.flashserver.layout+".js"+t.baseExt),t.require({view:s+t.baseExt},function(){i.call()})},createClientID:function(){var e=t.randomChar(20);return this.connectId=""!==this.connectId?this.connectId:"JS_"+e.toLowerCase(),this.connectId},initChatManage:function(e,i){var s,n,a=this,o={};this.view||("kf_9740"==t.global.siteid?o.position={position:"center-center"}:o.position=i?i.position:{},i&&void 0!==typeof i.resize_chat&&void 0!==typeof i.drag_chat?(o.resize=!(!t.global.pageinchat||!i||0===i.resize_chat),o.drag=!(!t.global.pageinchat||!i||0===i.drag_chat)):(o.resize=!1,o.drag=!0),n=t.ntView?t.ntView.chatManageView:t.chatManageView,t.ntView&&t.browser.mobile?this.view=new n(o,this,i.wapTheme):this.view=new n(o,this),t(window).bind("beforeunload",function(t){a.beforeunload(t)})),t.global.pageinchat||(t.Capture.captureWithMin=!1),this.view.addChatTag(this.settingid),t.browser.mobile||this.hash.each(function(t,e){e&&e.minimize()}),i&&1==i.autoconnect||"1"==t.server.reversechat?(t.Log("autoconnect:1"),e=!0):i&&-1==i.autoconnect?e=!1:(s=t.store.get(t.base.CON_LOCAL_FIX+this.settingid))&&t.getTime()-s<18e5&&(e=!0);try{i=t.protocolFilter(i)}catch(e){t.Log("error config file: "+e)}this.chat=this.createChatMode(e,i),t.browser.mobile&&0==t(".chat-view-window-header").length&&this.view._create(),this.hash.add(this.settingid,this.chat),"1"!==t.global.message?(!e&&!this.chat.requestRobot||this.chat.connected||this.chat.start(),t.store.set(t.base.CON_LOCAL_FIX+this.settingid,t.getTime())):this.chat.switchUI("message")},beforeunload:function(e){if(0!==this.hash.count()){if(this.chat.connected&&this.chat._sendNum>0&&0!==this.chat.config.sessioncarry){var i=t.JSON.parseJSON(window.localStorage.carry_dest),s={};for(k in i)k!==this.chat.settingid&&(s[this.chat.settingid]=this.chat.dest.id);i=t.JSON.toJSONString(t.extend(i,s)),window.localStorage.carry_dest=i}else window.localStorage.carry_dest="";if(!t.global.pageinchat&&!t.browser.mobile)if(this.chat&&this.chat.config&&1==this.chat.config.enableevaluation&&this.chat._Evaluable&&!this.chat._submitRating){if(this.close(),t.browser.chrome)return t.lang.system_before_evaluation;t.Event.fixEvent(e).returnValue=t.lang.system_before_evaluation}else setTimeout(function(){},500)}},loadConfig:function(e,i,s){var n,a=this,o=this.hashConfig.items(e);url=[t.server.configserver?t.server.configserver:t.server.flashserver,"config/6/",e.split("_").slice(0,2).join("_"),"_",e,".js#rnd"].join(""),t.Log("$.chatManage.loadConfig("+e+"):"+url),o||t.isEmptyObject(t.base.config)||t.base.config.settingid!=e||(o=o||t.base.config),o&&o.service&&o.service.tchatgoserver?(t.base.hiddenLoading(),s&&s.indexOf("ISME9754")>-1?a.hashWait.remove(s):a.hashWait.remove(e),(n=a.verificationDestId(o))?(t.Log("Only one customer to open a chat window",2),n.showMessage("system0",{type:9,msg:t.utils.handleLinks(t.lang.system_merge_session,{destname:n.dest.name})})):i.call(this,o)):t.require(url,function(r){t.base.hiddenLoading(),s&&s.indexOf("ISME9754")>-1?a.hashWait.remove(s):a.hashWait.remove(e),r.error||!nTalk.CONFIG&&!NTKF.CONFIG?(a.view&&a.view.toggleExpansion("rightElement",!1),i.call(a,null)):(o=nTalk.CONFIG||NTKF.CONFIG,a.hashConfig.add(e,o),(n=a.verificationDestId(o))?(t.Log("Only one customer to open a chat window",2),n.showMessage("system0",{type:9,msg:t.utils.handleLinks(t.lang.system_merge_session,{destname:n.dest.name})})):i.call(a,o)),setTimeout(function(){delete NTKF.CONFIG,delete nTalk.CONFIG},1e3),t(r.error?r.target:r).remove()})},verificationDestId:function(e){var i,s,n=!1;return!!e&&((s=e.icon||e.list||e.toolbar||e.featureset||null)&&s.members.groupID&&s.members.idList.length?(i=s.members?s.members.idList:[],!!t.isArray(i)&&(this.hash.each(function(s,a){t.inArray(a.dest.id,i)>-1&&a.settingid!=e.settingid?(t.Log("opened destid:"+a.dest.id+", idList:"+t.JSON.toJSONString(i),2),n=a):t.Log("opened destid:"+a.dest.id+", idList:"+t.JSON.toJSONString(i),1)}),n)):(t.Log("No valid entry configuration",3),!1))},createChatMode:function(e,i){return t.Log("nTalk.chatManage.createChatMode():noWaitConnect:"+e,1),new t.chatMode({config:i,siteid:t.global.siteid,settingid:this.settingid,destid:this.destid,itemid:this.itemid,itemparam:this.itemparam,sellerid:this.sellerid,single:this.single,manual:this.manual,htmlsid:this.htmlSID,connectid:this.connectId,edu_invisitid:this.edu_invisitid,edu_visitid:this.edu_visitid,usertag:t.global.usertag,userrank:t.global.userrank},this)},get:function(e,i){if(!this.hash.count())return null;if(!e)return this.chat||this.hash.first();if(this.hash.contains(e))return this.hash.items(e);if(i&&t.base.checkID(i)==t.CON_CUSTOMER_ID)for(var s in this.hash.hashTable){var n=this.hash.items(s);s&&this.hash.hashTable.hasOwnProperty(s)&&n.dest.id==i&&(e=n.settingid)}return this.hash.contains(e)?this.hash.items(e):null},close:function(){t.Log("nTalk.chatManage.close()");var e=this.settingid,i=this,s=function(){(!t.global.callStatCount||t.global.callStatCount&&0==t.global.callStatCount.success&&1==t.global.callStatCount.failure)&&t.chatManage.get().callStat("5"),t.removelistenerMessage(),i.hash.each(function(t,e){e.close()}),i.hash.clear(),t.global.pageinchat?(i.view.close(),i.view=null):t.browser.mobile?t.global.backURL?window.open(t.global.backURL):history.go(-1):(window.opener=null,t.browser.chrome||window.open("","_self"),window.close()||(window.location.href="about:blank"))};if(this.chat&&this.chat.config&&!this.chat._submitRating&&this.chat._currentView==this.chat.CON_VIEW_WINDOW&&1==this.chat.config.enableevaluation&&this.chat._Enableevaluation){if(!1===this.chat.showEvaluation(2,"",function(){s(),t.base.fire("CloseChatWindow",[{type:2,settingid:e||""}])}))try{s(),t.base.fire("CloseChatWindow",[{type:1,settingid:e||""}])}catch(e){t.Log(e,3)}}else try{s(),t.base.fire("CloseChatWindow",[{type:1,settingid:e||""}])}catch(e){t.Log(e,3)}},switchChat:function(e){t.Log("chatManage.switchChat("+e+")"),this.view.switchChatTag(e),this.callSwitchChat(e)},closeChat:function(e){var i=this.hash.next(e);t.Log("chatManage.closeChat()"),this.view.removeChatTag(e),this.switchChat(i),this.hash.items(e)&&this.hash.items(e).close(),this.hash.remove(e)},callVerification:function(e,i){var s;return t.Log("chatManage._callStart("+e+", [config Object])"),!!(s=this.verificationDestId(i))&&(this.closeChat(e),s)},callManageResize:function(t,e){this.hash.each(function(i,s){s.view.callChatResize(t,e)})},callMinimize:function(){t.Log("$.chatManage.callMinimize()");var e,i=this;e=t.ntView?t.ntView.minimizeView:t.minimizeView,this.objMinView=new e(this.chat.dest,this.chat._currentView==this.chat.CON_VIEW_MESSAGE,function(){t.isFunction(i.view.maximize)&&i.view.maximize(),i.objMinView=null})},callSwitchChat:function(e){var i=this;t.Log("chatManage.callSwitchChat("+e+")"),this.hash.each(function(t,s){s.settingid===e?(s.maximize(),s.displayMoreData()&&i.view.toggleExpansion("rightElement",!1),i.view.updateRightData(s.settingid,s._moreData),i.chat=s):s.minimize()})},callToggleExpansion:function(t){var e=this.view.toggleExpansion("rightElement");return this.hash.each(function(t,i){i.view.updateMore(e)}),e},callToggleExpansionTab:function(){return this.view.toggleExpansion("leftElement")},callConfigLoaded:function(t,e,i,s,n){this.view.updataSkin(e.chatBackground,e.startColor,e.endColor),i&&i.length&&this.view.updateRightData(t,i)},showFAQ:function(e,i,s,n){var a=this.hash.items(e);t.Log("chatManage.showFAQ()"),this.get().config.count_for_faq&&1==this.get().config.count_for_faq&&this.requestForCount(n),a.showMessage("otherinfo",{userid:a.dest.id,type:9,title:i,msg:s})},requestForCount:function(e){var i,s,n,a=t.getTime();s="ntcount_for_faq_"+t.randomChar(),t.server.kpiserver=t.protocolFilter(t.server.kpiserver),i="/"===t.server.kpiserver.charAt(t.server.kpiserver.length-1)?t.server.kpiserver+"index.php/api/comment/faq?":t.server.kpiserver+"/index.php/api/comment/faq?",n=t.toURI({siteid:this.chat.siteid,timesample:a,faqid:e,kfid:this.get().dest.id,settingid:this.chat.settingid,vid:t.global.uid||"notloggedin",time:a,sessionid:this.chat.sessionid,callback:s}),window[s]=function(e){t.Log("receive respones from kpiserver for count_for_faq"),"1000"==e.issuccess?t.Log("count_for_faq success . code :"+e.errormsg):t.Log("count_for_faq failure . errorCode :"+e.errormsg,2)},t.require(i+n+"#rnd")},callSetDest:function(t,e){this.view&&this.view.updateChatTag(t,e),this.eduWapAutoView&&this.eduWapAutoView.update(t,e),this.objMinView&&this.objMinView[0===e.status?"offline":"online"]()},callSetDestStatus:function(t,e,i){this.view&&this.view.updateChatTag(t,e,i)},callReceive:function(e){t.Log("$.chatManage.callReceive()"),this.hash.items(e).selected||this.view.labelFlicker(e),this.objMinView&&(this.objMinView.count++,this.objMinView.startFlicker())},getHistoryPageCount:function(){return t.browser.mobile?t.store.get("history")||-1:-1},clearHistoryPageCount:function(){return t.store.remove("history")},addHistoryPageCount:function(){if(!t.browser.mobile)return-1;var e=t.store.get("history")||"-1";return e=parseFloat(e)-1,t.store.set("history",e),e}},t.extend({fIM_getSessionCustomerServiceInfo:function(e,i){var s,n,a=t.chatManage.get(i);if(a){if(t.isObject(e))s=e;else try{s=t.JSON.parseJSON(e.replace(/[\r|\n]/gi,""))}catch(t){}if(1==this.options.config.leftchat)switch(s.status){case 0:this.manageMode.chat.startType=4,s.status=1;break;case 1:this.manageMode.chat.startType=0,s.status=1;break;case 3:this.manageMode.chat.startType=3,s.status=1;break;case 4:this.manageMode.chat.startType=4,s.status=1}return a.callBackCustomerServiceInfo(s),n={id:s.userid,name:s.externalname||s.nickname||"",logo:s.usericon||"",status:void 0==s.status?"":s.status,type:void 0==s.usertype?"":s.usertype},t.base.fire("DistributionService",[n]),!0}}}),t.extend({fIM_tchatFlashReady:function(e,i,s){return setTimeout(function(){var n=t.chatManage.get(s);n?n._ready(e,i):t.Log("fIM_tchatFlashReady:settingid:"+s,3)},0),!0},fIM_ConnectResult:function(e,i,s,n){return t.Log("nTalk.fIM_ConnectResult("+e+', userinfo, "'+s+'", "'+n+'")',1),setTimeout(function(){var a=t.chatManage.get(n);a&&a._connectResult(e,i,s)},0),!0},fIM_onGetUserStatus:function(e,i){return t.Log("nTalk.fIM_onGetUserStatus("+e+', "'+i+'")',2),!0},fIM_requestEvaluate:function(e,i,s,n){return t.Log("nTalk.fIM_requestEvaluate("+t.JSON.toJSONString(arguments)+")"),setTimeout(function(){var e=t.chatManage.get(n);e?e.showEvaluation(0,s):t.Log("fIM_requestEvaluate:settingid:"+n,3)},0),!0},fIM_notifyUserInputing:function(e,i){return setTimeout(function(){var s=t.chatManage.get(i);s?s.showInputState(e):t.Log("fIM_notifyUserInputing:settingid:"+i,3)},0),!0},fIM_receiveCustomerServiceInfo:function(e,i){t.Log('nTalk.fIM_receiveCustomerServiceInfo("'+e+'", "'+i+'")')},fIM_onNotifySessionSence:function(e,i){return setTimeout(function(){var s=t.chatManage.get(i);s&&s.notifySessionSence(e)},0),!0},fIM_notifyUserNumbers:function(e,i){setTimeout(function(){t.chatManage.get(i)},0)},fIM_notifyUserList:function(e,i){return setTimeout(function(){var s=t.chatManage.get(i);s&&s.notifyUserList(e)},0),!0},fIM_onGetUserInfo:function(e,i){return t.Log("nTalk.fIM_onGetUserInfo("+t.JSON.toJSONString(e)+", "+i+")",1),setTimeout(function(){var s=t.chatManage.get(i);s&&s._userInfo(e)},0),!0},fIM_notifyUserEnter:function(e,i,s,n){return t.Log("nTalk.fIM_notifyUserEnter("+e+", "+i+")"),setTimeout(function(){var e=t.chatManage.get(n);e&&(e.userEnter(i),e._userInfo(i))},0),!0},fIM_notifyUserLeave:function(e,i){return setTimeout(function(){var s=t.chatManage.get(i);s&&s.userLeave(e)},0),!0},fIM_receiveMessage:function(e,i){setTimeout(function(){var s=t.chatManage.get(i);s&&s.receive(e)},0)},fIM_eduWapReceiveMessage:function(e,i){setTimeout(function(){var s=t.chatManage.get(i);s&&s.eduWapAutoView&&s.eduWapAutoView.showMessage(e)},0)},fIM_suggestMessage:function(e,i){setTimeout(function(){var s=t.chatManage.get(i);s&&s.suggest(e)},0)},fIM_onGetFlashServer:function(t,e,i,s,n,a,o){},fIM_setTChatGoServer:function(e,i){t.Log("nTalk.fIM_setTChatGoServer("+e+")"),setTimeout(function(){var s=t.chatManage.get(i);s&&s.setFlashGoServer(e)},0)},fIM_updateUserNumber:function(){},fIM_callStat:function(e,i,s){t.global&&!t.global.callStatCount&&(t.global.callStatCount=new Object,t.global.callStatCount.success=0,t.global.callStatCount.failure=0),"mqtt"==e&&"success"==s&&0==t.global.callStatCount.success?(t.chatManage.get(i).callStat("16"),t.global.callStatCount.success=1):"mqtt"==e&&"failure"==s&&0==t.global.callStatCount.failure?(t.chatManage.get(i).callStat("17"),t.global.callStatCount.failure=1):"flash"==e&&"success"==s&&0==t.global.callStatCount.success?(t.chatManage.get(i).callStat("14"),t.global.callStatCount.success=1):"flash"==e&&"failure"==s&&0==t.global.callStatCount.failure?(t.chatManage.get(i).callStat("15"),t.global.callStatCount.failure=1):t.log("fIM_callStat: error;")}}),t.extend({fIM_uploadFlashReady:function(e,i,s){return setTimeout(function(){var e=t.chatManage.get(s);e?e._uploadReady(i):t.Log("nTalk.uploadFlashReady()",3)},0),!0},fIM_startSendFile:function(e,i,s,n){var a=t.chatManage.get(n);return t.Log("nTalk.fIM_startSendFile("+i+","+s+", "+n+")"),setTimeout(function(){a.startUpload(i,s)},0),!0},fIM_receiveUploadSuccess:function(e,i,s,n){var a=t.chatManage.get(n);t.Log("nTalk.fIM_receiveUploadSuccess("+t.JSON.toJSONString(arguments)+")"),setTimeout(function(){a.uploadSuccess(i,s)},0)},fIM_receiveUploadFailure:function(e,i,s,n){var a=t.chatManage.get(n);t.Log("nTalk.fIM_receiveUploadFailure("+t.JSON.toJSONString(arguments)+")"),setTimeout(function(){a.uploadFailure(i,s)},0)},fIM_receiveUploadProgress:function(e,i,s,n){var a=t.chatManage.get(n);return setTimeout(function(){a.uploadProgress(i,s)},0),!0}}),t.extend({clearSessionCache:function(){var e,i=this;if(t.base&&t.base.clearChatCache){try{e=t.store.getAll()}catch(e){t.Log("$.store:"+typeof t.store,3)}e&&(t.each(e,function(e){e.toString().indexOf(t.base.CON_LOCAL_FIX)>-1&&i.store.remove(e)}),t.Log("clear chat cache"))}else t.Log("no clear chat cache")},sendErpNews:function(){var e="",i="",s="",n="";t.global.trailGetRegion&&(t.global.trailGetRegion.ip&&(e=t.global.trailGetRegion.ip),t.global.trailGetRegion.country&&(i=t.global.trailGetRegion.country),t.global.trailGetRegion.province&&(s=t.global.trailGetRegion.province),t.global.trailGetRegion.city&&(n=t.global.trailGetRegion.city)),t.waitMessage.verificationAdd(t.getTime(1),{type:5,msg:{msgtype:7,param:t.global.erpparam+"|lang="+(t.global.lang||t.language)+'|{"ip":"'+e+'","country":"'+i+'","province":"'+s+'","city":"'+n+'"}'}})},chatReady:function(){var e=this;this.trailGetRegionCount=0,t.waitMessage||(t.waitMessage=new t.HASH,t.waitMessage.verificationAdd=function(t,e){var i=!1;this.each(function(t,s){s.type==e.type&&s.msg.msgtype==e.msg.msgtype&&(i=!0)}),i||this.add(t,e)}),t.waitMessage.verificationAdd(t.getTime(1),{type:5,msg:{msgtype:2,parentpagetitle:(t.global.title||t.title).toString().substr(0,32),parentpageurl:t.global.source||t.source,userlevel:t.global.isvip,sences:""}}),t.global.trailGetRegion&&t.global.trailGetRegion.success&&1==t.global.trailGetRegion.success?this.sendErpNews():this.trailGetRegionTimer=setInterval(function(){e.trailGetRegionCount++,(t.global.trailGetRegion&&1==t.global.trailGetRegion.success||e.trailGetRegionCount>=4)&&(e.sendErpNews(),clearInterval(e.trailGetRegionTimer),e.trailGetRegionCount=0)},500),t.Log("$.chatReady():: $.waitMessage.count():"+t.waitMessage.count(),1),!t.themesURI&&t.browser.mobile?(t.imageicon=t.sourceURI+"images/mobileicon.png",t.rengong=t.sourceURI+"images/rengong.png"):t.themesURI||(t.imageicon=t.sourceURI+"images/chaticon."+(t.browser.msie6?"gif":"png"),t.imagebg=t.sourceURI+"images/chatbg.gif"),t.imagesingle=t.sourceURI+"images/single.png",t.imagemultiplayer=t.sourceURI+"images/multiplayer.png",t.button=t.sourceURI+"images/button.png",t.button2=t.sourceURI+"images/button2.png",t.require([t.imageicon],function(e){e.error&&t.Log("cache chat icon failure",3)}),t.clearSessionCache()}}),t.chatReady()}(nTalk);